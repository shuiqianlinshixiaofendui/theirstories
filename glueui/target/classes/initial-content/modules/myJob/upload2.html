<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>创建渲染任务</title>
		<link rel="stylesheet" type="text/css" href="/libs/dijit/themes/claro/claro.css"  media="screen">
		<link rel="stylesheet" type="text/css"href="css/Main.css"/>
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen" />
		<script type="text/javascript" src="/script/spolo/ui/noty/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/jquery.noty.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/layouts/topCenter.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/themes/default.js"></script>
		<script>
			dojoConfig = {
				parseOnLoad: true,
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script> 
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
	</head>
	<body  class="claro">
		<div class="header" id="userInfo"></div>
		<div class="panel1">
			<div class="MainWrap" id="BaseOptions_Panel">
				<div class="title">基础选项</div>
				<div class="item" id="uploadFile_view">
					<form id="newJobForm" method="POST" enctype="multipart/form-data">
						<div class="title">请选择上传的文件:</div>
						<input type="file" id="newJobFile" name="newSceneFile"  class="fileInput" style="width:200px;"/>
					</form>
				</div>
				<div class="item" id="camera_view1" style = "display : none; ">
					<div class="title">选择要渲染的摄像机:</div>
					<div id = "cameraList" class="cameralist" style="width:200px;">
					</div>
				</div>
				<div class="item" id="camera_view2">
					<div class="title">填写要渲染的摄像机:</div>
					<input type="text" placeholder="多camera使用“,”隔开" id="cameraList2" style="width:200px;" />
				</div>
				<div class="item">
					<div class="title">选择渲染质量:</div>
					<select style="width:200px;" id="quality">
						<option value="0" selected="selected">小样</option>
						<option value="1" >高清</option>
						<option value="-1">自定义</option>
					</select>
				</div>
				<div class="item" id="download_view">
					<div class="title">选择渲染方式:</div>
					<select style="width:200px;" id="cloudrender">
						<option value="cloudrender">云渲染</option>
						<option value="download">本地渲染</option>
					</select>
				</div>
				<div class="showAdvancedOptions_button">
					<input type="checkbox" id="showAdvancedOptions_button"><font size="1px">显示高级选项</font></input>
				</div>
			</div>
			<div class="MainWrap2" id="AdvancedOptions_Panel" style = "display : none; ">
				<div class="title">高级选项(选填)</div>
				<div class="item">
					<div class="title">邮箱地址:</div>
					<input type="email" id="email" placeholder="me@example.com" style="width:200px;"/>
				</div>
				<div class="item">
					<div class="title">渲染任务名称:</div>
					<input type="text" id="userDefinedJobName" placeholder="例如:厨房" style="width:200px;"/>
				</div>
				<div class="item">
					<div class="title">客户名称:</div>
					<input type="text" id="customerName" placeholder="填写用户名称" style="width:200px;"/>
				</div>
				<div class="item">
					<div class="title">渲染尺寸预设值:</div>
					<select style="width:200px;" id="renderSize">
						<option value="250x150" selected="selected">250 x 150 (小样值)</option>
						<option value="1200x900">1200 x 900 (高清值)</option>
						<option value="320x240">320 x 240 (4:3 约0.01MB)</option>
						<option value="640x480">640 x 480 (4:3 约0.3MB)</option>
						<option value="832x608">832 x 608 (4:3 约0.5MB)</option> 
						<option value="1024x768">1024 x 768 (4:3 约0.8MB)</option> 
						<option value="1280x960">1280 x 960 (4:3 约1.3MB)</option> 
						<option value="1280x1024">1280 x 1024 (5:4 约1.3MB)</option> 
						<option value="1600x1200">1600 x 1200 (4:3 约2MB)</option> 
						<option value="1920x1440">1920 x 1440 (4:3 约4MB)</option> 
						<option value="1280x800">1280 x 800 (16:10 约1.2MB)</option> 
						<option value="1440x900">1440 x 900 (16:10 约2MB)</option> 
						<option value="1680x1050">1680 x 1050 (16:10 约3MB)</option> 
						<option value="1920x1200">1920 x 1200 (16:10 约4MB)</option> 
						<option value="100x100">100 x 100 (1:1)</option> 
						<option value="128x128">128 x 128 (1:1)</option> 
						<option value="200x200">200 x 200 (1:1)</option> 
						<option value="256x256">256 x 256 (1:1)</option> 
						<option value="320x320">320 x 320 (1:1)</option> 
						<option value="400x400 ">400 x 400 (1:1)</option> 
						<option value="512x512 ">512 x 512 (1:1)</option> 
						<option value="640x640">640 x 640 (1:1)</option> 
						<option value="720x720">720 x 720 (1:1)</option> 
						<option value="1024x1024">1024 x 1024 (1:1)</option> 
						<option value="-1">自定义</option> 
					</select>
				</div>	
				<div class="item" id="userRenderSize" style = "display : none; ">
					<div class="title">自定义渲染尺寸:</div>
					<input type="text" id="render_W" placeholder="宽度" style="width:80px;"/>
					X
					<input type="text" id="render_H" placeholder="高度" style="width:80px;"/>
					<input type="checkbox" id="lockScale" value="1"><font size="1px">锁定比例</font></input>
				</div>
				<div class="item">
					<div class="title">采样率:</div>
					<select style="width:200px;" id="SamplingRate">
						<option value="1000" selected="selected">1000</option>
						<option value="3000">3000</option>
						<option value="6000">6000</option> 
						<option value="10000">10000</option> 
					</select>
				</div>
				<div class="item">
				
				</div>
			</div>
		</div>
		<div class="footer">
			<input type="button" id="_submit" class="submitButton" value="提&nbsp;&nbsp;交" />
			<input type="button" id="cancel" class="submitButton" value="取&nbsp;&nbsp;消" />	
		</div>
		<script>	
		
		/**检测email地址格式是否正确
		*@param str 邮箱
		*/
		function checkemail(str){   
			var sReg = /[_a-zA-Z\d\-\.]+@[_a-zA-Z\d\-]+(\.[_a-zA-Z\d\-]+)+$/;   
			if(!sReg.test(str)){   
				return false;   
			}   
			return  true;   
		}
		function GuitlCloseWindow(){
			var url = "http://127.0.0.1:10828/closewindow?isClose=true"
			Spolo.scriptCrossDomain(url,function(msg){console.log(msg)});
		};
		function getDefaultMsg(){
				require([
					"widgets/Mask/Mask",
				    "dojo/dom",
					"dojo/on",
					"spolo/data/user",
					"dojo/ready"
					],
				function(mask,dom,on,User,ready){
					//设置用户邮箱地址
					var userEmail = Spolo.decodeUname( Spolo.getUserId() );
					if(!userEmail || userEmail=="nonymous"){
						alert("该功能需要登录后才能使用");
						window.location.href="/modules/user/index.html?redirect=/modules/myJob/upload2.html";
					}
					dom.byId("email").value = userEmail;
					//设置显示用户名称
					dom.byId("userInfo").innerHTML = "当前登录用户:"+userEmail;
					/** 从 gutil 层获取场景的URL*/
					function getSceneInfo(callback)
					{			
						var url = "http://127.0.0.1:10828/fillsetting"
						Spolo.scriptCrossDomain(url, callback);
					}	
					var isGutil = Spolo.getUrlVars().isGutil == "true";
					if(isGutil){
						//转换显示的div
						dom.byId("camera_view1").style.display='block';
						dom.byId("camera_view2").style.display='none';
						dom.byId("uploadFile_view").style.display='none';
						dom.byId("download_view").style.display='none';
					}
					getSceneInfo(
						function(Msg)
						{
							var url , fileInputId;
							if(Msg)
							{	
									//设置摄像机列表
									var cameraList_obj = document.getElementById("cameraList");
									cameraList_obj.style.display = "block";
									for(var j = 0; j < Msg.cameras.length; j++)
									{
										var camera_name = Msg.cameras[j].name;
										cameraList_obj.innerHTML += "<input checked='true' type ='checkbox' name = \"" + camera_name + "\" >"
										+ camera_name + "</input><br>";
									}
									var queryString = Spolo.encodeQueryData({"finputid" : "newJobFile"});					
									var url = "http://127.0.0.1:10828/savesetting?"+queryString;						
									Spolo.scriptCrossDomain(url, function(){});	
							}
						}
					);
					var JobManager = null;
					var callback_jobmanager = function(jobManager){
						JobManager = jobManager;			
						on(dom.byId("_submit"),"click",function(){
							var allParamsOK = true;
							//获取摄像机
							var cameras_list;
							if(isGutil){
								cameras_list = getCameraList();
								if(!cameras_list.length){
									allParamsOK = false;
									alert("请选择摄像机！ ");
								}
							}else{
								cameras_list = dom.byId("cameraList2").value;
							}
							//获取渲染任务名称
							var userDefinedJobName = dom.byId("userDefinedJobName").value;
							//获取客户名称
							var customerName = dom.byId("customerName").value;
							//获取渲染尺寸
							var renderSize = dom.byId("renderSize").value;
							if(renderSize=="-1"){
								var width = dom.byId("render_W").value;
								var height = dom.byId("render_H").value;
								if(!width || !height){
									allParamsOK = false;
									alert("自定义宽高，请填写宽高值");
								}else{
									renderSize = width+"x"+height;
								}
							}
							//获取采样率
							var SamplingRate = dom.byId("SamplingRate").value;

							//判断cloudrender参数
							var cloudrender = dom.byId("cloudrender").value;
							if(!isGutil){
								if(cloudrender == "cloudrender"){
									cloudrender = true;
								}else{
									cloudrender = false;
								}
							}else{
								cloudrender = true;
							}
							//获取email参数
							var email = dom.byId("email").value;
							if(cloudrender){
								if(!checkemail(email)){
									allParamsOK = false;
									alert("请填写正确的邮箱地址");
								}
							}
							if(allParamsOK){
								//通过jobManager来创建一个任务,上传成功之后跳转到场景列表页面
								try{
									var success;
									if(isGutil){
										success = function(job){
											console.log(job);
											mask.message("处理完成！",true);
											mask.hide();
											dojo.require("dijit.Dialog");
											myDialog = new dijit.Dialog({
												title: "页面关闭提示",
												content: "<div style='padding: 10px;background:#fff;'><div style='padding: 10px;'>您的任务已经提交完成</div><button id='closeButton_cancel' style='float:right;margin-bottom: 10px;'>关闭页面</button></div>"
											});	
											myDialog.own(on(dom.byId("closeButton_cancel"),"click",function(){
												myDialog.destroy();
												GuitlCloseWindow();
											}));
											myDialog.show();
										};
									}else{
										success =  function(job){console.log(job);mask.message("处理完成！",true);};
									}	
									args = { 
										jobInfo :{
											notifyEmail:email,
											cameraName:cameras_list,
											resolution:renderSize,
											samples:SamplingRate,
											userJobName:userDefinedJobName,
											customerName:customerName
											},
										success : success,
										failed : function(error){mask.appendLogItem(error);mask.message("处理失败！",false);},
										uploading : function(){mask.show();}			
									};
									//过滤无效的值
									for(var key in args.jobInfo){
										if(!args.jobInfo[key]){
											delete args.jobInfo[key];
										}
									}
									JobManager.createJobWithJson('newJobForm',args,true,cloudrender);
								}catch(e){
									console.log(e);
								}
							}
						});
					};						
					ready(function(){
						dojo.require("spolo.data.user");
						var path = "/content/users/"+Spolo.getUserId();
						var user = spolo.data.user.getInstance(path);				
						var map = {};							
						map.finputid="newJobFile";
						user.getJobManager('render',callback_jobmanager,false);					
					});
					
					// 返回摄像机列表
					function getCameraList()
					{
						var cameraList_obj = document.getElementById("cameraList");
						var cameras_list = [];
						for(var i in cameraList_obj.childNodes)
						{
							if((cameraList_obj.childNodes[i].nodeName == "INPUT")
								&& cameraList_obj.childNodes[i].checked)
							{
								var name = cameraList_obj.childNodes[i]["name"];
								cameras_list.push(name);
							}
						}
						return cameras_list;
					}
					function setSelectInputSelected(id,value){
						var options = dom.byId(id).options;
						for(var index=0;index<options.length;index++){
							if(options[index].value==value){
								options[index].selected="selected";	
								break;
							}
						}
					}
					on(dom.byId("quality"),"change",function(){
						var quality = dom.byId("quality").value;
						if(quality=="0"){
							setSelectInputSelected("renderSize","250x150");
							setSelectInputSelected("SamplingRate","1000");
						}else if(quality=="1"){
							setSelectInputSelected("renderSize","1200x900");
							setSelectInputSelected("SamplingRate","6000");
						}
					});
					on(dom.byId("SamplingRate"),"change",function(){
						setSelectInputSelected("quality","-1");	
					});
					on(dom.byId("renderSize"),"change",function(){
						if(dom.byId("renderSize").value=="-1"){
							dom.byId("userRenderSize").style.display='block';
						}else{
							dom.byId("userRenderSize").style.display='none';
						}
						setSelectInputSelected("quality","-1");	
					});
					function checkNumber(value){
						var re = /^\d+(\d+)?$/;  
						if (!re.test(value)){    
							return false;  
						}  
						return true;
					}
					on(dom.byId("lockScale"),"click",function(){
						if(dom.byId("lockScale").checked){
							if(dom.byId("render_W").value && dom.byId("render_H").value){
								var W = new Number(dom.byId("render_W").value);
								var H = new Number(dom.byId("render_H").value);
								dom.byId("lockScale").value = W/H;
							}else{
								dom.byId("lockScale").checked = false;
								alert("需要输入宽高才可以锁定！");
							}
						}
					});
					var render_W_value;
					var render_H_value;
					on(dom.byId("render_W"),"focus",function(){
						render_W_value = dom.byId("render_W").value;
					});
					on(dom.byId("render_H"),"focus",function(){
						render_H_value = dom.byId("render_H").value;
					});
					on(dom.byId("render_W"),"change",function(){
						if(!checkNumber(dom.byId("render_W").value)){
							dom.byId("render_W").value=render_W_value;
							alert("请输入正确的数字");
						}else{
							if(dom.byId("lockScale").checked){
								var scale = new Number(dom.byId("lockScale").value);
								var W = new Number(dom.byId("render_W").value);
								dom.byId("render_H").value = Math.round(W/scale);
							}
							setSelectInputSelected("quality","-1");	
							setSelectInputSelected("renderSize","-1");	
						}	
					});
					on(dom.byId("render_H"),"change",function(){
						if(!checkNumber(dom.byId("render_H").value)){
							dom.byId("render_H").value=render_H_value;
							alert("请输入正确的数字");
						}else{
							if(dom.byId("lockScale").checked){
								var scale = new Number(dom.byId("lockScale").value);
								var H = new Number(dom.byId("render_H").value);
								dom.byId("render_W").value = Math.round(H*scale);
							}
							setSelectInputSelected("quality","-1");	
							setSelectInputSelected("renderSize","-1");	
						}	
					});
					
					on(dom.byId("cancel"),"click",function(){
						dojo.require("dijit.Dialog");
						// create the dialog:
						myDialog = new dijit.Dialog({
							title: "页面关闭提示",
							content: "<div style='padding: 10px;background:#fff;'><div style='padding: 10px;'>是否取消提交当前渲染任务？</div><button id='closeButton_cancel' style='float:left;margin-bottom: 10px;'>是</button><button id='cancelButton_cancel' style='float:right;margin-bottom: 10px;'>否</button></div>"
						});	
						myDialog.own(on(dom.byId("cancelButton_cancel"),"click",function(){
							myDialog.destroy();
						}));
						myDialog.own(on(dom.byId("closeButton_cancel"),"click",function(){
							myDialog.destroy();
							if(isGutil){
								GuitlCloseWindow();
							}
						}));
						myDialog.show();
					});
					on(dom.byId("showAdvancedOptions_button"),"click",function(){
						if(dom.byId("showAdvancedOptions_button").checked){
							dom.byId("AdvancedOptions_Panel").style.display='block';
							dom.byId("BaseOptions_Panel").style["marginLeft"]="5%"
							
						}else{
							dom.byId("BaseOptions_Panel").style["marginLeft"]="33%";
							dom.byId("AdvancedOptions_Panel").style.display='none';
						}
					});
				});		
		}
		getDefaultMsg({});
		</script>
	</body>
</html>