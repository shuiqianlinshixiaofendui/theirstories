<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>
            效果图
        </title>
		<script type="text/javascript" >
			dojoConfig = {
				parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
		
        <script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
        <script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/myfavouritepreview.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/Category/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/CategorySelect/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/List/css/main.css" media="screen">
    </head>
    <body class="claro">
		<div id="myfavouritepreviewContent" dojoType="dijit.layout.BorderContainer" gutters=false>
			<div dojoType="dijit.layout.ContentPane" region="top" id="searchpreview">
				<div id="searchpreviewinput"></div>
				<button type="button" id="btnSearchPreview"></button>
			</div>
			<div dojoType="dijit.layout.ContentPane" region="center" class="myfavouritepreviewlist_previewlist" id="previewlist">
				
			</div>
			<div dojoType="dijit.layout.ContentPane" region="bottom" id="previewlist_pager" class="myfavouritepreviewlist_pager">
				
			</div>
		</div>
	<script type="text/javascript">
		
		require(
			[
				"dojo/parser","dojo/ready","dojo/dom","dojo/dom-style","dojo/on","dojo/query", 
				"dijit/form/Button","dijit/registry","dijit/layout/BorderContainer", "dijit/layout/ContentPane",
				"dijit/layout/TabContainer","dojo/store/Memory", 
				"dijit/form/FilteringSelect","widgets/Pagination/Pagination","widgets/Category/Category",
				"widgets/CategorySelect/CategorySelect","dojo/dom-class",
				"widgets/List/List","spolo/data/folder/favourite",
				"spolo/data/folder/previewlib","dojo/keys","dojo/NodeList-traverse"
				
			],function(
				parser, ready, dom, domStyle, on, query, Button,registry,
				BorderContainer,ContentPane,TabContainer,Memory,FilteringSelect,Pagination,Category,CategorySelect,
				domclass,List,favourite,previewlib,keys
			){
				ready(function(){
					this.scene = this.parent.scene;
					var scene = this.scene;
					var iframe = this.parent.iframe;
					var list = new List();
					list.placeAt("previewlist");
					var json = 
					{
						total:0
					};
					var pagination = new Pagination(json).placeAt("previewlist_pager");//初始化分页组件
					var currentPage = 1;
					var limit = 10;
					var inputvalue;
					initSearch();//初始化搜索框
					initPreviewList();//初始化收藏的效果图列表
					
					//搜索的UI
					function initSearch(){
						var filteringSelect = new FilteringSelect({
							//store: dthis.stateStore,
							searchAttr: "resourcename",
							style:"margin:15px 0 20px 32%;height:22px;width:360px;font-size:15px;padding:2px 0 2px 0",
							hasDownArrow:false,
							forceWidth:true,
							required:false,
							invalidMessage:false,
							trim:true,
							autoComplete:false,
							onKeyUp:function(evt)
							{
								inputvalue = filteringSelect.get('displayedValue');
								switch(evt.keyCode)
								{
									case keys.ENTER:
										if(inputvalue.trim() != ""){
											initPreviewList.call(this);
										}
										break;
								}
							},
							validate:function() 
							{
							}
						}, "searchpreviewinput");	
						new Button({
							label:"查询",
							style:"font-size:14px;margin:-4px 0 0 25px;",
							onClick:function(){
								if(inputvalue.trim() != ""){
									initPreviewList.call(this);
								}
							}
						},"btnSearchPreview");
					}
					/***************以下是处理效果图列表的方法*************************/
					//调用后端的查询方法
					function searchpreviews(callback){
						var offset = (currentPage - 1) * limit;
						favourite.getAllFavPreviews({
							value:inputvalue,
							limit:limit,
							offset:offset.toString(),
							success:function(data,num){
								callback(data,num);
							},
							failed:function(err){
								console.log(err);
							}
						});
					}
					//格式化时间
					function format(obj){
						if(obj<10)
							return "0" +""+ obj;
						else
							return obj;
					}
					//初始化list
					function initPreview(data){
						var modelpath = [];
						for(var key in data)
						{
							modelpath.push(key);
						}
						list.addItems(modelpath,true);
						setPreviewName.call(this,data);
						setPreviewFavtime.call(this,data);
						setPreviewImage.call(this,data);
					}
					//设置模型的缩略图
					function setPreviewImage(data){
						function getPreviewImage(key){
							previewlib.getPreviewImages(
								key,
								function(url){
									if(url && url.length){
										var img = url[0];
										list.setItemImage(key,img); 
									}
								},
								function(error){
									var img =  "/modules/scenedetail/images/nopreview.jpg";
									list.setItemImage(key,img);
								}
							);
						}
						for(var key in data){
							getPreviewImage.call(this,key);
						}
					}
					//设置效果图的名称
					function setPreviewName(data){
						for(var key in data){
							var previewname = data[key]["resourceName"];
							list.addDomNode(key,"<div>名称：" + previewname + "</div>");
						}
						
					}
					//设置效果图的收藏时间
					function setPreviewFavtime(data){
						for(var key in data){
							var favtime = data[key]["favtime"];
							var _date = new Date(favtime);
							var datestring = format(_date.getFullYear()) + "-"
								+ format(_date.getMonth()+1) + "-"
								+ format(_date.getDate()) + " "
								+ format(_date.getHours()) + ":"
								+ format(_date.getMinutes()) + ":"
								+ format(_date.getSeconds());
							list.addDomNode(key,"<div>收藏时间：" + datestring + "</div>");
						}
					}
					//初始化列表
					function initPreviewList(){
						searchpreviews.call(this,function(data,num){
							console.log(data);
							pagination.refresh(Math.ceil(num/limit),currentPage);
							initPreview.call(this,data);
						});
					}
					//响应分页事件
					pagination.watch(
						"nowPage", 
						function()
						{
							currentPage = pagination.get("nowPage");
							initPreviewList.call(this);
						}
					);
					/*************************以下是效果图详细信息显示的部分*********************************************/
					//监听点击缩略图的事件
					list.on("onListItemClick",function(data){//得到的是效果图路径
						showPreviewDetail.call(this,data);
					});
					function showPreviewDetail(path){
						//spdialog的形式
						var url = "/widgets/PreviewDetail/PreviewDetailInPreviewLib.html";
						var dialogData = 
						{
							widthradio: 0.9,
							heightradio:0.9,
							id:path,
							title:"效果图预览",
							url:url,
							data:{
								"iframe":iframe,
								"scene":scene,
								"numberSpinner":true,
								"isRadio":this.isRadio,
								"canAddModel":true,
								"path":path,
								"isnotclickmodel":true
							}
						};
						Spolo.dialog(dialogData);
					}
				});	
			});
	</script>	
    </body>
</html>