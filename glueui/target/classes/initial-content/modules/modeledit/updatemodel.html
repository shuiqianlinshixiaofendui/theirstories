<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>更新模型</title>
		<script type="text/javascript" >
			dojoConfig = {
				//parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name: "modeledit",
						location: "/modules/modeledit"
					}
				]
			};
		</script>
		
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script> 
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/main.css" media="screen"/>
		<script type="text/javascript" >
			
		</script>
	</head>
	
	<body class="claro">
		<div style="width:920px;height:550px;position:absolute;top:0px;left:0px;">
			<div style="width:920px;height:100px;position:absolute;top:0px;left:0px;">
				<div style="position:absolute;top:20px;left:0px;">
					<label style="font-weight:bold;font-size:15px;">|&nbsp;更新模型：</label>
				</div>
				<div style="width:920px;height:1px;background:grey;position:absolute;top:45px;left:10px;">
				</div>
				<div style="position:absolute;top:80px;left:4px;">
					<div style="float:left;margin-left:20px;">
						<div id="selectUpdateFile" style="background:#cccccc;padding:6px;cursor:pointer;">
							选择高模文件
						</div>
						<form id="updateFileFormNode" method="POST" enctype="multipart/form-data" style="display:none">
							<input type="file" name="updateFileInput" id="updateFileInputNode"></input>
							<input type="file" name="updateFileInput2" id="updateFileInputNode2"></input>
						</form>
					</div>
					<div style="line-height:30px;width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:absolute;top:0px;left:160px;">
						文件名称：
						<label id="updateFileNameNode" >未选择</label>
					</div>
                    
                    <div style="float:left;margin-left:20px;">
						<div id="selectUpdateFile2" style="background:#cccccc;padding:6px;cursor:pointer;position: absolute; top: 40px;left: 20px;">
							选择简模文件
						</div>
					</div>
					<div style="line-height:30px;width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:absolute;top:40px;left:160px;">
						文件名称：
						<label id="updateFileNameNode2" >未选择</label>
					</div>
                    
					<div>
						<label style="width:400px;position:absolute;top:80px;left:50px;font-weight:bold;">请输入此时模型更改信息日志：</label>
						<textarea data-dojo-type="dijit/form/SimpleTextarea" id="introduction" rows="6" style="width:400px;position:absolute;top:100px;left:80px;"></textarea>
					</div>
				</div>
				<div id="startUpdateModelNode" style="display:none;cursor:pointer;position:absolute;top:220px;left:780px;">
					<img src="image/update.png" style="position:absolute;top:0px;left:0px;" title="更新模型"/>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			require(
				[
					"dojo/ready",
					"dojo/dom",
					"modeledit/js/ModelEditLogic",
					"dojo/_base/array",
					"spolo/data/user"
				],
				function(
					ready, dom, ModelEditLogic, arrayUtil, user
				){
					ready(function(){
						var varsMap = Spolo.getUrlVars();
						var path = varsMap['modelPath'];
						var grant = false;
						var userName = Spolo.getUserId();
						user.isGranted(
							userName,
							path,
							function(result)
							{
								var varsMap = Spolo.getUrlVars();
								var isGrant = varsMap ['isGrant'];
								if(result == "True")
								{
									var startUpdateModelNode = dom.byId("startUpdateModelNode");
									startUpdateModelNode.style["display"] = "block";
									if(isGrant == "false")
									{
										hasNoGrant.call(this);
									}
									else
									{
										grant = true;
									}
								}
								else
								{
									hasNoGrant.call(this);
								}
							},
							function(error){
								throw error;
							}
						);
						var modelEditLogic = new ModelEditLogic(path);
						
						var updateFileInputNode = dom.byId("updateFileInputNode");
						
						var selectUpdateFile = dom.byId("selectUpdateFile");
						
						selectUpdateFile.onclick = function(){
							console.log("选择文件...");
							if(grant)
							{
								updateFileInputNode.click();
							}
						};
                        
						updateFileInputNode.onchange = function(){
							var dthis = this;
							var fileInfo = new Object();
							if(updateFileInputNode && updateFileInputNode.files){
								var sceneJsonFile = updateFileInputNode.files[0];
								if(sceneJsonFile){
									//文件名称
									fileInfo.fileName = sceneJsonFile.name != undefined ? sceneJsonFile.name : "未选择";
									//文件大小
									fileInfo.fileSize = sceneJsonFile.size != undefined ? sceneJsonFile.size : 0;
								}
							}
							var updateFileNameNode = dom.byId("updateFileNameNode");
							console.log("选择的文件是 ：" + updateFileInputNode.value);
							updateFileNameNode.innerHTML = updateFileInputNode.value;
						}
                        
                        var selectUpdateFile2 = dom.byId("selectUpdateFile2");
						
						selectUpdateFile2.onclick = function(){
							console.log("选择文件...");
							if(grant)
							{
								updateFileInputNode2.click();
							}
						};
						
						updateFileInputNode2.onchange = function(){
							var dthis = this;
							var fileInfo = new Object();
							if(updateFileInputNode2 && updateFileInputNode2.files){
								var sceneJsonFile = updateFileInputNode2.files[0];
								if(sceneJsonFile){
									//文件名称
									fileInfo.fileName = sceneJsonFile.name != undefined ? sceneJsonFile.name : "未选择";
									//文件大小
									fileInfo.fileSize = sceneJsonFile.size != undefined ? sceneJsonFile.size : 0;
								}
							}
							var updateFileNameNode2 = dom.byId("updateFileNameNode2");
							console.log("选择的文件是 ：" + updateFileInputNode2.value);
							updateFileNameNode2.innerHTML = updateFileInputNode2.value;
						}
						
						var startUpdateModelNode = dom.byId("startUpdateModelNode");
						startUpdateModelNode.onclick = function(){
							if(updateFileInputNode.value == "" &&updateFileInputNode2.value == "" )
							{
								Spolo.notify({
									"text" : "请您选择上传的文件！",
									"type" : "error",
									"timeout" : 1000
								});
							}else
							{
                                var introduction = dom.byId("introduction");
                                // if(introduction.value)
                                // {
                                var updateFileFormNode = dom.byId("updateFileFormNode");
                                modelEditLogic.updateModel(introduction.value,updateFileFormNode);
                                // }
                                // else
                                // {
                                    // Spolo.notify({
                                        // "text" : "请输入此时模型更改信息日志！",
                                        // "type" : "warning",
                                        // "timeout" : 1000
                                    // });
                                // }
							}
						}
					
					});
					
					function hasNoGrant(){
						var selectUpdateFile = dom.byId("selectUpdateFile");
						selectUpdateFile.style["cursor"] = "default";
                        var selectUpdateFile2 = dom.byId("selectUpdateFile2");
						selectUpdateFile2.style["cursor"] = "default";
						var introduction = dom.byId("introduction");
						introduction.disabled = "disabled";
						introduction.style["cursor"] = "default";
					}
			});
		</script>
	</body>
</html>

