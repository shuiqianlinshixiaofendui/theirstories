<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>模型版本信息</title>
		<script type="text/javascript" >
			dojoConfig = {
				//parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					}
				]
			};
		</script>
		
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script> 
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="js/modelversioninfo.js"></script>
		<script type="text/javascript" src="/script/spolo/data/model.js"></script> 
		<link href="/libs/dojox/grid/resources/claroGrid.css" rel="stylesheet">	
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<style type="text/css">
			html, body {
				width: 100%;
				height: 100%;
				margin: 0;
				overflow:hidden;
			}
			#borderContainer {
				position:absolute;
				width:100%;
				height:100%;
			}
			#top-part{
				width:100%;
				height:30px;
				background:#f0f0f0;
			}
			#center-part{
				position:absolute;
				width:100%;
				height:472px;
			}
			form {
				color: #59636A;
			}
			form {
				display: block;
				margin-top: 0em;
			}
			#search{
				position:absolute;
				width:524px;
				height:25px;
				background-image: url(image/search_bg.png);
			}
			#search #search-left {
				position:absolute;
				left:1px;
				top:2.5px;
				width: 22px;
				height:20px;
				background-image: url(image/search_icon.jpg);
				background-repeat: no-repeat;
			}
			#search #search-mid {
				position:absolute;
				left:24.5px;
				top:0px;
				width: 585px;
				height:25px;
				background-repeat: repeat-x;
				margin: 0;
				padding: 0;
			}
			#search #searchButton {
				display:none;
				position:absolute;
				right:3px;
				top:5px;
				width: 18px;
				border:0px;
				height:18px;
				background-image: url(image/search_del.png);
				background-repeat: no-repeat;
			}
			#query.empty {
				font-style: italic;
				color: #a4abb2;
			}
			#query {
				margin-top:2px;
				font-size: 14px;
				font-weight: normal;
				font-style: normal;
				padding-top: 3px;
				height:14px;
				width:470px;
			}		
			#from-text{
				position:absolute;
				left:538px;
				width:50px;
				height:11px;
				top:13px;
				font-size:12px;
			}
			#from-date{
				position:absolute;
				left:585px;
				top:8px;
				width:94px;
				height:25px;
			}
			#to-text{
				position:absolute;
				left:690px;
				top:13px;
				width:45px;
				height:11px;
				font-size:12px;
			}
			#to-date{
				position:absolute;
				left:730px;
				top:8px;
				width:94px;
				height:25px;
			}
		</style>
		<script type="text/javascript" >
			require(["dojo/parser", "dojo/ready"], function(parser, ready){
				ready(function(){
					parser.parse();
				});
			});
		</script>
	</head>	
	<body class="claro">
		<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'sidebar', gutters:true, liveSplitters:true" id="borderContainer">
			<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="splitter:true, region:'center'" style="background:#f0f0f0;">
				<div id="top-part">
					<div id="search"></div>
					<div id="from-text"></div>
					<div id="from-date">
						<input id="from_input"/>
					</div>
					<div id="to-text"></div>
					<div id="to-date">
						<input id="to_input"/>
					</div>
				</div>
				<div id="center-part"></div>
			</div>
		</div>
		<script type="text/javascript">
			require(
				[
					"modeledit/js/modelversioninfo",
					"spolo/data/model",
					"dojo/dom",
					"dojo/on",
					"dojo/_base/array",
					"dojo/data/ObjectStore",
					"dojo/store/Memory",
					"dojo/keys",
					"spolo/data/user",
				],
				function(
					modelversioninfo_cls,model_cls,dom,on,arrayUtil,ObjectStore,Memory,keys,user
				){
					var path = getParameter("modelPath");
					if(!path){
						console.error("[INFO] 没有modelPath !");
					}
					//init ...
					var modelversion  = new modelversioninfo_cls(path);
					//top part.......
					var twodayAgo = new Date();
					twodayAgo.setDate(twodayAgo.getDate()-2);
					modelversion.createSearch(dom.byId("search"));
					modelversion.createTXT("From:",dom.byId("from-text"));
					modelversion.createDateTextBox("startTime",twodayAgo,"from_input");
					modelversion.createTXT("To:",dom.byId("to-text"));
					modelversion.createDateTextBox("endTime",new Date(),"to_input");
					var model = new model_cls(path);
				
					var data_all={
						identifier:'id',
						items:[]
					};	
					initHistory();
					function initHistory(){
						var myToDate = dijit.byId("endTime");
						var myFromDate = dijit.byId("startTime");
						myToDate.constraints.min = myFromDate.value;
						myFromDate.constraints.max = myToDate.value;
						var userName = Spolo.getUserId();
						var nodePath = "/content/modellib";	
						model.history({
							"success" : function(data){
								user.isGranted(
									userName,
									nodePath,
									function(result)
									{
										var currentVersion = data["current"];
										//获取历史记录
										var dataAll = data["history"];
										for(var i in dataAll){
											var _currentData = dataAll[i];
											if(_currentData["id"]==currentVersion){
												var json = {col1:_currentData["id"],col2:"当前版本",col3:_currentData["msg"]["user"],col4:_currentData["date"],col5:"下载"+_currentData["id"],col6:_currentData["msg"]["msg"]}
												data_all["items"].push(json);
											}else{
												if(result == "True"){
													var json = {col1:_currentData["id"],col2:"radio"+_currentData["id"],col3:_currentData["msg"]["user"],col4:_currentData["date"],col5:"下载"+_currentData["id"],col6:_currentData["msg"]["msg"]}
													data_all["items"].push(json);
												}else{
													var json = {col1:_currentData["id"],col2:"cannotEdit",col3:_currentData["msg"]["user"],col4:_currentData["date"],col5:"下载"+_currentData["id"],col6:_currentData["msg"]["msg"]}
													data_all["items"].push(json);
												}
											}
										}	
										modelversion.createDataGrid(data_all,"center-part");
										
									},
									function(error){
										throw error;
									}
								);
							},
							"failed" : function(error){
								dom.byId("center-part").innerHTML="当前数据有问题，没有办法正常显示!";
								console.log(error);
							}
						});	
					}	
					on(dijit.byId("startTime"),"change",function(){
						var myToDate = dijit.byId("endTime");
						myToDate.constraints.min = arguments[0];
					});
					on(dijit.byId("endTime"),"change",function(){
						var myFromDate = dijit.byId("startTime");
						myFromDate.constraints.max = arguments[0];
					});
					on(dom.byId("query"),"keyup",function(evt){
						var charOrCode = evt.charCode || evt.keyCode;
						dom.byId("searchButton").style["display"] = "block";
						switch(charOrCode){
							case keys.ENTER:
								refreshDate();
								break;
						}
					});
					function refreshDate(){
						var dateStart;
						var dateEnd;
						var startTime = dijit.byId("startTime").value;
						var endTime = dijit.byId("endTime").value;	
						var searchValue = dom.byId("query").value;
						if(startTime=="Invalid Date"){
							dateStart  = new Date();
						}else{
							dateStart  = new Date(startTime);
						}
						if(endTime=="Invalid Date"){
							dateEnd = new Date();	
						}else{
							dateEnd = new Date(endTime);
						}
						var dateStartYear = dateStart.getFullYear();
						var dateStartMonth = dateStart.getMonth()+1;
						var dateStartDay = dateStart.getDate();
						var dateEndYear = dateEnd.getFullYear();
						var dateEndMonth = dateEnd.getMonth()+1;
						var dateEndDay = dateEnd.getDate(); 
						var startTime = parseInt(dateStartMonth)/10<1?dateStartYear+"-0"+dateStartMonth+"-"+dateStartDay+" 00:00:00 +0800":dateStartYear+"-"+dateStartMonth+"-"+dateStartDay+" 00:00:00 +0800";//year+"-"+month+"-01 00:00:00 +0800";
						var endTime =   parseInt(dateEndMonth)/10<1?dateEndYear+"-0"+dateEndMonth+"-"+dateEndDay+" 23:59:59 +0800":dateEndYear+"-"+dateEndMonth+"-"+dateEndDay+" 23:59:59 +0800";//year+"-"+month+"-"+day+"T00:00:00.000+08:00";
						var userName = Spolo.getUserId();
						var nodePath = "/content/modellib";	
						model.history({
							"kw" : searchValue,
							"sd" : startTime,
							"ed" : endTime,
							"success" : function(data){
								user.isGranted(
									userName,
									nodePath,
									function(result){
										data_all["items"] = [];	
										var currentVersion = data["current"];
										//获取历史记录
										var dataAll = data["history"];
										for(var i in dataAll){	
											var _currentData = dataAll[i];
											if(_currentData["id"]==currentVersion){
												var json = {col1:_currentData["id"],col2:"当前版本",col3:_currentData["msg"]["user"],col4:_currentData["date"],col5:"下载"+_currentData["id"],col6:_currentData["msg"]["msg"]}
												data_all["items"].push(json);
											}else{
												if(result == "True"){
													var json = {col1:_currentData["id"],col2:"radio"+_currentData["id"],col3:_currentData["msg"]["user"],col4:_currentData["date"],col5:"下载"+_currentData["id"],col6:_currentData["msg"]["msg"]}
													data_all["items"].push(json);
												}else{
													var json = {col1:_currentData["id"],col2:"cannotEdit",col3:_currentData["msg"]["user"],col4:_currentData["date"],col5:"下载"+_currentData["id"],col6:_currentData["msg"]["msg"]}
													data_all["items"].push(json);
												}
											}
										}
										var dataStore =  new ObjectStore({ objectStore:new Memory({ data: data_all["items"]})});	
										//dijit.byId("grid").store.onDelete();
										dijit.byId("grid").setStore(dataStore);
									},
									function(error){
										throw error;
									}
								);
							},
							"failed" : function(error){
								dom.byId("center-part").innerHTML="当前数据有问题，没有办法正常显示!";
								console.log(error);
							}
						});
					}
					on(dom.byId("searchButton"),"click",function(){
						dom.byId("query").value = "";
						dom.byId("searchButton").style["display"] = "none";
					});
					//根据参数名，获取值
					function getParameter(param){
						var value = "";
						var paramSearch = param+"=";
						var paramStr = location.search;
						var decode_paramStr = decodeURIComponent(paramStr).substring(1);
						var paramsArr = new Array();
						if(decode_paramStr.search(/&/)!=-1){
							paramsArr = decode_paramStr.split("&");
						}
						if(paramsArr[0]){
							arrayUtil.forEach(paramsArr,function(item,i){
								if(item.indexOf(param+"=")!=-1){
									value = item.substr(item.indexOf(param+"=")+paramSearch.length);
								}
							});
						}else{
							value = decode_paramStr.substr(decode_paramStr.indexOf(param+"=")+paramSearch.length);
						}
						return value;
					}
				}
			);
		</script>
	</body>
</html>