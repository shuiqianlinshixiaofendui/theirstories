<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>下载模型</title>
		<script type="text/javascript" >
			dojoConfig = {
				//parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name: "modeledit",
						location: "/modules/modeledit"
					}
				]
			};
		</script>
		
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script> 
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/main.css" media="screen"/>
		<script type="text/javascript" >
			
		</script>
	</head>
	
	<body class="claro">
		<div style="width:920px;height:550px;position:absolute;top:0px;left:0px;">
			<div style="width:920px;height:100px;position:absolute;top:0px;left:0px;">
				<div style="position:absolute;top:20px;left:0px;">
					<span style="font-weight:bold;font-size:15px;">|&nbsp;下载模型：</span>
				</div>
				<div style="width:920px;height:1px;background:grey;position:absolute;top:45px;left:10px;">
				</div>
				<div style="position:absolute;top:60px;left:10px;">
					<label>请选择文件格式：</label>
				</div>
				<div style="width:500px;position:absolute;top:100px;left:40px;">
					<div id="Blender" style="height:49px;display:inline-block;filter:alpha(opacity=100);opacity:0.3;">
						<img src="image/blender.png" title="下载Blender格式模型">
						</img>
					</div>
					<div id="Octane" style="height:39px;display:inline-block;filter:alpha(opacity=100);opacity:0.3;">
						<img src="image/octane.png" title="下载Octane格式模型">
						</img>
					</div>
					<div id="Wavefront" style="height:39px;display:inline-block;filter:alpha(opacity=100);opacity:0.3;">
						<img src="image/wavefront.png" title="下载Obj格式模型">
						</img>
					</div>
					<div id="auto3DMax" style="height:39px;display:inline-block;filter:alpha(opacity=100);opacity:0.3;">
						<img src="image/auto3dmax.png" title="下载3DMax格式模型">
						</img>
					</div>
				</div>
				<div style="width:500px;position:absolute;top:160px;left:20px;">
					<span>说明：灰色图片表示该模型不支持该格式下载。</span>
				</div>
			</div>
			<div style="width:920px;height:100px;position:absolute;top:180px;left:0px;">
				<div style="position:absolute;top:20px;left:0px;">
					<label style="font-weight:bold;font-size:15px;">|&nbsp;模型地址：</label>
				</div>
				<div style="width:920px;height:1px;background:grey;position:absolute;top:45px;left:10px;">
				</div>
				<div style="position:absolute;top:80px;left:40px;">
					<label style="color:grey;">单击后自动全选，使用 Ctrl + c 进行复制。</label>
				</div>
				<div style="position:absolute;top:100px;left:40px;">
					<label id="modelPath" style="cursor:pointer;"></label>
				</div>
			</div>
			<div style="width:920px;height:100px;position:absolute;top:320px;left:0px;">
				<div style="position:absolute;top:20px;left:0px;">
					<span style="font-weight:bold;font-size:15px;">|&nbsp;下载次数：</span>
				</div>
				<div style="width:920px;height:1px;background:grey;position:absolute;top:45px;left:10px;">
				</div>
				<div style="position:absolute;top:75px;left:15px;">
					<span id="modelTotal"></span>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			require(
				[
					"dojo/ready",
					"dojo/dom",
					"modeledit/js/ModelEditLogic",
					"dojo/_base/array",
					"spolo/data/user"
				],
				function(
					ready, dom, ModelEditLogic, arrayUtil, user
				){
					ready(
					function(){
						
						var varsMap = Spolo.getUrlVars();
						var path = varsMap['modelPath'];
						var modelEditLogic = new ModelEditLogic(path);
						
						modelEditLogic.getModelDownCount(
							function(data){
								console.log(data);
								var totalNum = dom.byId("modelTotal");
								totalNum.innerHTML = "该模型累计下载 " + data + " 次。";
							},function(error){
								console.log(error);
							}
						);
						
						var modelPath = dom.byId("modelPath");
						modelPath.innerHTML = path;
						
						
						modelPath.onclick = function(){
							if ($.browser.msie) {
								var range = document.body.createTextRange();
								range.moveToElementText(modelPath);
								range.select();
							} else if ($.browser.mozilla || $.browser.opera) {
								var selection = window.getSelection();
								var range = document.createRange();
								range.selectNodeContents(modelPath);
								selection.removeAllRanges();
								selection.addRange(range);
							} else if ($.browser.safari) {
								var selection = window.getSelection();
								selection.setBaseAndExtent(modelPath, 0, modelPath, 1);
							}
						}
						
						
						modelEditLogic.getFormat(
							function(data){
								console.log(data);
								for(var index = 0; index < data.length; index ++){
									switch(data[index]){
										case "blend":
											var blender = dom.byId("Blender");
											setClickCss.call(modelEditLogic,blender, "blend");
											break;
										case "ocs":
											var octane = dom.byId("Octane");
											setClickCss.call(modelEditLogic,octane, "ocs");
											break;
										case "obj":
											var wavefront = dom.byId("Wavefront");
											setClickCss.call(modelEditLogic,wavefront, "obj");
											break;
										case "max":
											var auto3DMax = dom.byId("auto3DMax");
											// setClickCss.call(modelEditLogic,auto3DMax, "max");
											auto3DMax.onclick = function(){
												console.log("下载3DMax格式");
												Spolo.notify({
													"text" : "暂不支持3DMax格式下载，请关注Glue产品！",
													"type" : "error",
													"timeout" : 1000
												});
											};
											break;
									}
								}
							},
							function(){
							}
						)
					});
					function setClickCss(obj, type){
						var _this = this;
						obj["style"]["opacity"]= "1";
						obj["style"]["cursor"]= "pointer";
						obj.onclick = function(){
							console.log("下载" + type + "格式文件");
							_this.downloadModel(type);
							_this.setModelDownCount(
								function(countNum){
									console.log(countNum);
									if(countNum!= undefined){
										var totalNum = dom.byId("modelTotal");
										totalNum.innerHTML = "该模型累计下载 " + countNum + " 次。";
									}
								},
								function(){
								
								}
							);
						};
					}
				});
		</script>
	</body>
</html>

