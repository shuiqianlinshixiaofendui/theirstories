<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>保存场景</title>
		<link rel="stylesheet" type="text/css" href="/libs/dijit/themes/claro/claro.css"  media="screen">
		<link rel="stylesheet" type="text/css"href="css/Main.css"/>
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen" />
		<script type="text/javascript" src="/script/spolo/ui/noty/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/jquery.noty.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/layouts/topCenter.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/themes/default.js"></script>
		<script>
			dojoConfig = {
				parseOnLoad: true,
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script> 
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/spdialog.js"></script>
	</head>
	<body  class="claro">
		
		<br /><br />
		<br /><br />
		
		<div id="NewScene" class="MainWrap" style="display:none;">
			<div class="title">保存场景</div>
			<br />
			<form id="newSceneForm" method="POST" enctype="multipart/form-data">
				<input id="sceneName" promptMessage="请输入场景的名称" class="inputBox" data-dojo-type="dijit.form.ValidationTextBox" trim="true" value=""/>
				<br /><br />
				<input type="file" id="newSceneFile" name="newSceneFile" style="visibility:hidden;" class="fileInput" />
				<input type="button" id="_NewBtn" class="submitButton" value="确&nbsp;&nbsp;定" />
			</form>
		</div>
		
		<div id="UpdateScene" class="MainWrap" style="display:none;">
			<form id="updateForm" method="POST" enctype="multipart/form-data">
				<div class="title">保存场景</div>
				<br />
				<span style="color:#aaa;">场景名称 ： </span><span id="updateSceneName"></span>
				<br /><br />
				<input type="file" id="updateFile" name="updateBtnFile" style="visibility:hidden;" class="fileInput" />
				<br />
				<input type="button" id="_UpdateBtn" class="submitButton" value="确&nbsp;&nbsp;定" />
			</form>
		</div>
		
		<div id="SaveAsScene" class="MainWrap" style="display:none;">
			<div class="title">场景另存为</div>
			<br />
			<form id="SaveAsForm" method="POST" enctype="multipart/form-data">
				<input id="saveAsSceneName" promptMessage="请输入场景的名称" class="inputBox" data-dojo-type="dijit.form.ValidationTextBox" trim="true" value=""/>
				<br /><br />
				<input type="file" id="saveAsFile" name="saveAsBtnFile" style="visibility:hidden;" class="fileInput" />
				<input type="button" id="_SaveAsBtn" class="submitButton" value="确&nbsp;&nbsp;定" />
			</form>
		</div>
		
		<div id="consoleDiv" class="MainWrap" style="height:100px; line-height:25px;"></div>
		
		<script>
			
			// 标志此为根节点
			Spolo.isRoot = true;
		
			require([
				"dojo/ready",
				"dojo/dom", 
				"dojo/on",
				"dijit/form/ValidationTextBox",
				"dojo/query"
			],function(ready, dom, on, ValidationTextBox, query){
				ready(function(){
					
					// ==============================================================================
					// 程序入口
					var urlVars = Spolo.getUrlVars();
					
					// 设置提交按钮为等待状态， 等待 gutil 整理本地数据
					setSubmitBtn(false, "加载中...");
					
					// 1. 获取场景信息(scene.json)
					// 2. 判断显示哪个UI界面：新建、保存、另存为
					// 3. 订阅 file input value changed 事件
					// 4. 向 gutil 发送填充 file input 的消息
					// 5. file input value changed 触发
					//    1. 显示 console ， 本地文件和云端文件
					//    2. 提交按钮变为可点击状态
					// 6. 提交成功后向 gutil 发送最新云端场景的URL，gutil更新/创建本地 scene.json
					getSceneInfo(
						function(sceneInfo)
						{
							var url , fileInputId;
							if(sceneInfo)
							{
								window.sceneInfo = sceneInfo;
								url = sceneInfo["url"];
							}
							// 先判断是否为另存场景
							if(urlVars["isSaveAs"] == "true")
							{
								// 显示另存为场景的UI
								displaySaveAsScene();
								fileInputId = "saveAsFile";
								// 订阅另存为场景的 file input value changed 事件
								onFileValChanged("saveAsFile", function(sceneDir){
									consoleLog(sceneDir, url);
									setSubmitBtn(true);
								});
							}
							else
							{
								// 根据场景的 URL 判断场景是否已经存在云端
								if(url)
								{
									// 显示更新云端场景的UI
									displaySaveOldScene();
									fileInputId = "updateFile";
									// 显示当前场景的名称
									displaySceneName(url);
									// 订阅更新场景的 file input value changed 事件
									onFileValChanged("updateFile", function(sceneDir){
										consoleLog(sceneDir, url);
										setSubmitBtn(true);
									});
								}
								else
								{
									// 显示保存新建场景的UI
									displaySaveNewScene();
									fileInputId = "newSceneFile";
									// 订阅新建场景的 file input value changed 事件
									onFileValChanged("newSceneFile", function(sceneDir){
										consoleLog(sceneDir, url);
										setSubmitBtn(true);
									});
								}
							}
							
							// 向 gutil 请求填充表单项
							setFileInput
							(
								{
								    // URL key | form file input id
									"finputid" : fileInputId
								}
							);
						}
					);
					
					/** 一个监听 DOM 属性值改变的方法；
					   因为 gutil 直接改变 form file input 的值无法触发 onchange 事件，所以这里用轮询方式写了一个监听
						{
							domid : "updateFile",	// 监听的 dom 元素 ID
							attr : "value",	// 监听的属性值
							circle: 1000,	// 监听的循环时间
							once: true,	// true 为只监听一次改变， false为始终监听
							changed : function(){	// 值改变后的处理方法
								dom.byId("consoleDiv").innerHTML += this.value;
							}
						}
					*/
					function domPolling(args)
					{
						var domid = args["domid"];
						if(!domid)
						{
							console.error("polling ERROR: domid is undeined!");
							return;
						}
						var attr = args["attr"];
						if(!attr)
						{
							console.error("polling ERROR: attr is undeined!");
							return;
						}
						var changed = args["changed"];
						if(!changed || typeof(changed)!="function")
						{
							console.error("polling ERROR: changed is undeined or is not a function!");
							return;
						}
						var circle = args["circle"];
						if(!circle || isNaN(circle))
						{
							circle = 1000;
						}
						var once = args["once"];
						if(!once)
						{
							once = false;
						}
						var element = document.getElementById(domid);
						var oValue = element[attr];
						var cValue = element[attr];
						var handle = setInterval(function(){
							cValue = element[attr];
							if(oValue != cValue)
							{
								changed.call(element);
								oValue = cValue;
								if(once){
									clearInterval(handle);
								}
							}
						},circle);
						return handle;
					}
					
					// 当选择文件的表单项发生改变时
					function onFileValChanged(domid, callback)	// "newSceneFile"  "updateFile"  "saveAsFile"
					{
						if(!domid)
						{
							console.error("onFileValChanged ERROR: domid is undeined!");
							return;
						}
						domPolling
						(
							{
								domid : domid,	// 监听的 dom 元素 ID
								attr : "value",	// 监听的属性值
								circle: 1000,	// 监听的循环时间
								once: true,		// true 为只监听一次改变， false为始终监听
								changed : function(){	// 值改变后的处理方法
									// dom.byId("consoleDiv").innerHTML += this.value;
									// 这里会同时处理 "newSceneFile"  "updateFile"  "saveAsFile" 三个文件选择框的 change 事件
									if(callback && typeof(callback)=="function")
									{
										callback(this.value);
									}
								}
							}
						);
					}
					
					// 把内容输出到 console 
					function consoleLog(path, url)
					{
						if(!path)
						{
							path = "不存在";
						}
						if(!url)
						{
							url = "不存在";
						}
						var log = "";
						log +="本地文件地址 :  &nbsp;&nbsp;" + path;
						log += "<br />";
						log += "云端场景地址 :  &nbsp;&nbsp;" + url ;
						dom.byId("consoleDiv").innerHTML = log;
					}					
					
					// 设置按钮的状态
					function setSubmitBtn(enabled, text)
					{
						query(".submitButton").attr("disabled", !enabled);
						if(enabled)
						{
							query(".submitButton").attr("value","确  定");
						}
						else
						{	
							var t = "上传中...";
							if(text){
								t = text;
							}
							query(".submitButton").attr("value", t);
						}
					}
					
					// 设置上传成功的提示
					function successNotify(textString)
					{
						Spolo.notify({
							text : textString,
							type : "success",
							timeout : 5000
						});
					}
					
					// =============================================================================
					// 保存全新场景
					on(dom.byId("_NewBtn"),"click",function(){
						// 获取并判断用户是否输入场景名称
						var sceneName = dom.byId("sceneName").value;
						if(!sceneName){
							dom.byId("sceneName").focus();
							return;
						}
						// 设置提交按钮不可点击
						setSubmitBtn(false);
						// 调用创建新场景的方法，传入场景名称和 form id
						newScene
						(
							sceneName, 		// 场景的名称
							"newSceneForm",	// form id
							function(sceneUrl)	// 上传成功
							{
								// 隐藏确定按钮
								query(".submitButton").attr("style", "display:none");
								successNotify("场景保存成功，3秒后关闭窗口!");
								// 把最新的云端场景URL发送给 gutil
								sendSceneUrl2Gutil(sceneUrl, function(){
									// 上传成功以后关闭窗口
									setTimeout(function(){
										var url = "http://127.0.0.1:10828/closewindow?isClose=true";
										Spolo.scriptCrossDomain(url, function(){});
									},3000);
								});
							},
							function()	// 上传失败
							{
								// 隐藏确定按钮
								query(".submitButton").attr("style", "display:none");
								alert("保存失败！ \r\n"+err);
							}
						);
					});
					
					// =============================================================================
					// 更新场景
					on(dom.byId("_UpdateBtn"),"click",function(){
						// 设置提交按钮可点击
						setSubmitBtn(false);
						// 调用更新云端场景的方法，传入 formId
						udpateScene
						(
							"updateForm",
							function(sceneUrl)
							{
								// 隐藏确定按钮
								query(".submitButton").attr("style", "display:none");
								successNotify("场景保存成功，3秒后关闭窗口!");
								// 把最新的云端场景URL发送给 gutil
								sendSceneUrl2Gutil(sceneUrl, function(){
									// 上传成功以后关闭窗口
									setTimeout(function(){
										var url = "http://127.0.0.1:10828/closewindow?isClose=true";
										Spolo.scriptCrossDomain(url, function(){});
									},3000);
								});
							},
							function(err)
							{
								// 隐藏确定按钮
								query(".submitButton").attr("style", "display:none");
								alert("保存失败！ \r\n"+err);
							}
						);
					});
					
					// =============================================================================
					// 场景另存为
					on(dom.byId("_SaveAsBtn"),"click",function(){
						// 获取并判断用户是否输入场景名称
						var sceneName = dom.byId("saveAsSceneName").value;
						if(!sceneName){
							dom.byId("saveAsSceneName").focus();
							return;
						}
						// 设置提交按钮不可点击
						setSubmitBtn(false);
						// 调用创建新场景的方法，传入场景名称和 form id
						newScene
						(
							sceneName, 		// 场景的名称
							"SaveAsForm",	// form id
							function(sceneUrl)	// 上传成功
							{
								// 隐藏确定按钮
								query(".submitButton").attr("style", "display:none");
								// 把最新的云端场景URL发送给 gutil
								sendSceneUrl2Gutil(sceneUrl, function(){
									if(urlVars["isPublish"].indexOf("true") > -1)
									{
										// 如果是发布场景，不关闭窗口，跳转页面
										successNotify("场景保存成功，3秒后跳转至模型列表!");
										setTimeout(function(){
											// 隐藏另存为页面
											dom.byId("SaveAsScene").style["display"] = "none";
											dom.byId("consoleDiv").style["display"] = "none";
											// 跳转页面/显示iframe
											window.location.href="/modules/gutil/savescene/publishscene.html?isGutil=true&path=" + sceneUrl;
										},3000);
									}else{
										// 如果不是发布场景，关闭窗口
										successNotify("场景保存成功，3秒后关闭窗口!");
										// 上传成功以后关闭窗口
										setTimeout(function(){
											var url = "http://127.0.0.1:10828/closewindow?isClose=true";
											Spolo.scriptCrossDomain(url, function(){});
										},3000);
									}
								});
							},
							function()	// 上传失败
							{
								// 隐藏确定按钮
								query(".submitButton").attr("style", "display:none");
								alert("保存失败！ \r\n"+err);
							}
						);
					});
					
				});
				
				// 显示新建场景保存的UI
				function displaySaveNewScene(){
					dom.byId("NewScene").style["display"] = "block";
					dom.byId("UpdateScene").style["display"] = "none";
					dom.byId("SaveAsScene").style["display"] = "none";
					dom.byId("sceneName").focus();
				}
				
				// 显示保存云端已存在场景的UI
				function displaySaveOldScene(){
					dom.byId("NewScene").style["display"] = "none";
					dom.byId("UpdateScene").style["display"] = "block";
					dom.byId("SaveAsScene").style["display"] = "none";
				}
				
				// 显示场景的名称
				function displaySceneName(url){
					getSceneName
					(
						url,
						function(sceneName)
						{
							dom.byId("updateSceneName").innerHTML = sceneName;
						}
					);
				}
				
				// 显示另存为场景的UI
				function displaySaveAsScene(){
					dom.byId("NewScene").style["display"] = "none";
					dom.byId("UpdateScene").style["display"] = "none";
					dom.byId("SaveAsScene").style["display"] = "block";
					dom.byId("saveAsSceneName").focus();
				}
			});

			/////////////////////////////////////////////////////////////////////////////////////
			//            Gutil 相关的方法                                                     //
			/////////////////////////////////////////////////////////////////////////////////////
			
			/** 从 gutil 层获取场景的URL
			*/
			function getSceneInfo(callback)
			{
				var url = "http://127.0.0.1:10828/sceneinfo"
				Spolo.scriptCrossDomain(url, callback);
			}
			
			/**	向 gutil 发送请求，设置要上传文件的地址
			*/
			function setFileInput(map)
			{
				var queryString = Spolo.encodeQueryData(map);
				var url = "http://127.0.0.1:10828/upload?"+queryString;
				Spolo.scriptCrossDomain(url, function(){});
			}
			
			/** 把最新的云端场景URL发送给 gutil
			*/
			function sendSceneUrl2Gutil(sceneUrl,callback)
			{
				if(!sceneUrl)
				{
					alert("sendSceneUrl2Gutil ERROR: sceneUrl is undefined! but the request has been sent out!");
				}
				var jsonstring = "{\"url\":\""+sceneUrl+"\"}";
				var url = "http://127.0.0.1:10828/uploadsuccess?json="+jsonstring;
				Spolo.scriptCrossDomain(url, function(){
					callback();
				});
			}
			
			/////////////////////////////////////////////////////////////////////////////////////
			//            新建、上传场景相关的方法                                              //
			/////////////////////////////////////////////////////////////////////////////////////

			/** 根据 JCR 中的场景路径得到一个 spolo.data.scene 对象
			*/
			function getSceneInstance(path, callback)
			{
				if(!path){
					console.error("getSceneInstance ERROR: path is undefined!");
					return;
				}
				if(!callback || typeof(callback)!="function"){
					console.error("getSceneInstance ERROR: callback is undefined!");
					return;
				}
				require(
					["spolo/data/scene"],
					function(sceneClass)
					{
						var scene = new sceneClass(path);
						callback(scene);
					}
				);
			}
			
			/**	获取场景的名称
			*/
			function getSceneName(url, callback)
			{
				if(!url)
				{
					console.error("getSceneName ERROR: url is undefined!");
					return;
				}
				getSceneInstance
				(
					url, 
					function(scene)
					{
						if(scene && callback && typeof(callback)=="function")
						{
							scene.getInfo(function(data){
								callback(data["resourceName"]);
							});
						}
					}
				);
			}
			
			/**	创建一个新场景，包括上传场景文件 ========================= 
			@param sceneName : 场景名称
			@param formId : 文件表单项所在的 form 元素的 id 
			============================================================*/
			function newScene(sceneName, formId, success, failed)
			{
				// 调用保存新场景的方法
				createSceneNode
				(
					{
						sceneName : sceneName,
						success: function(scene)
						{
							// 获取场景的地址
							var surl = scene.spnode.getFullpath();
							
							// 创建场景节点成功后，上传场景
							// 调用上传场景的方法
							uploadScene
							(
								{
									scene: scene,
									formId: formId,
									isUpdate: false,		// 不是更新场景，是创建新场景
									success: function(msg)
									{
										if(success && typeof(success)=="function")
										{
											success(surl);
										}
									},
									failed: function(err)
									{
										if(failed && typeof(failed)=="function")
										{
											failed(err);
										}
									}
								}
							);
						},
						failed: function(err)
						{
							alert(err);
						}
					}
				);
			}
			
			/**	更新云端已经存在的场景
			*/
			function udpateScene(formId, success, failed)
			{
				var sceneInfo = window.sceneInfo;
				if(sceneInfo)
				{
					var url = sceneInfo["url"];
					// 根据URL获取scene对象
					getSceneInstance
					(
						url, 	// 云端场景的 URL 
						function(scene)
						{
							// 获取场景的地址
							var surl = scene.spnode.getFullpath();
							// 调用上传场景的方法
							uploadScene
							(
								{
									scene: scene,
									formId: formId,
									isUpdate: true,
									success: function(){
										if(success && typeof(success)=="function")
										{
											success(surl);
										}
									},
									failed: failed
								}
							);
						}
					);
				}
				else
				{
					alert("[ERROR]: 没有获取到 scene.json ，无法保存场景。");
				}
			}
			
			/**	创建场景节点
			*/
			function createSceneNode(args)
			{
				var success =  args["success"];
				var failed = args["failed"];
				var sceneName = args["sceneName"];
				if(!sceneName)
				{
					console.error("newScene ERROR: sceneName is undefined!");
					return;
				}
				
				var uid = Spolo.getUserId();
				if(!uid || uid=="anonymous"){
					alert("未登录，请登录后再上传场景!");
					window.location.href = "/modules/user/index.html?isGutil=true&redirect=/modules/gutil/savescene/index.html";
					return;
				}
				var sessionPath = "/content/users/"+uid+"/scenelib";
				require(
					["spolo/data/scene","spolo/data/spsession", "dojo/request/xhr"],
					function(sceneClass, spsessionClass, xhr)
					{
						// 实例化 spsession 
						var spsession = new spsessionClass(sessionPath);
						// 新创建场景的节点名
						var sceneNodeName = Spolo.CreateNodeName("scene");	
						// 新创建场景在jcr中的路径
						var scenePath = sessionPath + '/' + sceneNodeName;
						// 把场景路径设置为全局变量；在上传场景成功后发送给gutil.
						window.scenePath = scenePath;
						
						var sceneJson = 
						{
							nodePath : sceneNodeName,
							property : 
							{
								resourceName : sceneName,
								"sling:resourceType":"scene",
								"isProcessing": "2",
								"publishAuthor": uid
							}
						};
						spsession.addNode(sceneJson);
						// 默认在场景下添加 model 节点，避免获取模型列表时出现404错误。
						spsession.addNode({
							nodePath: scenePath + "/model",
							property : {
								"sling:resourceType":"folder"
							}
						});
						// 默认在场景下添加 material 节点。
						spsession.addNode({
							nodePath: scenePath + "/material",
							property : {
								"sling:resourceType":"folder"
							}
						});
						// 保存场景节点
						spsession.save
						(
							{
								success : function(spnode)
								{
									// 再发一个请求去设置场景的 publishdate 属性的类型为 Date
									var url = scenePath;
									var content = {};
									content["_charset_"] = "UTF-8";
									content["publishdate"] = (new Date()).toISOString();
									content["publishdate@TypeHint"] = "Date";
									xhr( url, {
										handleAs: "text",
										method: "POST",
										data: content
									}).then(
										function(msg) {
											if(success && typeof(success)=="function")
											{
												var scene = new sceneClass(scenePath);
												success(scene);
											}
										}, 
										function(e) {
											// alert("保存场景错误! \r\n " + err);
											if(failed && typeof(failed)=="function")
											{
												failed(err);
											}
										}
									);
								},
								failed: function(err)
								{
									// alert("保存场景错误! \r\n " + err);
									if(failed && typeof(failed)=="function")
									{
										failed(err);
									}
								}
							}
						);
					}
				);
			}
			
			/**	上传场景
			@param args = {
					scene: [typeof spolo.data.scene] ,
					formId: "",
					isUpdate: false, 	// 是更新场景还是新建或另存场景
					success: function(){},
					failed: function(){}
				}
			*/
			function uploadScene(args)
			{
				var scene = args["scene"];
				var formId = args["formId"];
				var isUpdate = args["isUpdate"];
				var success = args["success"];
				var failed = args["failed"];
				if(!scene)
				{
					alert("uploadScene ERROR: spolo.data.scene is undefined!");
					return;
				}
				if(!formId)
				{
					alert("uploadScene ERROR: formId is undefined!");
					return;
				}
				if(isUpdate)
				{
					// 更新场景的上传
					// TODO: 这里的接口不太好，先对接上，稍候再由ESP层修改
					require(["dojo/request/iframe"],function(iframe){
						var useNginx = true;
						var content = {};
						var	scenePath = scene.spnode.getFullpath();
						if(useNginx==false){
							url = scenePath+".updataMaxScene";
						}else{
							url = "/upload";
							content["spi_target"] = scenePath + ".updataMaxScene";
							content["useNginx"] = true;
						}
						content['_charset_'] = "UTF-8";
						iframe.post(url,{
							form: "updateForm",
							data : content,
							handleAs: "json"
						}).then(
							function(msg){
								if(success && typeof(success)=="function")
								{
									success(msg);
								}
							},
							function(error){	
								if(failed && typeof(failed)=="function")
								{
									failed(error);
								}
							}
						);
					});
				}
				else
				{	// 新建场景的上传
					scene.upload
					(
						formId,
						{
							x3d : false,	// 是否生成 x3d 资源文件
							del_err_obj : false,	// 是否删除错误模型
							checkDiffuse : false,	// 是否检查贴图
							//debug : false,
							resumable : true,	// 是否使用断点续传；如果断点续传就不支持实时消息了。
							notifier : function(msg)
							{
								alert("upload notifier");
							},
							load : function(data)
							{
								if(success && typeof(success)=="function")
								{
									success(data);
								}
							},
							error : function(err)
							{
								if(failed && typeof(failed)=="function")
								{
									failed(err);
								}
							}
						}
					);
				}
			}
			
		</script>
	</body>
</html>