<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<title>应用管理</title>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script>
			// 判断用户是否登录
			// 如果没有登录直接跳到登录页面
			var session = Sling.getSessionInfo();
			var userid, 
				href = "/modules/user/index.html";
			if(session){
				userid = session["userID"];
				if(userid=="anonymous"){
					window.location.href = href;
				}
			}
			dojoConfig = {
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					}
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<link rel="stylesheet" href="/modules/modulemanager/css/appStyle.css" media="screen">
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="/modules/modulemanager/js/jquery.masonry.min.js"></script>
		<script type="text/javascript">
			require([
				"dojo/ready",
				"dojo/topic",
				"dojo/_base/lang",
				"dojo/_base/array",
				"dojo/parser",
				"dojo/dnd/Source",
				"dojo/dnd/Target",
				"dojo/query",
				"dojo/on",
				"dojo/dom-class",
				"dojo/dom-construct",
				"dojo/string",
				"dojo/fx",
				"dojo/dom",
				"dojo/mouse",
				"dijit/registry",
				"dijit/layout/BorderContainer",
				"dijit/layout/ContentPane"
			],function(ready,topic,lang,arrayUtil,parser,Source,Target,query,on,domclass,domConstruct,stringUtil,fx,dom,mouse,registry,BorderContainer,ContentPane){
				ready(function(){	
					//把dojo widget展开为HTML DOM
					parser.parse();
					
					//---------初始化相关对象以及变量
					/**
					*获取相关API类对象
					*/
					var users = Spolo.getCurrentUser();
					var modules = Spolo.getModules();
					
					/**
					*1. 初始化系统、用户应用容器
					*2. 记录当前鼠标悬停的系统应用，与次级当前应用（用于记录当拖放结束时鼠标悬停所在的应用）
					*/
					var userApp = "";
					var sysApp = "";
					
					var currentApp = "";
					var secondaryApp = "";
					
					/**
					*1. 系统应用json数据
					*2. 用户应用详细列表数据
					*/
					var sysAppJson = {};
					var userListAppData;
					
					//更新用户信息
					query("#sp_pane .userName").attr("innerHTML",Spolo.decodeUname(Spolo.getUserId()));
					
					//检查用户操作过程中的登录状态
					function isLogin(){
						if(Spolo.getUserId() == "anonymous"){
							Spolo.notify({
								"text" : "操作失败，您已处于下线状态，请重新登录！",
								"type" : "warning",
								"timeout" : 1000
							});
							window.location.href = "/modules/user/index.html";
							return false;
						}else{
							return true;
						}
					}
					
					/**
					*设计容器中实体、替身的dom结构
					*/
					//系统应用
					var systemModule = function(){
						return '<div class="dojoDndHandle moduleItem ${url}" url="${url}" style="display:none;">'+
										'<div class="mainDiv">'+
											'<span class="out">'+
												'<img class="appImg" src="${imageUrl}">'+
												'<div class="appName">${name}</div>'+
											'</span>'+
											'<span class="over">'+
												'<div class="appName">${name}</div>'+
												'<img class="appImg" src="${imageUrl}">'+
												'<div class="appDesc">${description}</div>'+
												'<div class="addApp">添加</div>'+
											'</span>'+
										'</div>'+
								  '</div>';
					}
					//应用面板——用户应用
					var userModule = function(){
						return '<div class="dojoDndHandle" url="${url}">'+
									'<div class="userDiv">'+
										'<img class="appImg" src="${imageUrl}">'+
										'<div class="appName">${name}</div>'+
										'<div class="buttonComm">'+
											'<img src="/modules/modulemanager/images/remove.png" width="22" height="22"/>'+
										'</div>'+
									'<div>'+
								'</div>';
					}
					//应用列表——用户应用
					var userListModule = function(){
						return '<li class="dojoDndHandle" url="${url}">'+
									'<div class="selectedDiv"></div>'+
									'<div class="selected"></div>'+
									'<img class="appImg" src="${imageUrl}"/>'+
									'<div class="appName" alt="">${name}</div>'+
									'<div class="appDesc">${description}</div>'+
								   	'<div class="delApp">删除应用</div>'+
									//'<div class="setApp">关闭应用</div>'+
								'</li>';
					}
					//应用列表——用户应用替身
					var userListModuleTubstitute = function(){
						return '<div class="dojoDndHandle" url="${url}">'+
									'<div class="userDiv">'+
										'<img class="appImg" src="${imageUrl}">'+
										'<div class="appName">${name}</div>'+
									'<div>'+
								'</div>';
					}
					
					/**
					*容器应用构造函数
					*/
					//系统应用构造函数
					function systemModulesCreator(item, hint){
						//生成唯一ID标识
						//var unId = dojo.dnd.getUniqueId();
						var node = domConstruct.toDom(stringUtil.substitute(
							hint === "avatar" ? userListModuleTubstitute() : systemModule(), {  
								name: item.name || "未命名应用",  
								imageUrl: item.icon || "",  
								description: item.description ? item.description : "暂无相关介绍信息",
								url: item.url
							}  
						));
						return {node: node, data: item };
					}
					//用户应用面板应用构造函数
					function userModulesCreator(item, hint){
						var node = domConstruct.toDom(stringUtil.substitute(
							hint === "avatar" ? userListModuleTubstitute() : userModule(), {  
								name: item.name || "未命名应用",  
								imageUrl: item.icon || "",
								url: item.url
							}  
						));
						return {node: node, data: item };
					}
					//用户应用列表应用构造函数
					function userLIsthModulesCreator(item, hint){
						var node = domConstruct.toDom(stringUtil.substitute(
							hint === "avatar" ? userListModuleTubstitute() : userListModule(), {  
								name: item.name || "未命名应用",  
								imageUrl: item.icon || "",  
								description: item.description ? item.description : "暂无相关介绍信息",
								url: item.url
							}  
						));
						return {node: node, data: item };
					}	

					/**
					*订阅用户应用排序功能
					*/
					topic.subscribe("modulemanager/sort",function(source,iscopy,target){
						//禁止对系统应用排序，仅对用户应用排序
						if(source.parent.id == "userApp" || source.parent.id == "userListApp" || iscopy){
							//执行排序
							setTimeout(function(){
								//获取用户应用中已选中应用
								var userSelect = target.selection;
								for(var node in userSelect){
									//获取用户容器中的所有应用
									var userNode = target.getAllNodes();
									var userId = query(userNode).attr("id");
									for(var index = 0; index < userId.length; index++){
										if(userId[index] == node){
											//根据用户指定位置进行排序
											var url = query("#"+userId[index]).attr("url").toString();
											users.moveModule(url,index,function(){
												//排序成功后的处理
												Spolo.notify({
													"text" : "操作成功！",
													"type" : "success",
													"timeout" : 1000
												});
											},function(){
												Spolo.notify({
													"text" : "执行用户应用排序时出错！",
													"type" : "error",
													"timeout" : 1000
												});
											});
											break;
										}
									}
								}
							},0);	
						}
					});
					
					/**
					*注册结束事件，当拖放动作结束时触发
					*/
					topic.subscribe("/dnd/drop",function(source,nodes,iscopy,target){
						//添加用户应用
						if(iscopy){
							//删除容器提示
							$("#sp_top .userMsg") ? $("#sp_top .userMsg").remove() : null;
							
							//初始化状态位置
							var num = target.getAllNodes().length;
							
							//获取系统应用中的已选中应用
							var sysSelect = source.selection;
							for(var j in sysSelect){
								//关联url
								var url = query("#"+j).attr("url").toString();
								var nodeId = j;
								//是否存在该系统应用的配置信息
								modules.hasModuleConfig(url, function(){
									//获取系统应用配置信息
									modules.getDefaultConfig(url,function(configJson){
										//添加应用至用户列表
										users.addModule({
											moduleName : url,
											index : num,
											defaultConfig : configJson
										},function(){
											//修改实体样式，删除拖放柄。可实现多个修改
											$(".mainDiv","#"+nodeId).append('<div class="selectedDiv"></div><div class="selected"></div>')
											$("#"+nodeId).removeClass("dojoDndHandle");
											$("#"+nodeId).find(".addApp").addClass("addApped").removeClass("addApp").text("已添加").css("background","#5fb000");

											//执行用户应用排序
											topic.publish("modulemanager/sort",source,iscopy,target);
										},function(error){
											//检查用户是否登录
											if(isLogin()){
												Spolo.notify({
													"text" : "添加应用失败！",
													"type" : "error",
													"timeout" : 1000
												});
											}
										});
									},function(){
										//删除当前新添加应用
										userApp.deleteSelectedNodes();
										Spolo.notify({
											"text" : "获取系统应用配置信息失败，添加应用未成功！",
											"type" : "error",
											"timeout" : 1000
										});
									});
								}, function(){
									//console.log("不存该系统应用的配置信息");
									//添加应用至用户列表
									users.addModule({
										moduleName : url,
										index : num
									},function(){
										//修改实体样式，删除拖放柄。可实现多个修改
										$(".mainDiv","#"+nodeId).append('<div class="selectedDiv"></div><div class="selected"></div>')
										$("#"+nodeId).removeClass("dojoDndHandle");
										$("#"+nodeId).find(".addApp").addClass("addApped").removeClass("addApp").text("已添加").css("background","#5fb000");

										//执行用户应用排序
										topic.publish("modulemanager/sort",source,iscopy,target);
									},function(error){
										//检查用户是否登录
										if(isLogin()){
											Spolo.notify({
												"text" : "添加应用失败！",
												"type" : "error",
												"timeout" : 1000
											});
										}
									});
								}, function(){
									//删除当前新添加应用
									userApp.deleteSelectedNodes();
									Spolo.notify({
										"text" : "获取系统应用配置信息失败！添加应用未成功！",
										"type" : "error",
										"timeout" : 1000
									});
								});
							}
						}else{
							//检查用户是否登录
							if(isLogin()){
								//执行用户应用排序
								topic.publish("modulemanager/sort",source,iscopy,target);
							}
						}
					});
					
					//拖放动作取消、结束时触发的函数
					function highlightTargets(show, source, nodes){  
						if(currentApp == 1){
							currentApp = 0;
							//触发悬停的系统应用进入事件
							secondaryApp ? $("#"+secondaryApp+" .mainDiv").trigger("mouseenter") : null;
						}
					}  
					/**
					*注册取消、结束事件，拖拽动作取消、结束时触发
					*/
					topic.subscribe("/dnd/cancel, /dnd/drop", lang.partial(highlightTargets, false));  
					
					/**
					*注册开始事件，当拖放动作开始时触发
					*/
					topic.subscribe("/dnd/start",function(source,nodes,iscopy){ 
						currentApp = 1;
					});
					
					/**
					*用户应用删除按钮处理事件
					*/
					$(".userDiv .buttonComm,#userListApp .delApp").live("click",function(){
						//获取用户应用中选中应用
						var userSelect = userApp.selection;
						var thisBtn = $(this).attr("class");
						for(var node in userSelect){
							var url = query("#"+node).attr("url").toString();
							users.deleteModule(url,function(){
								if(thisBtn == "buttonComm"){
									//执行动画隐藏
									$("#"+node).hide(500,function(){//fadeOut
										//删除选中应用
										//userApp.deleteSelectedNodes(); //该方法处理较慢，执删除过快会出现问题
										$("#"+node).remove();
										
										//恢复系统应用选择状态
										$(".selectedDiv,.selected","."+url).remove();
										$("."+url).addClass("dojoDndHandle");
										$("."+url).find(".addApped").text("添加").removeClass("addApped").addClass("addApp").css("background","#5080d8");
											
										//用户应用列表是否存在应用
										if(userApp.getAllNodes().length == 0){
											domConstruct.create("div",
											{
												className:"userMsg",
												style:{
													"position": "absolute",
													"left": "35px",
													"top": "30px",
													"z-index": "-1",
													"color": "#D4D4D4",
													"font-size": "35px",
													"font-weight": "bold"
												},
												innerHTML:"您当前的应用面板为空！"
											},dom.byId("sp_top"));
										}
									});
								}else{
									//执行动画隐藏
									$("#"+node).slideUp(500,function(){
										//删除选中应用
										$("#"+node).remove();
										
										//用户应用列表是否存在应用
										if(userApp.getAllNodes().length == 0){
											//删除用户应用Dnd容器
											$("#userListApp").remove();
											domConstruct.create("div",
											{
												className:"userListMsg",
												innerHTML:"您尚未添加任何应用。</br><a class='goAppManager' href='javascript:void(0)'>返回到 Glue 应用管理</a>"
											},dom.byId("appList"));
										}
									});
								}
							},function(){
								//检查用户是否登录
								if(isLogin()){
									Spolo.notify({
										"text" : "删除失败！",
										"type" : "error",
										"timeout" : 1000
									});
								}
							});
						}
					});

					/**
					*系统应用添加按钮处理事件
					*/
					$(".mainDiv .addApp").live("click",function(){
						//当前按钮
						var addAppButon = this;
						//初始化状态位置
						var num = userApp.getAllNodes().length;
						//获取当前点击的系统应用
						var currentSysAppId = $(this).parents(".moduleItem").attr("id");
						var currentSysAppDate = sysApp.map[currentSysAppId].data;
						var url = currentSysAppDate.url;
						//是否存在该系统应用的配置信息
						modules.hasModuleConfig(url, function(){
							//获取系统应用配置信息
							modules.getDefaultConfig(url,function(configJson){
								//添加应用至用户列表
								users.addModule({
									moduleName : url,
									index : num,
									defaultConfig : configJson
								},function(){
									//将其添加至用户容器
									userApp.insertNodes(false, [{
										"name": currentSysAppDate.name,
										"description": currentSysAppDate.description,
										"url": currentSysAppDate.url,
										"icon": currentSysAppDate.icon
									}]);  
									
									//删除容器提示
									$("#sp_top .userMsg") ? $("#sp_top .userMsg").remove() : null;
									
									//修改实体样式，删除拖放柄。可实现多个修改
									$(".mainDiv","#"+currentSysAppId).append('<div class="selectedDiv"></div><div class="selected"></div>')
									query("#"+currentSysAppId).removeClass("dojoDndHandle");
									$(addAppButon).addClass("addApped").removeClass("addApp").text("已添加").css("background","#5fb000");
								},function(error){
									//检查用户是否登录
									if(isLogin()){
										Spolo.notify({
											"text" : "添加应用失败！",
											"type" : "error",
											"timeout" : 1000
										});
									}
								});
							},function(){
								//删除当前新添加应用
								userApp.deleteSelectedNodes();
								Spolo.notify({
									"text" : "获取系统应用配置信息失败，添加应用未成功！",
									"type" : "error",
									"timeout" : 1000
								});
							});
						}, function(){
							//console.log("不存该系统应用的配置信息");
							//添加应用至用户列表
							users.addModule({
								moduleName : url,
								index : num
							},function(){
								//将其添加至用户容器
								userApp.insertNodes(false, [{
									"name": currentSysAppDate.name,
									"description": currentSysAppDate.description,
									"url": currentSysAppDate.url,
									"icon": currentSysAppDate.icon
								}]);  
								
								//删除容器提示
								$("#sp_top .userMsg") ? $("#sp_top .userMsg").remove() : null;
								
								//修改实体样式，删除拖放柄。可实现多个修改
								$(".mainDiv","#"+currentSysAppId).append('<div class="selectedDiv"></div><div class="selected"></div>')
								query("#"+currentSysAppId).removeClass("dojoDndHandle");
								$(addAppButon).addClass("addApped").removeClass("addApp").text("已添加").css("background","#5fb000");
							},function(error){
								//检查用户是否登录
								if(isLogin()){
									Spolo.notify({
										"text" : "添加应用失败！",
										"type" : "error",
										"timeout" : 1000
									});
								}
							});
						}, function(){
							//删除当前新添加应用
							userApp.deleteSelectedNodes();
							Spolo.notify({
								"text" : "获取系统应用配置信息失败！添加应用未成功！",
								"type" : "error",
								"timeout" : 1000
							});
						});		
					});
					/**
					* 订阅创建、装载用户应用容器完毕
					*/
					topic.subscribe("modulemanager/createUserAppEnd",function(userDatas){
						//添加关联样式
						for(var i = 0; i < userDatas.length; i++){
							$(".mainDiv","."+userDatas[i].url).append('<div class="selectedDiv"></div><div class="selected"></div>');
							$("."+userDatas[i].url).removeClass("dojoDndHandle");
							$("."+userDatas[i].url).find(".addApp").addClass("addApped").removeClass("addApp").text("已添加").css("background","#5fb000");
						}
					});
					/**
					* 订阅用户应用数据获取完毕
					*/
					topic.subscribe("modulemanager/readyUserDataEnd",function(userDatas){
						//实例化用户应用容器
						userApp = new Source("userApp",{creator: userModulesCreator, horizontal: true, singular:true, copyOnly: false, withHandles: true });
						//获取应用失败或是用户不存在应用
						if(!userDatas || userDatas.length == 0){
							domConstruct.create("div",
								{
									className:"userMsg",
									style:{
										"position": "absolute",
										"left": "35px",
										"top": "30px",
										"z-index": "-1",
										"color": "#D4D4D4",
										"font-size": "35px",
										"font-weight": "bold"
									},
									innerHTML:"您当前的应用面板为空！"
								},dom.byId("sp_top"));
						}else{
							//装载用户应用容器数据
							userApp.insertNodes(false, userDatas);  
							
							//发布创建、装载用户应用容器完毕消息
							topic.publish("modulemanager/createUserAppEnd",userDatas);
						}
					});
						
					/**
					* 订阅从服务器获取用户应用数据
					*/
					topic.subscribe("modulemanager/readyUserData",function(listName){
						var userDatas = [];  
						users.getModules(sysAppJson,function(usetAppItem){
							for(var i in usetAppItem){
								var module = usetAppItem[i];
								//用户应用数据
								userDatas[i] = {
									"name": module.resourceName || module.name,
									"description": module.description || "",
									"url": module.url || "",
									"icon": "/modules/"+module.url+"/images/icon.png"
								};
							}
							//过滤值为undefined的数组项
							for(var j = 0; j < userDatas.length; j++){
								if(userDatas[j] == undefined){
									userDatas.splice(j,1);
									--j;
								}
							}
							//判断为何处获取用户应用数据
							if(listName == "userListAppData"){//用户应用列表	
								//组装数据
								userListAppData = userDatas;
							}else{//应用管理页面面板
								//发布用户应用数据获取完毕消息
								topic.publish("modulemanager/readyUserDataEnd",userDatas);
							}
						},function(error){
							//判断为何处获取用户应用数据
							if(listName == "userListAppData"){//用户应用列表	
								userListAppData = "";
							}else{//应用管理页面面板
								//发布用户应用数据获取完毕（失败）消息
								topic.publish("modulemanager/readyUserDataEnd");
							}
						});
					});
					
					/**
					* 订阅显示系统应用
					*/
					topic.subscribe("modulemanager/dispaySysApp",function(){
						//添加延迟
						setTimeout(function(){
							//显示系统应用
							query(".moduleItem").style("display","block");
						},200);
					});
					/**
					* 订阅创建、装载系统应用容器完毕
					*/
					topic.subscribe("modulemanager/createSysAppEnd",function(){
						//修改提示
						$("#sp_pane .prompt").html("<font color='#da573b'>提示：</font>您可以通过拖放或点击添加按钮的方式，将您喜欢的应用添加至下面的应用面板中。应用面板支持对应用的拖放式排序、删除功能。");
						
						//为系统应用列表添加瀑布流效果
						var $container = $('#sysApp');
						$container.imagesLoaded(function(){
						  $container.masonry({
							itemSelector : '.moduleItem',
							columnWidth : 30
						  });
						});
						
						//发布显示系统应用消息
						topic.publish("modulemanager/dispaySysApp");
						
						$("#sysApp .mainDiv").mouseenter(function(){
							//记录次要的当前应用
							secondaryApp = $(this).parent().attr("id");
							//当前是否处于拖放状态
							if(currentApp != 1){
								//记录当前应用
								currentApp = $(this).parent().attr("id");
								var thisApp = this;
								//添加延迟
								setTimeout(function(){
									//具体的当前应用
									var app = $(thisApp).parent().attr("id");
									//当前应用跟之前记录应用是否匹配
									if(currentApp === app){
										$(".out",thisApp).stop().animate({'top':'-130px'},300); 
										$(".over",thisApp).stop().animate({'top':'0px'},300);
									}
								},300);	
							}
						});
						$("#sysApp .mainDiv").mouseleave(function(){
							//当前是否处于拖放状态
							if(currentApp != 1){
								//清空当前记录的应用
								currentApp = "";
							}
							//清空记录的次要当前应用
							secondaryApp = "";
							$(".out",this).stop().animate({'top':'0px'},300);
							$(".over",this).stop().animate({'top':'130px'},300);
						});
						
						//发布从服务器获取用户应用数据消息（应用管理页面面板）
						topic.publish("modulemanager/readyUserData","userDatas");
					});
					/**
					* 订阅系统应用数据获取完毕
					*/
					topic.subscribe("modulemanager/readySysDataEnd",function(sysDatas){
						//创建系统应用容器
						sysApp = new Source("sysApp",{creator: systemModulesCreator, singular:true, horizontal: true, copyOnly: true, withHandles: true, accept : [ "inStock"]});
						//装载系统应用容器数据
						sysApp.insertNodes(false, sysDatas);  
						
						//发布创建、装载系统应用容器完毕消息
						topic.publish("modulemanager/createSysAppEnd");
					});
					
					/**
					* 订阅从服务器获取系统应用数据
					*/
					topic.subscribe("modulemanager/readySysData",function(){
						var sysDatas = [];  
						modules.getSysModules(function(moduleItem){
							//存储系统应用json数据
							sysAppJson = moduleItem;
							for(var i in moduleItem){
								var module = moduleItem[i];
								if(module.isActive){
									//系统应用数据
									sysDatas.push({
										"name": module.resourceName || module.name,
										"description": module.description || "",
										"url": i,
										"icon": "/modules/"+i+"/images/icon.png"
									});
								}
							}
							//发布系统应用数据获取完毕消息
							topic.publish("modulemanager/readySysDataEnd",sysDatas);
						},function(error){
							//发布系统应用数据获取完毕消息
							topic.publish("modulemanager/readySysDataEnd",sysDatas);
							Spolo.notify({
								"text" : "系统应用数据获取失败",
								"type" : "error",
								"timeout" : 1000
							});
						});	
					});
					
					//发布从服务器获取系统应用数据消息
					topic.publish("modulemanager/readySysData");
					
					/**
					*订阅构造用户应用列表数据填充至相关容器中
					*/
					topic.subscribe("modulemanager/userList",function(appList){
						//覆盖原有用户应用容器
						userApp = new Source("userListApp",{creator: userLIsthModulesCreator, singular:true, copyOnly: true, withHandles: true, accept : [ "inStock"]});
						//装载用户应用容器数据
						userApp.insertNodes(false, userListAppData);  
					});
					
					//页面左侧导航
					$("#sp_left .mainList li,.userListMsg .goAppManager").live("click",function(){
						//清除所有的选中状态
						$("#sp_left .mainList li").removeClass("openNav");	
						//当前导航
						var currentClass = $(this).attr("class");
						if(currentClass == "goAppManager"){
							currentClass = "appManager";
						}
						//取消对首页设置选中样式
						if(currentClass != "goHome"){
							//设置选中样式
							$("."+currentClass).addClass("openNav");
						}
						switch(currentClass){
							//首页
							case "goHome":{
								window.location.href =("/index.html");
							break;
							}
							//应用管理
							case "appManager":{
								//移除相关容器
								//$("#appList","#sp_main").remove();
								if(query("#appList").length != 0){
									dijit.byId("appList").destroy();
								}
								
								//设置用户应用列表为空。
								userListAppData = undefined;
					
								//获取主容器widget对象
								var sp_main = dijit.byId("sp_main");
								//创建用户应用面板容器
								var sp_top = new ContentPane({
									id: "sp_top",
									region: "top",
									content: "<div id='userApp'></div>"
								});
								//将用户应用面板容器添加至主容器中
								sp_main.addChild(sp_top);
								
								//创建系统应用列表容器
								var sp_content = new ContentPane({
									id: "sp_content",
									region: "center",
									content: "<div id='sysApp'></div>"
								});	
								//将用户应用面板容器添加至主容器中
								sp_main.addChild(sp_content);
								
								//发布从服务器获取系统应用数据消息
								topic.publish("modulemanager/readySysData");
							break;
							}
							//您的应用
							case "youApp":{
								//移除相关容器
								//$("#sp_top,#sp_content","#sp_main").remove();
								if(query("#sp_top").length != 0){
									dijit.byId("sp_top").destroy();
								}
								if(query("#sp_content").length != 0){
									dijit.byId("sp_content").destroy();
								}
								
								//修改提示
								$("#sp_pane .prompt").text("管理您的应用，目前该列表支持对应用的删除与拖放式排序。");
								
								//创建应用列表容器
								var appList = new ContentPane({
									id: "appList",
									region: "top"
								});
								//获取主容器widget对象
								var sp_main = dijit.byId("sp_main");
								
								//将应用列表容器添加至主容器中
								sp_main.addChild(appList);
								
								//发布从服务器获取用户应用数据消息（应用管理页面面板）
								topic.publish("modulemanager/readyUserData","userListAppData");
								
								//检查数据是否获取完毕
								var myInterval = setInterval(function(){
									if(userListAppData == undefined){
										appList.set("content","<div class='userListMsg'>正在努力为您加载，请稍候...</div>");
									}else if(userListAppData.length == 0){
										//停止检查
										clearInterval(myInterval);
										appList.set("content","<div class='userListMsg'>您尚未添加任何应用。</br><a class='goAppManager' href='javascript:void(0)'>返回到 Glue 应用管理</a></div>");
									}else if(userListAppData == ""){
										clearInterval(myInterval);
										appList.set("content","<div class='userListMsg'>从服务器获取用户应用失败！</div>");
									}else{
										clearInterval(myInterval);
										appList.set("content","<ul id='userListApp'></ul>");
										//发出构造用户应用列表数据填充至相关容器中的消息
										topic.publish("modulemanager/userList",appList);
									}	
								},100);	
							break;
							}
						}
					});
				});
			});
		</script>
	</head>
	<body class="claro">
		<div id="sp_main" dojoType="dijit.layout.BorderContainer" 
			design="sidebar" gutters=false>
			<div id="sp_left" dojoType="dijit.layout.ContentPane" region="left">
				<ul class="mainList">
					<li class="goHome"><a href="javascript:void(0)">首页</a></li>
					<li class="appManager openNav"><a href="javascript:void(0)">应用管理</a></li>
					<li class="youApp"><a href="javascript:void(0)">您的应用</a></li>
				</ul>
				<div id="appCategory" style="height:60px;overflow:hidden;"> 
				</div>
			</div>
			<div id="sp_pane" dojoType="dijit.layout.ContentPane" region="top">
				<div class="prompt"></div>
				<a class="sysSetup" href="/modules/modulemanager/config.html"></a> 
				<a class="userName" href="javascript:void(0);"></a>
			</div>
			<div id="sp_top" dojoType="dijit.layout.ContentPane" region="top">
				<div id="userApp"></div>
			</div>
			<div id="sp_content" dojoType="dijit.layout.ContentPane" region="center">
				<div id="sysApp"></div>
			</div>
		</div>
	</body>
</html>