<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>
            从公共模型库添加模型
        </title>
		<script type="text/javascript" >
			dojoConfig = {
				parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
        
        <style type="text/css">
			@charset "utf-8"; 
            #bt{
                -webkit-border-radius: 5px;
                border-radius: 5px;
                -webkit-box-shadow: 1px 1px 6px 2px rgba(0, 0, 0, 0.3);
                box-shadow: 1px 1px 6px 2px rgba(0, 0, 0, 0.3);
                display: block;
                width: 100px;
                line-height: 1.2;
                padding: 1px 3px 1px 3px;
                color: rgb(122, 218, 18);
                background-color: #AAA;
                font-weight: bold;
                text-align: center;
                position: fixed;
                left: 20px;
                top: 10px;
                cursor: pointer;
                opacity: 1;
                filter: Alpha(opacity=40);
                z-index: 100;
            }
            #dialog_placeAt{
                width: 300px;
                height:300px;
                line-height: 1.2;
                padding: 8px;
                color: rgb(255, 255, 255);
                font-size: 12px;
                position: fixed;
                left: 500px;
                bottom: 200px;
                cursor: pointer;
                opacity: .8;
                filter: Alpha(opacity=80);
                z-index:2;
            }
		</style>
		
        <script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
        <script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/addmodelfrompublicmodellib.css" media="screen" />
		<link rel="stylesheet" href="/widgets/ModelListItem/css/main.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/Category/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/List/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/ModelEdit/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/ModelLib/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Toolbar/css/main.css" media="screen">
    </head>
    <body class="claro">
		<div id="publicmodellibContent" dojoType="dijit.layout.BorderContainer" gutters=false>
			
            <div id="bt">
                <p>打开选中模型</p> 
            </div>

			<div id="publicModelLibs" dojoType="dijit.layout.ContentPane" region="center">
				
			</div>
		</div>
	<script type="text/javascript">
		
		require(
			[
				"dojo/parser","dojo/ready","dojo/dom","dojo/dom-style","dojo/on",
				"dojo/_base/array",	"dojo/query","widgets/ModelListItem/ModelListItem",
				"dojox/NodeList/delegate","widgets/Category/Category",
				"dijit/form/Button","dijit/registry","widgets/Pagination/Pagination",
				"widgets/Mask/Mask","dijit/layout/BorderContainer", "dijit/layout/ContentPane",
				"dijit/layout/TabContainer","spolo/data/model", "widgets/ModelLib/ModelLib","dojo/cookie"
				
			],function(
				parser, ready, dom, domStyle, on, 
				arrayUtil, query, ModelListItem,delegate,Category,Buttton,registry,Pagination,Mask,
				BorderContainer,ContentPane,TabContainer, model, ModelLib, cookie
			){
				ready(function(){
					var varsMap = Spolo.getUrlVars();
					var isGutil = varsMap ['isGutil'];
					if(isGutil == "true"){
						dom.byId("bt").value = "打开选中模型";
					}
					else{
						dom.byId("bt").value = "添加选中模型";
					}
					
					//获取父级页面的 scene 对象
					this.scene = this.parent.scene;
					var scene = this.scene;
					var iframe = this.parent.iframe;
					var uid = Spolo.getUserId();
					var publicLibPath = "/content/shmodellib";
					initLib();
					//初始化模型库
					function initLib(){
						var publicCurrentPage = cookie("publicCurrentPage");
						if(!publicCurrentPage){
							publicCurrentPage = 1;
						}
						var publicJSON = 
						{
							path: publicLibPath,
							limit: 10,
							queryString: "[@sling:resourceType='model']",
							hasCategory:true,
							selectedModules:true,
							currentPage:publicCurrentPage,
							isClickImg:true,
							showEditOrPreview:true,
							numberSpinner:true,
							showLookPreview:false
						};
						var publicModelLib = new ModelLib(publicJSON);
						publicModelLib.placeAt("publicModelLibs");
						publicModelLib.hideButton();
						//添加所有选中模型
						on(dom.byId("bt"),"click", function(){
							var publicSelected = publicModelLib.getAllPageSelected();
							cookie("publicCurrentPage",publicModelLib.getCurrentPage());
							if(publicSelected.length){
								Mask.show();
								addModelsToCurrentScene(publicLibPath,publicSelected);
								if(isGutil != "true"){
									scene.saveItems(success, error);
								}
							}
							else
							{
								Spolo.notify({
									text : '请选择模型!!',
									type : 'error',
									timeout : 1000
								});
							}
						});
					}
					
					//遍历当前所有选中的模型，并且添加到场景中
					function addModelsToCurrentScene(path,data){
						if(data){
							if(isGutil == "true"){
								var pathArray = new Array();
								for(var key = 0; key < data.length ;key++){
									pathArray.push(path + "/" + data[key]["nodeName"]);
									pathArray.push(data[key]["addNumber"]);
								}
								scene.addItemsByCount(pathArray, success);
							}
							else{
								for(var key = 0; key < data.length ;key++){
									var name = data[key]["resourceName"];
									var referModel = path + "/" + data[key]["nodeName"];
									var ID = data[key]["ID"];
									var addNumber = data[key]["addNumber"];
									var json = {
										name:name,
										referModel:referModel,
										type:"MESH",
										ID:ID
									};
									scene.addItemsByCount(json,addNumber);
								}
							}
						}
					}
					function success(res)
					{
						Mask.hide();
						iframe.refreshEditItems();
						Spolo.notify({
							text : "添加模型成功!!",
							type : "success",
							timeout : 1000
						});
					}
					function error(res)
					{
						Mask.hide();
						Spolo.notify({
							text : "添加模型失败!!",
							type : "error",
							timeout : 1000
						});
					}
				});
				
			});
	</script>	
    </body>
</html>