<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>
            场景详细信息
        </title>

		<script type="text/javascript" >
			dojoConfig = {
				//parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "scenedetail",
						location: "/modules/scenedetail"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
		
        <script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
        <script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/update.css" media="screen" />
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
    </head>
    
    <body class="claro">
		<div class="all">
			<div class="updateScene">
				<div id="updatalocation">●&nbsp;&nbsp;更新场景中的模型位置</div>
				<!-- 让用户先学习blender插件下载地址及安装说明 -->
				<div class="box stu_blender">
					<div class="stepstitle">
						<span>如果您是第一次新建场景，请先认真阅读：</span>
					</div>
					<div class="up_hp">
						<a href="/modules/scenedetail/html/blender_export/index.html" target="_blank">blender插件下载地址及安装说明</a>
					</div>
				</div>
				<!-- 选择文件， -->
				<div class="box bt">
					<div class="stepstitle">
						<span>准备好blender所导出的json文件，点击选择场景文件选择一个json文件。</span>
					</div>
					<div role="button" class="selectFile" tabindex="0" onclick="document.getElementById('hd_file').click()" style="-webkit-user-select: none;">选择场景文件</div>
					<form id="hd_form" action="" method="POST" enctype="multipart/form-data">
						<input id="hd_file" name="场景文件" type="file" style="height: 0px; display: none;">
					</form>
				</div>
				<!-- 文件格式，大小，进度条，取消等效果和功能 -->
				<div class="box sceneFileReady">
					<div class="stepstitle">
						<span>选择好文件，点击下面的更新开始更新。</span>
					</div>
					<table class="singleTable">
						<tbody class="singleBody">
							<tr class="singleTr">
								<td class="name">
									<span>场景文件.json</span>
								</td>
								<td class="size">
									<span>文件大小</span>
								</td>
								<td class="progress">
									<div data-dojo-type="dijit.ProgressBar" style="width:300px"
									data-dojo-id="myProgressBar" id="downloadProgress" data-dojo-props="maximum:10"></div>
								</td>
								<td class="start">
									<button class="up btn">
										<span class="icon_upload"></span>
										<span>更新</span>
									</button>
								</td>
								<td class="cancel">
									<button class="cc btn">
										<span class="icon_cancel"></span>
										<span>取消</span>
									</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="updateScene">
				<div id="update">
					●&nbsp;&nbsp;更新模型和材质修改后的场景信息
				</div>
				<div class="box bt">
					<div class="stepstitle">
						<span>选择修改并打包好的场景文件进行上传</span>
					</div>
					<div role="button" class="selectFile" tabindex="0" onclick="document.getElementById('update_file').click()" style="-webkit-user-select: none;">选择场景</div>
					<div role="button" class="selectFile" tabindex="0" style="margin-left:400px;" id="uploadScene">上传场景</div>
					<form id="update_form" action="" method="POST" enctype="multipart/form-data">
						<input id="update_file" name="场景文件" type="file" style="height: 0px; display: none;">
					</form>
				</div>
			</div>
		</div>	
	<script type="text/javascript">
		require(
			[
				"dojo/parser","dojo/ready","dojo/dom","dojo/dom-style","dijit/ProgressBar", "dojo/query", "dojo/on","spolo/data/scene","widgets/Mask/Mask"
				
			],function(
				parser, ready, dom, domStyle,ProgressBar,query,on,scene_cls,Mask
			){
				ready(function(){
					// 获取父级页面的 scene 对象
					this.scene = this.parent.scene;
					var sceneObj = this.scene;
					var scenePath = sceneObj.getURI();
					var updateScene = new scene_cls(scenePath);
					//监听input file组件的onchange事件
					on(dom.byId("hd_file"),"change",function(evt){
						//设置进度条为0
						setProgress(0);
						//判断用户选择的文件是否符合标准
						//var validate = 
						if(this.files&&this.files[0]){
							var sceneJsonFile = this.files[0];
							var fileName = sceneJsonFile.name;
							//设置文件名称
							setUpdateFileName(fileName);
							//文件大小
							var fileSize = sceneJsonFile.size;
							var unitSize = fileSize;
							var unit = "BYTE";
							//通过计算确定此文件大小的合适输出
							//文件大于1byte则以byte计量
							if(fileSize<1024){
								unit = "BYTE"
							}
							//文件大于1kKB则以kb计量
							if(1024<=fileSize && fileSize<(1024*1024)){
								unitSize = Math.floor(fileSize/1024 * 100) / 100;
								unit = "KB"
							}
							//文件大于1MB则以mb计量
							if((1024*1024)<=fileSize && fileSize<(1024*1024*1024)){
								unitSize = Math.floor(fileSize/(1024*1024) * 100) / 100;
								unit = "MB"
							}
							//文件大于1GB则以GB计量
							if((1024*1024*1024)<=fileSize && fileSize<(1024*1024*1024*1024)){
								unitSize = Math.floor(fileSize/(1024*1024*1024) * 100) / 100;
								unit = "GB"
							}
							setUpdateFileSize(unitSize+" "+unit);
						}
					})
					//监听更新的点击事件
					on(query(".up"),"click",function(){
						//设置进度条为0
						setProgress(0);
						//判断文件是否就绪，非空和格式等是否正确
						var formId = "hd_form";
						//s.updateByJSON(formId,{
						updateScene.updateByJSON(formId,{
							load:function(data){
								setProgress(100);
								setTimeout(function(){
									Spolo.notify({
										text : '更新成功!!',
										type : 'success',
										timeout : 1000
									});
								},1000);
							},
							error:function(err){
								Spolo.notify({
									text : '更新失败!!\n' + err,
									type : 'error',
									timeout : 1000
								});
							}
						});
					});
					//监听取消的点击事件
					on(query(".cc"),"click",function(){
					
					})
					parser.parse();
				
					function validateForm(formid){
						var validate = true;
						//判断文件是否符合标准
					}
					function setProgress(point){
						dijit.byId("downloadProgress").set({value: point});
					}
					function setUpdateFileName(fileName){
						query(".singleTr .name span")[0].innerHTML = fileName;
					}
					function setUpdateFileSize(fileSize){
						query(".singleTr .size span")[0].innerHTML = fileSize;
					}
					
					//更新场景信息
					on(dom.byId("uploadScene"),"click",function(){
						var value = dom.byId("update_file").value;
						if(value == "")
						{
							Spolo.notify({
								text : '请选择场景文件!!',
								type : 'error',
								timeout : 1000
							});
						}
						else
						{
							Mask.show();
							updatescene.call(this);
						}
					});
					
					//更新场景
					function updatescene(){
						var newScene = new scene_cls(scenePath);
						newScene.updataScene("update_form",{
							resumable : true,
							notifier : function(msg){
								console.log(msg);
							},
							load : function(data){
								if(data.suc)
								{
									Mask.hide();
									Spolo.notify({
										text : '上传成功!!',
										type : 'success',
										timeout : 1000
									});
									
								}
								else
								{
									Spolo.notify({
										text : '上传失败!!',
										type : 'error',
										timeout : 1000
									});
								}
							},
							error : function(err){
								console.log(err);
							}
						});
					}
				});
			}
		);
	</script>	
    </body>
</html>