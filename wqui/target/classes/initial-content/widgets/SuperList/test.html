<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<title>Glue</title>
		
		<script type="text/javascript">
			var dojoConfig = {
				parseOnLoad: true, 
				packages:[
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name:"spolo",
						location:"/script/spolo"
					}
					
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<!-- 注意除需引入自身组件样式外，还需要分别引入List、分页组件的样式 -->
		<link rel="stylesheet" href="/widgets/List/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		<link rel="stylesheet" href="css/main.css" media="screen">
		<!-- end -->
		<style type="text/css">
			html,body{
				width:100%;
				height:100%;
				padding:0px;
				margin:0px;
				overflow:hidden;
			}
			#testContainer{
				width:1000px;
				height:100%;
				border:1px solid #d1d1d1;
				margin: 0 auto;
			}
		</style>
	</head>
	<div id="testContainer"></div>
	<body class="claro">
		<script>
			require(
				[
					"widgets/SuperList/SuperList",
					"dojo/on",
					"spolo/data/queryClass"
				],
				function(SuperList, on, queryClass){
					var superList = new SuperList();
					superList.placeAt("testContainer");
					
					/**
					* 初始化List控件的数据
					*/
					function initListWidgetData(){
						var dthis = this;
						var currentPage = this.listWidget.currentPage; // 当前页码
						var limit = 10; // 每页显示个数
						var path = "/content/users/"+Spolo.getUserId()+"/previewlib";
						queryClass.query({
							nodePath : path,
							orderDesc : "jcr:created",
							limit : limit ,
							offset : ((currentPage - 1) * limit),
							load : function(data){
								// 仅在初始化时执行一次
								if(!dthis.init){
									//刷新分页
									var total = data["totalNum"];
									dthis.paginationWidget.refresh(Math.ceil(total/limit));
								}
							
								//加载 list 数据
								initListWidget.call(dthis, data);
							},
							error : function(error){
								dthis.paginationWidget.refresh(1);
								throw error;
							}
						});
					}
					/**
					* 通过数据填充List实体
					*/
					function initListWidget(data){
						var dthis = this;
						var listw = this.listWidget;
						var listData = data["data"];
						var array = new Array();
						for(var key in listData){
							array.push(key);
						}
						//加载listitem的结构
						listw.addItems(array,true);
						for(var i = 0; i < array.length; i++){
							var key = array[i];
							// 设置listitem中的图片
							var imgUrl = key.replace("previewlib","scenelib")
							listw.setItemImage(key,imgUrl+".preview");
							// 设置名称字段
							var name = listData[key]["resourceName"];
							// 添加名称字段
							listw.addDomNode(key,name);
						}
						
						//初始化完毕
						this.init = true;
					}
					
					// 分页事件消息
					var dthis = superList;
					dthis.paginationWidget.on("onClickPage",function(data){
						dthis.listWidget.currentPage = this.nowPage;
						// 只有初始化完毕后，才能执行分页查询数据
						if(dthis.init){
							initListWidgetData.call(dthis);
						}
					});
					
					// 执行初始化
					initListWidgetData.call(dthis);
					
					// 打开选择模式
					dthis.listWidget.openSelect();
				});
		</script>
	</body>
</html>