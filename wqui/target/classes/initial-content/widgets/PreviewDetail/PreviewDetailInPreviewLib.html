<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<title>Glue</title>
		
		<script type="text/javascript">
			var dojoConfig = {
				parseOnLoad: true, 
				packages:[
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name:"spolo",
						location:"/script/spolo"
					}
					
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<link rel="stylesheet" href="/widgets/List/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Toolbar/css/main.css" media="screen">
		<link rel="stylesheet" href="css/main.css" media="screen">
		<style type="text/css">
			html,body{
				height:100%;
				margin:0px;
				padding:0px;
			}
			#testContainer{
				width: 99%; 
				height: 99%;
				float:left;
				border:1px solid #d1d1d1;
			}
		</style>
	</head>
	
	<body class="claro">
		<div id="testContainer"></div>
		<script>
			require(
				[
					"widgets/PreviewDetail/PreviewDetailWidget",
					"dojo/on",
					"dojo/_base/array",
					"dojo/json",
					"dijit/Dialog",
					"spolo/data/spsession",
					"spolo/data/scene",
					"spolo/data/folder/favourite"
				],
				function
				(
				PreviewDetailWidget, on,arrayUtil,jsonUtil, Dialog,spsession, sceneClass,favourite
				)
				{	//这里还有问题，需要进行修改
					var data = Spolo.getDialogData();
					var iframe = data["iframe"];
					var scene = data["scene"];
					var isGutil = data["isGutil"];
					
					var numberSpinner = data["numberSpinner"];
					if(numberSpinner == undefined){
						numberSpinner = getParameter("numberSpinner");
					}
					if(numberSpinner!=true && numberSpinner!="true"){
						numberSpinner = false
					}
					
					var canAddModel = data["canAddModel"];
					if(canAddModel == undefined){
						canAddModel = getParameter("canAddModel");
					}
					var isnotclickmodel = data["isnotclickmodel"];
					if(isnotclickmodel == undefined){
						isnotclickmodel = false;
					}
					console.log(isnotclickmodel);
					if(canAddModel!=false && canAddModel!="false"){
						canAddModel = true;
					}
					var isRadio = data["isRadio"];
					if(isRadio == undefined){
						isRadio = getParameter("isRadio");
					}
					if(isRadio != true && isRadio != "true"){
						isRadio = false;
					}
					var isInsteadModel = data["isInsteadModel"];
					if(isInsteadModel == undefined){
						isInsteadModel = getParameter("isInsteadModel");
					}
					if(isInsteadModel!=true && isInsteadModel!="true"){
						isInsteadModel =  false;
					}
					var oldModel = data["oldModel"];
					if(oldModel == undefined){
						oldModel = getParameter("oldModel");
					}
					
					var scenepath = data["path"];
					if(scenepath == undefined){
						scenepath = getParameter("path");
					}
					
					var json = {
						scene : scene,
						path : scenepath,
						canAddModel : canAddModel,
						numberSpinner : numberSpinner,
						isInsteadModel : isInsteadModel,
						oldModel : oldModel,
						isRadio : isRadio,
						iframe : iframe,
						isnotclickmodel : isnotclickmodel,
						isGutil : isGutil
					}
					var pdw = new PreviewDetailWidget(json);
					console.log(json+"  inpreviewlib");
					pdw.placeAt("testContainer");
					isFavPreview.call(this,
						scenepath,
						function(isFav){
							if(isFav){
								pdw.setFavoredPreview();
							}
							else{
								pdw.setFavorPreview();
							}
						}
					);
					pdw.on("onAddModelSuccess",function(){
						var func = iframe.refreshEditItems;
						if(func){
							func();
						}
					});
					//获取该效果图是否已经收藏
					function isFavPreview(path,callback){
						favourite.isFavPreview(
							path,
							function(isFav){
								callback(isFav);
							},
							function(error){
								console.log("error"+ error);
							}
						);
					}
					//根据参数名，获取值
					function getParameter(param){
						var value = "";
						var paramSearch = param+"=";
						var paramStr = location.search;
						var decode_paramStr = decodeURIComponent(paramStr).substring(1);
						var paramsArr = new Array();
						if(decode_paramStr.search(/&/)!=-1){
							paramsArr = decode_paramStr.split("&");
						}
						if(paramsArr[0]){
							arrayUtil.forEach(paramsArr,function(item,i){
								if(item.indexOf(param+"=")!=-1){
									value = item.substr(item.indexOf(param+"=")+paramSearch.length);
								}
							});
						}else{
							value = decode_paramStr.substr(decode_paramStr.indexOf(param+"=")+paramSearch.length);
						}
						return value;
						
					}
				});
		</script>
	</body>
</html>