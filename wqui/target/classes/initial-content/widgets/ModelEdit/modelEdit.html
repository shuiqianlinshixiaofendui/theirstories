<!DOCTYPE html>
<html>
	<head>
		<title>模型属性编辑</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<link href="/libs/dijit/themes/claro/claro.css" rel="stylesheet">
		<link rel="stylesheet" href="/widgets/Category/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/ModelEdit/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
		<script type="text/javascript">
			var dojoConfig = 
			{
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<style type="text/css">
			html,body
			{
				height:120%;
				width:100%;
				margin:0px;
				padding:0px;
				border:none;
				overflow:auto;
			}
		</style>
	</head>
	<body class="claro">
		<div id="ModelLibContainer"></div>
		<script>
			require(
			[
				"widgets/ModelEdit/ModelEdit",
				"dojo/on","dojo/_base/array", 
				"spolo/data/model","spolo/data/user",
				"spolo/data/folder/favourite","dojo/domReady!"
			],
			function( ModelEdit,on,arrayUtil,model,user,favourite ){
				
				// 演示了 spdialog 中向外部发事件.
				// Spolo.dialogEmit("testEmit","123123");
				// 演示了 spdialog 中隐藏窗口.
				// setTimeout(function(){
					// Spolo.dialogHide();
				// },5000);
				// 演示了获取 spdialog 外部传入的参数
				// console.log(Spolo.getDialogData());
				
				// 测试的时候请替换成自己本地的model节点
				var userName = Spolo.getUserId();
				var nodePath = "/content/modellib";
				var path = getParameter("modelPath");
				var data = Spolo.getDialogData();
				if(data["list"]){
					var list = data["list"];
				}
				if(data["modellistitem"]){
					var modellistitem = data["modellistitem"];
				}
				if(data["showAddItemsModelLib"] != undefined){
					var showAddItemsModelLib = data["showAddItemsModelLib"];
				}
				var json = {};
				var granted;
				if(modellistitem){//体现在二维场景中的编辑部分和模型列表部分
					granted = false;
					modeledit.call(this,granted);
				}
				else
				{
					if(showAddItemsModelLib)//个人模型库/我的效果图
					{
						granted = true;
						modeledit.call(this,granted);
					}
					else
					{//云端模型库/云端效果图
						userGranted.call(this,function(result){
							if(result == "False"){
								granted = false;//普通用户
							}
							else if(result == "True"){
								granted = true;//admin
							}
							modeledit.call(this,granted);
						});
					}
					
				}
				//判断模型是否已经收藏
				function isFavModel(path,callback){
					favourite.isFavModel(
						path,
						function(isFav){//返回的是boolean值
							callback(isFav);
						},
						function(error){
							console.log(error);
						}
					);
				}
				//模型属性编辑页面
				function modeledit(granted)
				{
					var json = 
					{
						path : path,
						granted:granted
					}
					var widget = new ModelEdit(json).placeAt("ModelLibContainer");
					isFavModel.call(this,
						path,
						function(isFav){
							if(isFav){
								widget.setFavoredModel();
							}
							else{
								widget.setFavorModel();
							}
						}
					);
					//widget.setFavModel();
					if(modellistitem || granted == false)
					{
						widget.setForbidEdit();
					}
					widget.on("onSelectStyle",function(data){
						
					});
					
					widget.on("onCancel",function(data){
						// widget.destory();
						Spolo.dialogHide();
					});
					
					widget.on("onSaveSuccess",function(data){
						Spolo.dialogHide();
					});
					
					widget.on("onSaveFailed",function(){
						Spolo.notify({
							"text" : "保存失败",
							"type" : "error",
							"timeout" : 1000
						});
					});
				}

				//判断用户的权限
				function userGranted(callback){
					user.isGranted(
						userName,
						nodePath,
						function(result)
						{
							callback(result);
							
						},
						function(error)
						{
							throw error;
						}
					);
				}
				
				//根据参数名，获取值
				function getParameter(param){
					var value = "";
					var paramSearch = param+"=";
					var paramStr = location.search;
					var decode_paramStr = decodeURIComponent(paramStr).substring(1);
					var paramsArr = new Array();
					if(decode_paramStr.search(/&/)!=-1){
						paramsArr = decode_paramStr.split("&");
					}
					if(paramsArr[0]){
						arrayUtil.forEach(paramsArr,function(item,i){
							if(item.indexOf(param+"=")!=-1){
								value = item.substr(item.indexOf(param+"=")+paramSearch.length);
							}
						});
					}else{
						value = decode_paramStr.substr(decode_paramStr.indexOf(param+"=")+paramSearch.length);
					}
					return value;
					
				}
				
			});
		</script>
	</body>
</html>