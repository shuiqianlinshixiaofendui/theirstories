<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title></title>

		<script type="text/javascript" >
			dojoConfig = {
				parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
        <script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
        <script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/modellist.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/ModelListItem/css/main.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/ModelEdit/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Category/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		
		<script type="text/javascript" src="/libs/x3dom/x3dom.js"></script> 
		<link rel="stylesheet" type="text/css" href="/libs/x3dom/x3dom.css" /> 
     
    </head>
    
    <body class="claro">
		<div id="modelcontent" dojoType="dijit.layout.BorderContainer">
			<div id="toolbar" dojoType="dijit.layout.ContentPane" region="top">
				<button id="btnSelectAll" data-dojo-type="dijit.form.Button">全选</button>
				<button id="btnUnSelect" data-dojo-type="dijit.form.Button">取消</button>
				<label id="firstLabel">&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;</label>
				<button id="btnPublish" data-dojo-type="dijit.form.Button">发布模型</button>
				<label id="secondeLabel">&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;</label>
				<button id="btnExportModelProperties" data-dojo-type="dijit.form.Button">导出模型属性</button>
				<button id="btnImportModelProperties" data-dojo-type="dijit.form.Button">导入模型属性</button>
				<label id="thridLabel">&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;</label>
				<button id="btnMergeModel" data-dojo-type="dijit.form.Button">合并相同模型</button>
				<button id="btnBatchModifyModel" data-dojo-type="dijit.form.Button">修改选中模型属性</button>
				<div id="totalModel" style="float:right;line-height:20px;">
					模型总数为：
				</div>
			</div>
			<div id="modelList" dojoType="dijit.layout.ContentPane" region="center">
				加载中，请稍等...
			</div>
			<div id="pager" dojoType="dijit.layout.ContentPane" region="bottom" style="height:36px;">
			</div>
		</div>
		<script type="text/javascript">
			require(
				[
					"dojo/parser","dojo/ready","dojo/dom","dojo/dom-style", "dojo/_base/array",
					"dojo/query", "dojo/on",
					"dijit/form/Button","dijit/layout/BorderContainer", "dijit/layout/ContentPane",
					"dijit/Dialog",	"widgets/ModelListItem/ModelListItem",
					"widgets/ModelEdit/ModelEdit","spolo/data/model",
					"spolo/data/folder","widgets/Mask/Mask","widgets/Pagination/Pagination","spolo/data/scene",
					"dijit/registry"
				],function(
					parser, ready, dom, domStyle, arrayUtil, 
					query, on, Button, BorderContainer, ContentPane, Dialog, 
					ModelListItem, ModelEdit,model_cls,folder_cls,Mask,Pagination,scene_cls, registry
				){
				
					var modelListWidgetArray = {};
					
					ready(function(){
						var isGutil = this.parent.isGutil;
						if(isGutil == "true"){
							registry.byId("btnExportModelProperties").domNode.style["display"] = "none";
							registry.byId("btnImportModelProperties").domNode.style["display"] = "none";
							registry.byId("btnMergeModel").domNode.style["display"] = "none";
							registry.byId("btnBatchModifyModel").domNode.style["display"] = "none";
							dom.byId("secondeLabel").style["display"] = "none";
							dom.byId("thridLabel").style["display"] = "none";
						}
							
						// 获取父级页面的 scene 对象
						this.scene = this.parent.scene;
						var scene = this.scene;
						var iframe = this.parent;
						// 动态创建控件
						var modelData;
						var modelPath;
						var selectedModels;
						var limit = 10;
						var currentPage = 1;
						var pathArray = {};
						var modelLocation = {};
						//初始化分页组件
						var json = 
						{
							total:0
						};
						var pagination = new Pagination(json).placeAt("pager");
						// 初始化模型列表
						initModellist.call(this,scene);
						function initModellist(scene)
						{
							scene.getStoredModelByQuery({
								"limit":limit,
								"offset":(currentPage - 1) * limit,
								"success":function(modelArray,totalNum)
								{
									dom.byId("modelList").innerHTML = "";
									arrayUtil.forEach(modelArray, function(item){
										modelPath = item["path"];
										var rName = item["resourceName"];
										var number;
										if(item["ref_count"]){
											number = item["ref_count"].split(".")[0];
										}
										else
										{
											number = 1;
										}
										modelData = 
										{
											name: rName,
											type: item["type"]!=undefined?item["type"]:"",
											path: modelPath,
											referModel: modelPath,
											canModify:true,
											number:number
										};
										var modelListItem = new ModelListItem(modelData).placeAt("modelList");
										modelListWidgetArray[modelPath] = modelListItem;
										// 设置模型的预览图
										setImage(modelPath,modelListItem);
										if(isGutil == "true"){
											modelListItem.set("checked",true);
										}
										// 监听item的属性编辑按钮点击事件
										var dthis = this;
										on(modelListItem, "onModify", function(node)
										{
											onModelListItemModify.call(dthis, node);
										});
										//监听item的查看3D效果的事件
										on(modelListItem,"onWeb3d",function(node)
										{
											onModelListItemModify.call(dthis, node);
										});
									});
									var totalPage = Math.ceil(totalNum / limit);
									pagination.refresh(totalPage,currentPage);
									
									// 临时放到这里：初始化模型的图片
									function setImage(path,widget)
									{
										model_cls.getPreviewByPath(
											path,
											function(url)
											{
												widget.set("image",url);
											},
											function(error)
											{
												console.log(error);
											}
										);
									}
									
									if(modelArray.length == 0)
									{
										dom.byId("modelList").innerHTML = "当前场景中没有模型...";
									}
									//统计当前模型个数
									dom.byId("totalModel").innerHTML="模型总数为："+totalNum;	
									
									//设置选中的模型状态,在对应的位置上设置模型选中
									var selectedArray = modelLocation[currentPage];//当前页的选中的位置数组
									setModelState.call(this,true,selectedArray);
								},
								"failed":function(err)
								{
									throw(err);
								}
							});
						}
						//监听分页事件
						pagination.watch
						(
							"nowPage", 
							function()
							{
								//这儿需要记录下选中模型的位置
								selectedModelPathPerPage.call(this);
								currentPage = pagination.get("nowPage");
								initModellist.call(this,scene);
							}
						);
						
						//缓冲每一页的选中的模型的路径
						function selectedModelPathPerPage()
						{
							var selectedModel = query("#modelList input:checked");
							pathArray[currentPage] = selectedModel;
							modelLocation[currentPage] = getModelLocation.call(this,selectedModel);
						}
						
						//得到选中的模型的长度
						function getSelectedModelLen()
						{
							var len = 0;
							for(var key in pathArray)
							{
								len += pathArray[key].length;
							}
							return len;
						}
						
						//得到选中的模型的位置
						function getModelLocation(model)
						{
							var array = [];
							for(var key = 0; key < model.length;key++)
							{
								var locObj = model[key].offsetTop;
								array.push(locObj);
							}
							return array;
						}
						
						//设置模型选中
						function setModelState(state,selectedArray){
							var models = query("#modelList input");
							if(selectedArray)
							{
								arrayUtil.forEach(models, function(input)
								{
									for(var i = 0; i < selectedArray.length;i++)
									{
										if(input.offsetTop == selectedArray[i])
										{
											input.checked = state;
										}
									}
								});
							}
						}
						
						//获取选中的模型的路径
						function getModelPath()
						{
							var array = [];
							for(var key in pathArray)
							{
								var selectedModel = pathArray[key];
								for(var i = 0;i < selectedModel.length;i++){
									var modelPath = selectedModel[i].alt;
									array.push(modelPath);
								}
							}
							return array;
						}
						
						// 发布窗口
						var uid = Spolo.getUserId();
						var privateLibPath = "/content/users/"+uid+"/modellib";
						var publicLibPath = "/content/modellib";
						var dialogContent = "<br />请选择发布位置:"+
								"<div id='publishTargets'>"+
									"<br /><br />"+
									"<input type='checkbox' value='"+privateLibPath+"' />个人模型库"+
									"<br /><br />"+
									"<input type='checkbox' value='"+publicLibPath+"' />公共模型库"+
								"</div>"+
								"<br /><br />"+
								"<div style='margin-left:30px'>"+
									"<button type='button' id='sureBtn'></button>"+
									"<button type='button' id='cancelBtn'></button>"+
								"</div>";
						var dialog = new Dialog({
							title: "发布模型",
							style: "width:500px;height:300px;background:#fff",
							content: dialogContent
						});
						// 点击发布模型按钮，弹出发布窗口
						on(dom.byId("btnPublish"),"click",function()
						{
							selectedModelPathPerPage.call(this);//得到每一页中选中的模型
							//这里需要判断当前选中的模型的数量是否为0
							var len = getSelectedModelLen.call(this);
							if(len > 0)
							{
								dialog.show();
							}
							else
							{
								Spolo.notify({
									"text" : "请选择模型",
									"type" : "error",
									"timeout" : 1000
								});
							}
						});
						var cancelBtn = new Button({
							label:"取消",
							onClick:function(){
								dialog.hide();
							}
						},"cancelBtn");
						
						// 点击发布窗口中的确定按钮
						var sureBtn = new Button({
							label:"确定",
							onClick:function(){
								var publishTargets = query("#publishTargets input:checked");
								var ptLen = publishTargets.length;
								if(ptLen == 0)
								{
									Spolo.notify({
										"text" : "请选择发布位置",
										"type" : "error",
										"timeout" : 1000
									});
								}
								else
								{									
									// 将所有选中的模型发布到指定路径下
									// @param modelArray 模型数组
									// @param targetPath 目标路径
									function publishModels(modelArray, targetPath){
										if(!modelArray || !targetPath){
											throw("modelArray || targetPath error!");
										}
										arrayUtil.forEach(modelArray, function(item){
											var path = item.alt;
											folder_cls.publish(
												"model",
												{
													path : path,
													targetPath : targetPath,
													success : function(suc){
														//console.log(suc);
														currentReqtCount++;
														if(currentReqtCount == requestCount)
														{
															dialog.hide();	// 隐藏窗口
															Mask.hide();
															//成功以后取消之前所选的模型
															setSelectModel(false);
															modelLocation = {};
															Spolo.notify({
																"text" : "发布成功！",
																"type" : "success",
																"timeout" : 1000
															});
														}
													},	
													failed : function(error){
														//console.log(suc);
														currentReqtCount++;
														if(currentReqtCount == requestCount)
														{
															dialog.hide();	// 隐藏窗口
															Mask.hide();
															//成功以后取消之前所选的模型
															setSelectModel(false);
															modelLocation = {};
															Spolo.notify({
																"text" : "发布成功！",
																"type" : "success",
																"timeout" : 1000
															});
														}
													}
												}
											);
										});
									}
									Mask.show();
									var len = getSelectedModelLen.call(this);
									var requestCount = ptLen * len;
									var currentReqtCount = 0;
									
									arrayUtil.forEach(publishTargets, function(item)
									{
										for(var key in pathArray)
										{
											publishModels(pathArray[key], item.value);
										}
									});
								}	
							}
						},"sureBtn");
						// 全选
						on(dom.byId("btnSelectAll"),"click",function(){
							setSelectModel(true);
						});
						// 取消
						on(dom.byId("btnUnSelect"),"click",function(){
							setSelectModel(false);
						});
						// 设置模型列表的状态
						function setSelectModel(state)
						{
							arrayUtil.forEach(query("#modelList input"), function(input){
								input.checked = state;
							});
						}
						
						//导出模型属性的方法
						on(dom.byId("btnExportModelProperties"),"click",function()
						{
							scene.exportModelData();
						});
						
						var content = "<form id=\"import_form\"  method=\"POST\" enctype=\"multipart/form-data\">"+
								   "<input name=\"选择文件\" id=\"importFile\" type=\"file\"><br /><input type=\"button\" id=\"btnimportSure\" value=\"导入\"></form>";
						var importdialog = new Dialog
						({
							title:"导入模型属性",
							content:content,
							style:"width:260px;height:130px;"
						});
						//导入模型属性
						on(dom.byId("btnImportModelProperties"),"click",function()
						{
							importdialog.show();
						});
						
						on(dom.byId("btnimportSure"),"click",function()
						{
							if(dom.byId("importFile").value == "")
							{
								Spolo.notify({
									"text" : "请选择文件!",
									"type" : "error",
									"timeout" : 1000
								});
							}
							else
							{
								var path = scene.getURI();						
								var newScene = new scene_cls(path);
								//Mask.show();
								scene = newScene;
								scene.importModelData("import_form",{
									load : function(data){
										//这儿需要调用一下初始化方法
										initModellist.call(this,scene);
										importdialog.hide();
										Spolo.notify({
											"text" : "导入成功!",
											"type" : "success",
											"timeout" : 1000
										});
										Mask.hide();
									},
									error : function(err){
										Spolo.notify({
											"text" : err + "失败",
											"type" : "error",
											"timeout" : 1000
										});
									}
								});
							}
						});
						
						//合并模型的提示窗口
						var mergeContent = "<center><label>您选择的模型不相同,确定合并吗？</label><br />"+
										"<button id='btnSureMerge'></button>"+
										"<button id='CancelMerge'></button></center>";;
						var mergeDialog = new Dialog({
							title:"合并模型",
							style:"width:200px;height:80px;background:#fff",
							content:mergeContent
						});
						new Button({
							label:"确定"
						},"btnSureMerge");
						new Button({
							label:"取消"
						},"CancelMerge");
						
						on(dom.byId("btnSureMerge"),"click",function(){
							selectedModelPathPerPage.call(this);//得到每一页选中的模型
							var modelPath = getModelPath.call(this);//获取选中的模型路径
							mergeModel.call(this,modelPath);
						});
						on(dom.byId("CancelMerge"),"click",function(){
							Mask.hide();
						});
						
						//调用方法进行合并模型
						function mergeModel(modelPath){
							Mask.show();
							scene.mergeIdenticalModels(
								modelPath,
								function(data){
									initModellist.call(this,scene);
									Mask.hide();
									Spolo.notify({
										"text" : "合并成功！",
										"type" : "success",
										"timeout" : 1000
									});
									mergeDialog.hide();
									setSelectModel(false);
									modelLocation = {};
								},
								function(error){
									Mask.hide();
									Spolo.notify({
										"text" : "合并失败!",
										"type" : "error",
										"timeout" : 1000
									});
									mergeDialog.hide();
								}
							);
						}
						//合并相同模型
						on(dom.byId("btnMergeModel"),"click",function()
						{
							selectedModelPathPerPage.call(this);//得到每一页选中的模型
							var modelPath = getModelPath.call(this);//获取选中的模型路径
							if(modelPath.length > 1)
							{
								//先调用检查的方法,如果能够合并，再调用合并的方法
								Mask.show();
								scene.checkIdenticalModels(
									modelPath,
									function(data){
										//合并模型
										mergeModel.call(this,modelPath);
									},
									function(error)
									{
										Mask.hide();
										mergeDialog.show();
									}
								);
							}
							else
							{
								Spolo.notify({
									"text" : "至少选择两个模型!",
									"type" : "error",
									"timeout" : 1000
								});
							}
						});

						on(dom.byId("btnBatchModifyModel"),"click",function(){
							console.log("btnBatchModifyModel");
							selectedModelPathPerPage.call(this);//得到每一页中选中的模型
							//这里需要判断当前选中的模型的数量是否为0
							var len = getSelectedModelLen.call(this);
							var pathS = new Array();
							if(len > 0)
							{
								for(var key in pathArray)
								{
									arrayUtil.forEach(pathArray[key], function(item){
										var path = item.alt;
										pathS.push(path);
									});
								}
								var paramStr = encodeURIComponent(pathS);
								var content = "<iframe src='/modules/scenedetail/publishmodel/batchmodify.html?path="+paramStr+"'"+
												"scrolling='no' framespacing='0' border='0' frameborder='0' "+
												"style='width:99%;height:92%;'></iframe>";
								iframe.showDialog(content,"从效果图添加模型","dialogFromPreview");
							}
							else
							{
								Spolo.notify({
									"text" : "请选择模型!",
									"type" : "error",
									"timeout" : 1000
								});
							}
						});
					});
					
					// 处理 ModelItem 的属性编辑
					function onModelListItemModify(node)
					{
						var url = "/modules/modeledit/index.html?modelPath="+node.path;
						var dialogData = {
							widthpx: 980,
							heightpx : 700,
							id:node.path,
							title:"模型详细信息",
							url:url,
							data:
							{
								"modelpath":node.path,
								"modellistitem":node
							},
							callback: function(spdialog){
								//接收传来名字
								spdialog.on("resetResoureName",function(modelName)
								{
									node.set("name", modelName);
								});
								spdialog.on("modelPreview",function()
								{
									model_cls.getPreviewByPath(
										node.path,
										function(url){
											modelListWidgetArray[node.path].set("image",url);
										},
										function(error){
										}
									);
								});	
							}
						};
						Spolo.dialog(dialogData);
					}
				}
			);
		</script>	
    </body>
</html>