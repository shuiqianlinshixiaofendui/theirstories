<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>
            从个人模型库添加模型
        </title>
		<script type="text/javascript" >
			dojoConfig = {
				parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
		
        <script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
        <script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/addmodelfromprivatemodellib.css" media="screen" />
		<link rel="stylesheet" href="/widgets/ModelListItem/css/main.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/Category/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/List/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/ModelEdit/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/ModelLib/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Toolbar/css/main.css" media="screen">
    </head>
    <body class="claro">
		<div id="privatemodellibContent" dojoType="dijit.layout.BorderContainer" gutters=false>
			<div id="addmodelfromprivatemodellibtoolbar" dojoType="dijit.layout.ContentPane" region="top">
				<input type="button" id="btnAddModelFromPrivate" value="" />
			</div>
			<div id="privateModelLibs" dojoType="dijit.layout.ContentPane" region="center">
				
			</div>
		</div>
	<script type="text/javascript">
		
		require(
			[
				"dojo/ready", "dojo/dom", "dojo/on", "widgets/Mask/Mask",
				"dijit/layout/BorderContainer", "dijit/layout/ContentPane", "dijit/layout/TabContainer",
				"widgets/ModelLib/ModelLib", "dojo/cookie"
				
			],function(
				ready, dom, on, Mask,
				BorderContainer, ContentPane, TabContainer,
				ModelLib, cookie
			){
				ready(function(){
					var varsMap = Spolo.getUrlVars();
					var isGutil = varsMap ['isGutil'];
					if(isGutil == "true"){
						dom.byId("btnAddModelFromPrivate").value = "打开选中模型";
					}
					else{
						dom.byId("btnAddModelFromPrivate").value = "添加选中模型";
					}
					//获取父级页面的 scene 对象
					this.scene = this.parent.scene;
					var scene = this.scene;
					var iframe = this.parent.iframe;
					var uid = Spolo.getUserId();
					var privateLibPath = "/content/users/"+uid+"/modellib";
					initLib();
					//初始化模型库
					function initLib(){
						//个人模型库
						var privateCurrentPage = cookie("privateCurrentPage");
						if(!privateCurrentPage){
							privateCurrentPage = 1;
						}
						var privateJSON = 
						{
							path: privateLibPath,
							limit: 10,
							queryString: "[@sling:resourceType='model']",
							hasCategory: true,
							selectedModules:true,
							currentPage:privateCurrentPage,
							showEditOrPreview:true,
							numberSpinner:true,
							showAddItemsModelLib:true
						};
						var privateModelLib = new ModelLib(privateJSON);
						privateModelLib.placeAt("privateModelLibs");
						privateModelLib.hideButton();
						//添加所有选中模型
						on(dom.byId("btnAddModelFromPrivate"),"click", function(){
							var privateSelected = privateModelLib.getAllPageSelected();
							cookie("privateCurrentPage",privateModelLib.getCurrentPage());
							if(privateSelected.length){
								Mask.show();
								addModelsToCurrentScene(privateLibPath,privateSelected);
								if(isGutil != "true"){
									scene.saveItems(success, error);
								}
							}
							else
							{
								Spolo.notify({
									text : '请选择模型!!',
									type : 'error',
									timeout : 1000
								});
							}
						});
					}
					
					//遍历当前所有选中的模型，并且添加到场景中
					function addModelsToCurrentScene(path,data){
						if(data){
							if(isGutil == "true"){
								var pathArray = new Array();
								for(var key = 0; key < data.length ;key++){
									pathArray.push(path + "/" + data[key]["nodeName"]);
									pathArray.push(data[key]["addNumber"]);
								}
								scene.addItemsByCount(pathArray, success);
							}
							else{
								for(var key = 0; key < data.length ;key++){
									var name = data[key]["resourceName"];
									var referModel = path + "/" + data[key]["nodeName"];
									var ID = data[key]["ID"];
									var addNumber = data[key]["addNumber"];
									var json = {
										name:name,
										referModel:referModel,
										type:"MESH",
										ID:ID
									};
									scene.addItemsByCount(json,addNumber);
								}
							}
						}
					}
					function success(res)
					{
						Mask.hide();
						iframe.refreshEditItems();
						Spolo.notify({
							text : "添加模型成功!!",
							type : "success",
							timeout : 1000
						});
					}
					function error(res)
					{
						Mask.hide();
						Spolo.notify({
							text : "添加模型失败!!",
							type : "error",
							timeout : 1000
						});
					}
				});
			});
	</script>	
    </body>
</html>