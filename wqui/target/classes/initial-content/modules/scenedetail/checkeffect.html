<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>
            查看渲染效果
        </title>
		<style type="text/css">
			html,body{
				width:100%;
				height:100%;
				margin:0px;
				paddinig:0px;
			}
			#btnRender
			{
				width: 70px;
				line-height: 25px;
				text-align: center;
				color: #fff;
				font-weight: bold;
				font-size: 12px;
				background: #5080d8;
				cursor: pointer;
			}
		</style>
		<script type="text/javascript" >
			dojoConfig = {
				//parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "scenedetail",
						location: "/modules/scenedetail"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
        <script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/libs/jsjac-1.3.4/jsjac.js"></script>
        <script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="/widgets/List/css/main.css"  media="screen"/>
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css"  media="screen"/>
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
    </head>
    <body class="claro">
		<div dojoType="dijit.layout.BorderContainer" gutters=false>
			<div dojoType="dijit.layout.ContentPane" region="top" style="height:30px;">
				&nbsp;&nbsp;&nbsp;<b>请选择一个视角,点击渲染按钮进行渲染：</b><button id="btnRender">渲染</button>
				&nbsp;&nbsp;&nbsp;<b>注意：如果有正在渲染的camera，那么请等待渲染完成，然后再重新选择进行渲染</b>
			</div>
			<div dojoType="dijit.layout.ContentPane" region="center" >
				<div id="cameraList" style="height:500px;overflow-y:auto;"></div>
			</div>
		</div>	
	<script type="text/javascript">
		require(
			[
				"dojo/parser","dojo/ready","dojo/dom","dojo/dom-style","dijit/ProgressBar", "dojo/query", "dojo/on","spolo/data/scene",
				"widgets/List/List","widgets/Pagination/Pagination","dijit/form/Button","dijit/layout/BorderContainer", "dijit/layout/ContentPane","widgets/Mask/Mask",
				"dojo/NodeList-manipulate","dojo/NodeList-traverse"
			],function(
				parser, ready, dom, domStyle,ProgressBar,query,on,scene,List,Pagination,Button,BorderContainer,ContentPane,Mask
			){
				ready(function(){
					this.scene = this.parent.scene;
					var scene = this.scene;
					var list = new List();
					var array = [];
					var jobManager = {};
					//var cameraNum = 0;
					showCameras.call(this);
					//显示摄像机列表
					function showCameras()
					{
						scene.getCameras
						(
							function(itemarray){
								//cameraNum = itemarray.length;
								for(var key = 0 ; key < itemarray.length;key++ )
								{
									var name = itemarray[key]["data"]["name"];
									array.push(name);
								}
								addItems.call(this,array);
								list.placeAt("cameraList");
								list.showList();
								list.closeEdit();
								getJobs.call(this,array);
							},
							function(error){
								throw error;
							},
							true
						);
					}
					//初始化items
					function addItems(array)
					{
						list.addItems(array,true);
						for(var key = 0 ; key < array.length;key++)
						{
							list.setItemImage(array[key],"/widgets/ModelListItem/image/camera.png");
							list.addDomNode(array[key],"<div>摄像机名称："+array[key]+"</div>");
							list.addDomNode(array[key],"<div></div>");
						}
					}
					
					//隐藏按钮以及遮罩函数
					function UIeffect()
					{
						//Mask.hide();
						list.closeSelect();
						query("#btnRender").attr("disabled",true);
						query("#btnRender").style("background","#e0e0e0");
					}
					
					//改变field的值
					function changeState(name,state)
					{
						var field = list.getField(name,2);
						list.setField(field,"<img src=\"/widgets/Mask/images/mask_loading.gif\" style=\"float:right;\">"+state);	
					}
					
					//获取job对象并且监听不同阶段的事件
					function getJobs(items)
					{
						scene.getJobManager("preview",function(obj){
							jobManager = obj;
							//正在创建
							on(jobManager,'onCreating',function(msg)
							{
								UIeffect.call(this);
								changeState.call(this,msg.cameraName,"正在创建...");	
							});
							//创建失败
							on(jobManager,'onCreateFailed',function(msg)
							{
								Spolo.notify({
									"text" : msg.cameraName + "创建失败",
									"type" : "error",
									"timeout" : 1000
								});
							});
							//创建完成
							on(jobManager,'onCreated',function(msg)
							{
								
								UIeffect.call(this);
								changeState.call(this,msg.cameraName,"等待渲染...");
								//var field = list.getField(msg.cameraName,2);
								//query(field).style("margin-top","0px");
								//list.setField(field,"<img src=\"/widgets/ModelListItem/image/camera.png\" width=\"80\" height=\"80\">");
							});
							//派发
							on(jobManager,'onDispatching',function(msg)
							{
								console.log('------------------------------onDispatching');
							});
							//正在渲染
							on(jobManager,'onRendering',function(msg)
							{
								UIeffect.call(this);
								changeState.call(this,msg.cameraName,"正在渲染...");
							});
							//渲染完成
							//content/users/admin/scenelib/scene201322911232429…/previewJobs.renderjob.result.png?jobName=job5759渲染完成时的图片
							on(jobManager,'onFinished',function(msg)
							{
								var field = list.getField(msg.cameraName,2);
								query(field).style("margin-top","0px");
								list.setField(field,"<img src=\""+msg.url+"\" width=\"80\" height=\"80\">");
							});
							//渲染时出错
							on(jobManager,'onError',function(msg)
							{
								Spolo.notify({
									"text" : msg.cameraName+"渲染出错!",
									"type" : "error",
									"timeout" : 1000
								});
							});	
							jobManager.getPreviews(items);//如果有job，那么就不创建
						});
					}
					//点击确定调用方法
					on(dom.byId("btnRender"),"click",function()
					{
						var items = list.getSelectNodes();//获取选中的摄像机的key(name)
						if(items.length)
						{
							jobManager.createPreviews(items,function(){
								Mask.show();
							},function(){
								Mask.hide();
							});	
						}
						else
						{
							Spolo.notify({
								"text" : "请选择一个视角!",
								"type" : "error",
								"timeout" : 1000
							});
						}
					});
				});
			}
		);
	</script>
    </body>
</html>