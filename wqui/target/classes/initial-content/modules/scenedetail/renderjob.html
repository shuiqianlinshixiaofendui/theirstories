<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title></title>
		<script type="text/javascript" >
			dojoConfig = {
				parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "scenedetail",
						location: "/modules/scenedetail"
					},
					{
						name: "widgets",
						location: "/widgets"
					}
				]
			};
		</script>
		
        <script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script> 
        <script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/jsjac-1.3.4/jsjac.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/renderjob.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/JobListItem/css/main.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/JobDialog/css/main.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
		<link rel="stylesheet" href="/libs/dijit/themes/tundra/tundra.css" media="screen">
		<link rel="stylesheet" href="/libs/dojox/image/resources/Lightbox.css" media="screen">
		
    </head>
    
    <body class="claro">
		<div id="listJob" dojoType="dijit.layout.BorderContainer" >
			<div id="toolbar" dojoType="dijit.layout.ContentPane" region="top" >
			<div dojoType="dijit.layout.BorderContainer" gutters=false>
					<div  dojoType="dijit.layout.ContentPane" region="top" style="height:30px;">
						<button id="btnAllSelected" data-dojo-type="dijit.form.Button">全选</button>
						<span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
						<button id="btnCancel" data-dojo-type="dijit.form.Button">取消</button>
						<span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
						<button id="btnAddRenderJob" data-dojo-type="dijit.form.Button">渲染当前场景</button>
						<span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
						<button id="btnSeeRenderJob" data-dojo-type="dijit.form.Button">查看渲染进度</button>	
						<span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
						<button id="btnDeleteJob" data-dojo-type="dijit.form.Button">删除渲染任务</button>
						<span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
						<button id="btComitTask" disabled data-dojo-type="dijit.form.Button" >提交任务</button>																			
					</div>
					<div dojoType="dijit.layout.ContentPane" region="center" style ="float:right;overflow:hidden;">
						<form id="upload_form" method="POST" action="" enctype="multipart/form-data" >
							<span><font color="red">可以本地上传一个符合规范的zip包(<font id="showDescription" color="blue"  style="cursor:pointer"><u>查看详细规范说明</u></font>).</font></span>
							<input id="uploadfile" name="uploadfile" type="file"/>
							<button id="btnUploadRenderJob" data-dojo-type="dijit.form.Button">上传</button>
							<font id="freshHandler" color="blue"  style="float:right;margin-top:13px" title="点击刷新handler数量">刷新</font>					
							<span id  = "handler_total" style="margin-top:25px"/>
						</form>	
					</div>					

				</div>	

			</div>
			
			<div id="list" dojoType="dijit.layout.ContentPane" region="center">
				加载中，请稍后...
			</div>													
		</div>
			<!--start 需要封装一个dialog -->	
			<div   data-dojo-type="dijit/Dialog"  id="createJobProperties" title="选择渲染器类型" style="display: none"></div>	
    </body>
<script type="text/javascript">			
require(["dojo/ready","dojo/dom","dojo/on","widgets/JobList/JobList","widgets/JobListItem/JobListItem",
		"widgets/Mask/Mask","spolo/data/scene","dijit/Dialog", "dijit/form/Button","dijit/layout/BorderContainer",
		"dijit/layout/ContentPane","dojox/image/Lightbox","dojo/dom-construct","widgets/JobDialog/JobDialog",
		"dijit/TooltipDialog", "dijit/popup","spolo/data/folder",
],
function(
	ready, dom, on,JobList,
	JobListItem, Mask,scene_cls,Dialog,
	Button,BorderContainer,ContentPane,Lightbox,
	domConstruct,JobDialog,TooltipDialog,popup,folderClass){
									
		ready(function(){
			var jobManager = null;
			var jobList = null;		
			this.scene = this.parent.scene;
			var uri = this.scene.getURI();
			var scene = new scene_cls(uri);
			var curr_user = Spolo.getUserId();
			curr_user = Spolo.decodeUname(curr_user); 
			
			// get renderManager
			this.scene.getJobManager("render",function(jm){
				jobManager = jm;
				queryHandler(jobManager);
				refresh();	
			});

			function queryHandler(jobManager){
				jobManager.queryHandlersInfo(function(data){				
				var string =  '<label style="float: right;margin-right: 30px;margin-top:12px">slg空闲：'+data.slg_notbusy  + '</label>&nbsp;';
				string +='<label style="float: right;margin-right: 30px;margin-top:12px"">octane空闲：'+data.octane_notbusy  + '</label>&nbsp;';
				string +='<label style="float: right;margin-right: 30px;margin-top:12px"">空闲总数：'+data.totally_notbusy  + '</label>&nbsp;';
				string +='<label  style="float: right;margin-right: 30px;margin-top:12px"">handler总数：'+data.totally + '</label>&nbsp;';
				dojo.byId("handler_total").innerHTML = string ;
			});	
			}
			//init the Dialog when add jobs
			var dJson = {};
			dJson["dialog"] = dijit.byId('createJobProperties');
			dJson["currUser"] = curr_user;				
			var iDialog= new JobDialog(dJson).placeAt("createJobProperties");
			
			var myTooltipDialog = new TooltipDialog({
							style: "width: 300px;",
							content: "<p>规范整理中...",
							onMouseLeave: function(){
								popup.close(myTooltipDialog);
							}
						});		
			var success = function(arry){
				//清除之前的残留数据
				domConstruct.empty("cameras");
				for (var i in arry){
					var camera = arry[i];
					if(typeof(camera)=="object"){
						var t = camera.getName();
						iDialog.createCamera(i,t);
					}
				}				
			};
			var error = function(error){
				iDialog.noticeInfo(error);
			};
			
			function refresh(){							
				var node = dom.byId('list');
				while (node.hasChildNodes()) {
					node.removeChild(node.lastChild);
				}
				jobList = new JobList();
				jobList.placeAt("list");							
				jobManager.getJobs(function(jobs){
					for(var job in jobs){
						var json = {};
						j = jobs[job];							
						var  jobid = j.getJobID();    
						var  sequence = j.getSP_sequence();    
						var  type = j.getJobType();    
						var  handler = j.getSP_handler();    
						var  render = j.getTarget();    

						json['name'] = job;
						json['type'] = type;
						json['location'] = jobid;
						json['statue'] = j.getStatus();
						json['target'] = j.getTarget();
						json['resualtImgPath'] = j.getResultImagePath();
						
						var item = new JobListItem(json);		
						jobList.addJobListItem(item);						
						getJobProgress(item,j);						
					}							
				},true);	
				
				on(jobList,"checkBoxClick",function(){
					if(checkItem()){
						dijit.byId("btComitTask").setAttribute('disabled', false);
						publishPreview();
					}else{
						dijit.byId("btComitTask").setAttribute('disabled', true);	
					}				
				});		
			}		
		
			//判断job的进度显示分别显示job信息
			function getJobProgress(item,job){
				var value = job.getStatus();	
				//var value = "doing";
				var isSequence = false;
				var statue = "";
				switch(value){
					case "creating":	
						statue="正在创建中";										
						break;						
					case "created":
						var isSequence = false;
						statue=("排队中");
						break;
					case "dispatching":
						statue=("派遣中");						
						break;						
					case "doing":	
						statue=("正在渲染中");
						break;						
					case "finished":
						statue="任务完成";
						doFinish(item,job);	
						break;	
					case "finish_error":	
						statue=("渲染失败");
						break;						
					default:	
						return;				
				}		
				showJobInfo(item,job,statue,isSequence);						
			};
			
			function showJobInfo(item,job,statue,isSequence){
				var jobinfo = {};
				var renderType= "";
				if (job.getTarget() == "sample"){
					renderType = "预览图";
				}else if(job.getTarget() == "product"|| !job.getTarget()){
					renderType = '效果图';
				}					
				jobinfo['渲染分类'] =renderType;
				jobinfo['渲染器类型'] = job.getSP_Render();
				if(isSequence) jobinfo['当前排队位置'] = job.getSP_sequence();
				jobinfo['当前进度'] = statue;
				item.setJobInfo(jobinfo);							
			};

			//显示缩略图
			function doFinish(item,job){				
				var imgSrc = job.getResultImageURL();
				//测试图片
				//var imgSrc = "http://www.baidu.com/img/shouye_b5486898c692066bd2cbaeda86d74448.gif";
				item.updateIcon(imgSrc);
				on(jobList,"onRenderIconClick",function(job){ 					 
					var statue = job.statue ;
					var url = job.src ;					
					var lb = new dojox.image.LightboxDialog({});					
					lb.startup();
					//lb.set("style","position:absolute;top:130px !important;left:330px !important;");
					lb._setStyleAttr('top:' + 30 + 'px !important;');	
					lb._setStyleAttr('left:' + 200 + 'px !important;'); 				
					if(statue =="finished"){					
						lb.show({title:job.name,href:url});						
					}
				});		
			};
			
			function getFileName(path){  //文件名可修改，先获取处理啊 不带扩展名
				var pos1 = path.lastIndexOf('/');
				var pos2 = path.lastIndexOf('\\');
				var pos  = Math.max(pos1, pos2)
				if( pos<0 ){
					return path;
				}else{
					return path.substring(pos+1).split(".")[0];
				}
			};
			
			/*
				创建job
			*/
			//create first ,and  create next by order notice the usage of method shift() 
			function addJobs(jobArray){				
				var len = jobArray.length;				
				if(jobArray.length>0){
					var  callback = function(isSuccess){
						addJobs(jobArray);
					}					
					doAddJob(jobArray.shift(),callback);
				}
				else{
					Mask.hide();
				}
			}
			
			//call JobAPI
			function doAddJob(job_json,callback){
				var result = false;
				var json = {
					jobInfo:job_json,	
					success : function(job){			
						var jobinfo = {};
						jobinfo['name'] = job.getName();
						jobinfo['type'] = job.getJobType();
						jobinfo['location'] = job.getJobID();
						jobinfo['target'] = job.getTarget();
						jobinfo['resualtImgPath'] = job.getResultImagePath();
						
						var item = new JobListItem(jobinfo);
						getJobProgress(item,job);						
						jobList.addJobListItem(item);
						callback(true);			
					},
					failed : function(error){
						iDialog.noticeInfo(error);
						Mask.message("创建job失败",false);
						callback(false);
					},
					creating : function(){						
					},
					notifier : function(msg){
						Mask.message(msg,true);
						Mask.appendLogItem(msg);
					}
				};
				jobManager.createJob(json); 		
			};	
		
			//上传job
			function doUoloadJob(rName){
				args={ 
					jobInfo:{jobType:'render',target:"product",render:"octane"},
					success : function(job){
						var jobinfo = {};
						jobinfo['name'] = job.getName();
						jobinfo['type'] = job.getJobType();
						jobinfo['location'] = job.getJobID();
						jobinfo['target'] = job.getTarget();
						jobinfo['resualtImgPath'] = job.getResultImagePath();
						
						var item = new JobListItem(jobinfo);
						getJobProgress(item,job);						
						jobList.addJobListItem(item);						
						Mask.hide();
					},
					failed : function(error){
						iDialog.noticeInfo(error);
						Mask.hide();		
					},
					uploading : function(){
						Mask.show();		
					}			
				};
				//文件名可选 如不为空就填进去
				if(rName){
					args.jobInfo.resultFileName = rName;
				}else{
					args.jobInfo.resultFileName = "result";
				}				
				jobManager.uploadJob(dom.byId("upload_form"),args);						
			};		
		
			
			/* 
				发布事件处理
				确认框
				调用发布
			*/
			function publishPreview(){
				on(dom.byId("btComitTask"),"click",function(){
					var prevewDialog = new Dialog({
						title: "Confirm Dialog",
						content: "小提示：会先发布到我的效果图，您确定要发布么? ",
						style: "width: 300px;height:100px"
					
					});
				
					//Creating div element inside dialog
					var div = dojo.create('div', {}, prevewDialog.containerNode);
					dojo.style(dojo.byId(div), "float", "left");

					var noBtn = new dijit.form.Button({
						label: "取消",
						onClick: function(){
							prevewDialog.hide();
							dojo.destroy(prevewDialog);
						},
						style:"margin:20px 10px 3px 150px"
					 });

					var yesBtn = new dijit.form.Button({
									label: "确定",
									style : "width : 60px",
									onClick : function(){
										_previewPublish();
										prevewDialog.hide();
										dojo.destroy(prevewDialog);							
									},
									style:"margin:20px 0 0 20px"								
								 });
					dojo.create(yesBtn.domNode,{}, div);
					dojo.create(noBtn.domNode,{}, div);
					prevewDialog.show();					 
				});
			}
	
			//发布效果图
			function _previewPublish(){
				var curr_arr = jobList.getSelectedItem();
				var flag = true;
				var type = "preview";
				var successPublish = function(suc){
											Mask.message("发布成功",true);
											Mask.appendLogItem("发布成功！");
										};
				var failedPublish = function(error){
											Mask.message("发布失败",true);
											Mask.appendLogItem(error);	
										};

				// 显示遮罩
				Mask.show();
				// 展开log窗口
				Mask.showLogWindow();				
				for(var index=0;index<curr_arr.length;index++){
					var item=curr_arr[index];						
					var imgpath = "/home/glue/share"+item.render.resualtImgPath; 					
					// 这里调用 spolo.data.preview.publish 方法
					if(imgpath){
						scene.publishPreview(
							imgpath,
							successPublish,
							failedPublish	
						);							
					}
				}			
			}
			
			//	检测选中的item类型 
			function checkItem(){
				var curr_arr = jobList.getSelectedItem();
				var flag = true;
				if(!curr_arr.length){
					flag =false;
				}
				for(var index=0;index<curr_arr.length;index++){
					var item=curr_arr[index];
					if(item.target == "预览图"||item.render.statue !="finished"){
						flag =false;
						break;
					}				
				}	
				return flag;
			}	
			
			on(dom.byId("btnAddRenderJob"),"click",function(){
				scene.isRender(function(jsonData){
					if(jsonData["isRender"]=="true"){
						scene.getCameras(success,error,true);
						dijit.byId('createJobProperties').show();	
					}else if(jsonData["isRender"]=="false"){
						iDialog.noticeInfo("场景为空，无法渲染");
						}		
				});			
			});
			
			on(dom.byId("btnDeleteJob"),"click",function(){							
				var curr_arr = jobList.getSelectedItem();
				if (curr_arr.length == 0){
					Spolo.notify({
						"text" : "尚未选中...",
						"type" : "error",
						"timeout" : 1000
					});
					return ;
				}
				for(var i=0;i< curr_arr.length;i++){
					var it = curr_arr[i];
					var json = {
						jobName: it.getItemName(),
						success : function(){
							jobList.removeSelectedItem();	
						},
						failed : function(error){
							iDialog.noticeInfo(error);
						},
						saving : function(){	
						}
					} 								   
					jobManager.deleteJob(json);						
				}																	
			});
			
			on(dom.byId("btnSeeRenderJob"),"click",function(){
				var curr_arr = jobList.getSelectedItem();
				if (curr_arr.length == 0){
					Spolo.notify({
						"text" : "尚未选中...",
						"type" : "error",
						"timeout" : 1000
					});
					return ;
				}
				for(var i=0;i<curr_arr.length;i++){
					var it = curr_arr[i];
					var jobName = it.getItemName();
					//jobManager.getJob 回调设置
					var callback=function(jobobj){
						//找到对应的item
						for(var index=0;index<curr_arr.length;index++){
							var item=curr_arr[index];
							if(jobobj.getName()==item.getItemName()){
								item.render.statue = jobobj.getStatus();					
								getJobProgress(item,jobobj);
							}
						}		
					}
					jobManager.getJob(jobName,callback,true);	
				}															
			});
	
			on(dom.byId("btnUploadRenderJob"),"click",function(){							
				if(dom.byId("uploadfile").value){
					var resFName =iDialog.reName.value = getFileName((dom.byId("uploadfile").value));
					doUoloadJob(resFName);
				}else {
					Spolo.notify({
						"text" : "请先选择文件...",
						"type" : "error",
						"timeout" : 1000
					});
				}
			});
			
			on(dom.byId("btnAllSelected"),"click",function(){
				jobList.orSelectAllItem(true);
				if(checkItem()){
					dijit.byId("btComitTask").setAttribute('disabled', false);
					publishPreview();
				}
			});	
			
			on(dom.byId("showDescription"),"mouseover",function(){
				popup.open({
					popup: myTooltipDialog,
					around: dom.byId('showDescription')
				});
			});			
			
			on(dom.byId("showDescription"),"mouseout",function(){
				popup.close(myTooltipDialog);
			});
			
			on(dom.byId("btnCancel"),"click",function(){
				jobList.orSelectAllItem(false);
				if(!checkItem()){
					console.log(dijit.byId("btComitTask"))
					dijit.byId("btComitTask").setAttribute('disabled', true);
				}				
			});				
			
			on(dom.byId("freshHandler"),"click",function(){
				queryHandler(jobManager);
			});					
								
			//get the createjob button event 
			on(iDialog,"createJob",function(){				
				iDialog.createJobs(function(jobArry){
					Mask.show();
					addJobs(jobArry);
					len = jobArry.length;
				});
				dijit.byId('createJobProperties').hide();				
			});		
			
		});
	}
);
</script>	
</html>


					
