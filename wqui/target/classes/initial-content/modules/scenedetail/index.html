<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>
			场景详细信息
		</title>
		
		<script type="text/javascript" >
			dojoConfig = {
				//parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "scenedetail",
						location: "/modules/scenedetail"
					},
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name:"templates",
						location: "/widgets/funcButton/templates"
					}
				]
			};
		</script>
		
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/libs/jsjac-1.3.4/jsjac.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script> 
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/main.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/funcButton/css/funcButton.css" media="screen"/>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" >
			require(["dojo/parser", "dojo/ready"], function(parser, ready){
				ready(function(){
					parser.parse();
				});
			});
		</script>
	</head>	
	<body class="claro">
	<div data-dojo-type="dijit/layout/BorderContainer" style="width: 100%; height: 100%;" id="allbody" gutters="false">
		<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'" style="height:70px;background: #F1F1F1;">		
					<div id="sceneDetail">
						<div id="returnbtn"></div>
						<div id="sceneCurrentName"></div>
						<div id="sceneLoadTime"></div>
						<div id="scenePath"></div>
					</div> 
		</div>
		<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'left'" style="width:80px;background: #F1F1F1;">	
					<div id="leftBox">
						<!-- 这里会替换为自定义的控件 -->
						<!-- <div id="editlist.html" class="leftBoxItem">二维编辑</div>
						<div id="web3d" class="leftBoxItem">三维编辑</div>
						<div  class="leftBoxLine"></div>
						<div id="renderjob.html" class="leftBoxItem">渲染场景</div>
						<div id="download.html" class="leftBoxItem">下载场景</div>
						<div id="update.html" class="leftBoxItem">更新场景</div>
						<div class="leftBoxLine" id="line.show"></div> 
						<div id="modellist.html" class="leftBoxItem">发布模型</div>
						<div id="materiallist.html" class="leftBoxItem">发布材质</div>
						<div id="lacklist.html" class="leftBoxItem">缺少资源</div> -->
					</div>
		</div>
		<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'" style="border:2px solid #AAAAAA;padding:0px;">		
				<div id="contentBox">
					<iframe id="ifrContent" width="100%" height="99%" frameborder="0" src=""></iframe>
				</div>	
		</div>	
	</div>
	<script type="text/javascript">
	
		var dialogMap = {};
		//添加模型时弹出的选择模型对话框
		function showDialog(dialogContent, title, id)
		{
			if(dialogMap[id]){
				// 这里把dialog缓存起来。
				// dialogMap[id].show();	
				// return;
				// 下面的代码是每次都把dialog销毁。
				dialogMap[id].destroy();
				delete dialogMap[id];
			}
			require(["dijit/Dialog","dojo/query","dojo/dom","dojo/on"],function(Dialog,query,dom,on){
				dialog = new Dialog({
					title : title,
					content : dialogContent,
					style : "width:90%;height:98%;background-color:#fff;overflow:hidden;padding:0px;"
				});
				dialogMap[id] = dialog;
				dialog.show();
				query(".dijitDialogPaneContent",dom.byId(dialog.id)).style({"height":"95%"});
			});
		}
		
		//添加成功之后隐藏dialog
		function hideDialog(id){
			if(id && dialogMap[id]){
				dialogMap[id].hide();
			}
		}
		
		//显示3d模型
		function showWeb3d(path){
			require(["dijit/Dialog"],function(Dialog){
				if(!path)
				{
					throw("path is undefined!");
					return;
				}
				var temp = "<iframe name=\"modelweb3d\""+
							"frameborder=\"no\" border=\"0\" marginwidth=\"0\" "+
							"marginheight=\"0\" scrolling=\"no\" allowtransparency=\"yes\""+
							" style=\"width:100%;height:500px\" "+
							"src=\"/widgets/viewx3d/viewX3D.html?path="+path+"\"></iframe>";
				if(view3dDialog)
				{
					view3dDialog.destroy();
				}
				var view3dDialog = new Dialog({
					title: "3D模型",
					content: temp,
					style:"width:500px;"
				});
				view3dDialog.show();
			});
		}
		
		//点击选中模型时刷新场景编辑中的模型
		function refreshEditItems(){
			require(["dojo/query","dojo/on"],function(query, on){
				//dom.byId("ifrContent").src = "editlist.html";
				on.emit(
					query("._funcButton ")[0], "click", 
					{bubbles: true,	cancelable: true }
				);
			});
		}
		//选中文本
		function SelectText(text) {
			if ($.browser.msie) {
				var range = document.body.createTextRange();
				range.moveToElementText(text);
				range.select();
			} else if ($.browser.mozilla || $.browser.opera) {
				var selection = window.getSelection();
				var range = document.createRange();
				range.selectNodeContents(text);
				selection.removeAllRanges();
				selection.addRange(range);
			} else if ($.browser.safari) {
				var selection = window.getSelection();
				selection.setBaseAndExtent(text, 0, text, 1);
			}
		}

		
		require(
			[
				"dojo/parser",
				"dojo/ready",
				"dojo/dom",
				"dojo/dom-style", 
				"dojo/query", 
				"dojo/on",
				"spolo/data/scene",
				"dojo/_base/array",
				"dijit/Dialog",
				"widgets/funcButton/funcButton",
				"dojo/request/xhr",
				"dojo/domReady!"
			],function(parser, ready, dom, domStyle, query, on,sceneClass,array,Dialog,funcButton,xhr){
				
				ready(function(){
					var scene = this.scene;
					var scenestate = "";
					// 实例化 scene data 类
					initSceneDetail.call(this);
					
					// 初始化DOM事件
					initEvent.call(this);
					
					//将场景路径加到scenePath中
					var scenePathNode = dom.byId("scenePath");
					on(scenePathNode,"click",function(){
						SelectText(this);
					})
					scenePathNode.innerHTML = this.scene.getURI();
					// console.log(this.scene);
					
				});
				
				// 初始化DOM事件
				function initEvent(){
					var _this = this;
					var ifr = dom.byId("ifrContent");
					ifr.onload = function(){
						// 这里设置 iframe 自适应
						// 目前只兼容 chrome
						setIframeHeight(ifr);
					}
					
					/* 以下是new button 所需参数 */
					var btn1 = {
						label:"二维编辑",
						btnImg:"images/2DEdit.png",
						href:"/modules/scenedetail/editlist.html",
						alt:"二维编辑(活动)",
						id:"2DEdit",
						markCls:"2DE",
						movCls:"mov_2DE"
					};
					
					var btn2 = {
						label:"三维编辑",
						btnImg:"images/3DEdit.png",
						href:"/modules/web3d/index.html?path=",
						alt:"三维编辑(活动)",
						id:"3DEdit",
						markCls:"3DE",
						movCls:"mov_3DE"
					};
					
					var btn3 = {
						label:"渲染场景",
						btnImg:"images/Render.png",
						href:"/modules/scenedetail/renderjob.html",
						alt:"渲染场景(活动)",
						id:"RenderScene",
						markCls:"RS",
						movCls:"mov_RS"
					};
					
					var btn4 = {
						label:"下载场景",
						btnImg:"images/Download.png",
						href:"/modules/scenedetail/download.html",
						alt:"下载场景(活动)",
						id:"DownloadScene",
						markCls:"DS",
						movCls:"mov_DS"
					};
					
					var btn5 = {
						label:"更新场景",
						btnImg:"images/Update.png",
						href:"/modules/scenedetail/update.html",
						alt:"更新场景(活动)",
						id:"UpdateScene",
						markCls:"US",
						movCls:"mov_US"
					};
					
					var btn6 = {
						label:"发布模型",
						btnImg:"images/ModelList.png",
						href:"/modules/scenedetail/modellist.html",
						alt:"发布模型(活动)",
						id:"ModelList",
						markCls:"MoL",
						movCls:"mov_MoL"
					};
					
					var btn7= {
						label:"发布材质",
						btnImg:"images/MatList.png",
						href:"/modules/scenedetail/materiallist.html",
						alt:"发布材质(活动)",
						id:"MaterialList",
						markCls:"MaL",
						movCls:"mov_MaL"
					};
					
					var btn8 = {
						label:"缺少资源",
						btnImg:"images/Lack.png",
						href:"/modules/scenedetail/lacklist.html",
						alt:"缺少资源(活动)",
						id:"LackRes",
						markCls:"LR",
						movCls:"mov_LR"
					};
					
					var btnArray = new Array();
					btnArray.push(btn1);
					btnArray.push(btn2);
					btnArray.push(btn3);
					btnArray.push(btn4);
					btnArray.push(btn5);
					btnArray.push(btn6);
					btnArray.push(btn7);
					btnArray.push(btn8);
					
					// new button 并且接收被点击时的消息，作出响应
					for(var index = 0; index < btnArray.length; index ++){
						var widget = new funcButton(btnArray[index]).placeAt("leftBox");
						<!-- domConstruct.create("div",{class : "leftBoxLine"},"#3DEdit"); -->
						on(widget, "btnClick", function(e){
							
							// 获取并缓存被点击 button 的 id
							var btnId = e.id;
							
							// 获取 iframe 元素
							var ifr = dom.byId("ifrContent");
							
							// 获取 scenePath
							var scenePath = _this.scene["spnode"]["jsonnode"]["sp::client::path"];
							
							// 根据被点击 button 的 id 判断页面是否跳转并设置跳转路径和 iframe 的 src 值
							switch(btnId){
								case "3DEdit":
									getX3dState(scenePath);
									break;
								default :
									ifr.src = e.href;
									break;
							}
						});
					}
					
					// 给不同分组添加分隔线 -- “3D编辑” 和 “更新场景” 后面
					$("#3DEdit").after('<div class="leftBoxLine"></div>');
					$("#UpdateScene").after('<div class="leftBoxLine" id="line.show"></div>');
					
					// 返回按钮的点击事件
					on(dom.byId("returnbtn"),"click",function(){
						window.location.href ="/modules/myscenelib/index.html";
					});
					
					// 初始化 -- 点击左侧第一个
					on.emit(
						query("._funcButton ")[0], "click", 
						{bubbles: true, cancelable: true }
					);
				}
				
				//检查当前场景的状态
				// function checkCurrentSceneState(){
					// this.scene.getIsProcessing(
						// function(data){
							// scenestate = data;
							// if(scenestate == "1"){
								// setTimeout(checkCurrentSceneState,2000);
							// }
						// },
						// function(error){
							// console.log(error);
						// }
					// );
				// }
				// 实例化场景详细信息的逻辑类
				function initSceneDetail(){
					var ifr = dom.byId("ifrContent");
					var location = window.location.href;
					var scenePath = location.substr(location.indexOf("?path=")+6);
					if(scenePath){
						var scene = new sceneClass(scenePath);
						this.scene = scene;
						// 检查场景是否为空
						checkSceneEmpty(scene);
						//checkCurrentSceneState();
					}else{
						throw("scenePath is undefined!");
					}
				}
				// 实例化场景详细信息的逻辑类
				//使用spdialog方式显示内容
				/*function initSceneDetail(){				
					var data = Spolo.getDialogData();
					if(data["path"]){
						var scene = new sceneClass(data["path"]);
						this.scene = scene;
						// 检查场景是否为空
						checkSceneEmpty(scene);				
					}else{	
						throw("data['path'] is undefined");
					}
				}*/
				
				// 时间 < 10的时候用 “0” 补
				function Appendzero(obj)
				{
					if(obj<10)
						return "0" +""+ obj;
					else
						return obj;
				}
				
				// 检查场景是否为空
				function checkSceneEmpty(scene){
					//判断是否为空
					//如果空，隐藏发布模型和发布材质按钮
					dom.byId('sceneCurrentName').innerHtml="";
					dom.byId('sceneLoadTime').innerHTML="";
					
					scene.getInfo(
						function(data){
							var _date = new Date(data["jcr:created"]);
							dom.byId('sceneCurrentName').innerHTML = data["resourceName"];
							dom.byId('sceneLoadTime').innerHTML = 
														Appendzero(_date.getFullYear()) + "." +
														Appendzero(_date.getMonth()+1) + "." +
														Appendzero(_date.getDate()) + " " +
														Appendzero(_date.getHours()) + ":" +
														Appendzero(_date.getMinutes()) + ":" +
														Appendzero(_date.getSeconds());
							if(data["format"].indexOf("max") < 0){
								dom.byId("3DEdit").style.display='none';
								dom.byId("2DEdit").style.display='none';
								dom.byId("UpdateScene").style.display='none';
								dom.byId("RenderScene").style.display='none';
								dom.byId("ifrContent").src = "/modules/scenedetail/download.html";
							}
						},
						function(error){
							throw(error);
						}
					);
					/*
					scene.getStoredModel(function(modelArray){
						if(modelArray.length==0){
							dom.byId("ModelList").style.display='none';
							dom.byId("MaterialList").style.display='none';
							dom.byId("LackRes").style.display="none";
							dom.byId("line.show").style.display='none';
						}
					});
					*/
					scene.getStoredModelByQuery({
						limit:1,
						offset:0,
						success : function(relateModel,totalNum){
							if(totalNum == 0){
								dom.byId("ModelList").style.display='none';
								dom.byId("MaterialList").style.display='none';
								dom.byId("LackRes").style.display="none";
								dom.byId("line.show").style.display='none';
							}
						},
						failed : function(error){
							console.log(error);
						}
					});
					
				}
				
				// 这里设置 iframe 自适应
				// 目前只兼容 chrome
				function setIframeHeight(ifr){
					var height = ifr.contentDocument.height;
					ifr.style.height = height +"px";
				}
                
                function getX3dState(scenePath){
                    require(["spolo/data/scene"],function(scene){
                        var sceneObj = new scene(scenePath);
                        sceneObj.ensureX3d(function(state){
                            console.log(state.suc + "--" + state.reason + " --   从后台获取的数据");
                            if(state.suc){
                                window.location.href = "../web3d/index.html?path=" + scenePath;
                            }else{
								Spolo.notify({
									"text" : "正在处理中，请稍后...",
									"type" : "information",
									"timeout" : 1000
								});
                            }
                        });
                    });
                }
			}
		);
	</script>
	</body>
</html>

