<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="no-cache">
		<meta http-equiv="Expires" content="-1">
		<meta http-equiv="Cache-Control" content="no-cache">
		<meta charset="utf-8">
		<title>Glue 账户注册</title>
		
		<!-- 引入css布局 -->
		<link rel="stylesheet" type="text/css" href="./css/register.css" />
		<script>
			dojoConfig = {
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					}
				]
			};
		</script>
		
		<!-- 加载js库 -->
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		
	</head>
	
	<script type="text/javascript">
		// 这里是用户注册的代码
		// 服务器端会获取如下参数：
		//request.getParameter("username");
		//request.getParameter("password");
		//request.getParameter("pwdConfirm");
		//request.getParameter("nickname");
				
		// 提交的servlet 地址是 /system/regsiter
		require([
			"dojo/parser", 
			"dojo/ready",
			"dijit/form/ValidationTextBox",
			"dijit/form/Button",
			"dojo/topic",  
			"dojo/query",
			"dojo/on", 
			"dojo/request/xhr",
			"dijit/form/CheckBox",
			"dojo/dom",
			"dojox/validate/web",
			"dojo/html",
			"dojo/dom-style"
		],function(parser,ready,ValidationTextBox,Button,topic,query,on,xhr,CheckBox,dom,validate,html,domStyle){
			ready(function(){
				parser.parse();
				
				// 提交注册请求
				on(query("#signUp"),"click",function(){
					
					$("input").blur();
					//判断是否已有用户登录 -- 已有用户登录---直接跳转到主页
					var session = Sling.getSessionInfo();
					if(session){
						var userid = session["userID"];
						if(userid!="anonymous"){
							alert("您已经登录 Glue ，请退出后再注册，谢谢！");
							window.location.href = "/index2.html";
						}
					}
					
					// 获得用户名,密码,确认密码
					var username = dom.byId("UserName").value;
					var realname = dom.byId("RealName").value;
					var password = dom.byId('Passwd').value;
					var pwdConfirm = dom.byId('PasswdAgain').value;
					if(username == "" || !isEmail(username) || isExist){
						dom.byId("errormsg_0_UserName").focus();
						return;
					}else if(realname == ""){
						dom.byId("errormsg_0_RealName").focus();
						return;
					}else if(password == "" || password.length < 6){
						$("input:password#PasswdAgain").css("borderColor","#FF0000");
						dom.byId("errormsg_0_Passwd").focus();
						return;
					}else if(pwdConfirm == ""){
						dom.byId("errormsg_0_PasswdAgain").focus();
						return;
					}else if(!$("#TermsOfService").attr("checked")){
						dom.byId("errormsg_0_TermsOfService").focus();
						return;
					}
					
					/** 调用 gutil 保存用户登录状态
					*/
					function sessionByGutil(args){
						console.log("sessionByGutil()");
						var map = {};
						var username = args["j_username"];
						var password = args["j_password"];
						var url = "http://127.0.0.1:10828/savecookie";	//?username="+username+"&password="+password
						var content = {
							"username":username,
							"password":password
						};
						var callback = args["callback"];
						require(["dojo/io/iframe"], function(ioIframe){
							ioIframe.send({
								//form: "myform",
								method : "POST",
								url : url,
								content : content,
								handleAs : "text",
								load : function(data)
								{
									if(callback && typeof(callback)=="function")
									{
										callback();
									}
								},
								error : function(err)
								{
									if(callback && typeof(callback)=="function")
									{
										callback();
									}
									console.error(err);
								}
							});
						});
					}
					
					//xhrRegister(username,realname,password,pwdConfirm);
					var data = "_charset_=UTF-8&resource=/&resource=form"+
								"&username="+username+"&nickname="+realname+
								"&password="+password+"&pwdConfirm="+pwdConfirm;
					var url = "/system/register";
					xhr(url,{
						handleAs: "text",
						method: "POST",
						data: data
					}).then(
						function(msg){
							// 注册成功后自动登录
							username = Spolo.encodeUname(''+username);
							password = password;
							
							var urlMap = Spolo.getUrlVars();
							if(urlMap && urlMap["isGutil"]){
							// 调用 gutil 保存用户登录状态
								sessionByGutil({
										"j_username": username,
										"j_password": password,
										"callback":function()
										{
										 // 页面跳转到 gutil 请求的 url
										 // var redirect = urlMap["redirect"];
											 var redirectMap = Spolo.getUrlRedirectPar();
											 var redirect = redirectMap["redirect"];
											 if(!redirect){
												console.error("UrlVars['redirect'] is undefined!");
												return;
											  }
											  redirect = decodeURIComponent(redirect);
											  console.log("redirect : "+redirect);
											  Spolo.redirectWithVars(redirect);
										}
								});
																							
							}else{
								// 发出登录成功的消息
								// topic.publish("user/login/success");
								// window.location.href = "/index2.html";
								// Spolo.redirect("/index2.html");
								
								
								var loginUrl = "/j_security_check";
								var loginData = "_charset_=UTF-8&resource=/&resource=form&"+
												"j_username="+username+"&j_password="+password;
								xhr( loginUrl ,{
									handleAs: "text",
									method: "POST",
									data: loginData
								}).then(
									function(){
										alert("注册成功！");
										// 登录成功后页面跳转
										window.location.href = "/index2.html";
										
									},
									function(){
										if(password != pwdConfirm){
											$("input:password#PasswdAgain").css("borderColor","#FF0000");
											dom.byId("errormsg_0_PasswdAgain").innerHTML = "两次输入的密码不一致。是否重试？";
											domStyle.set("errormsg_0_PasswdAgain","color","red");
										}else{
											alert("密码一致，但其他情况导致登录失败,如已有账户登录！！");
										}
									}
								);
							}
						},
						function(msg){
							alert(msg);
						}
					);
				});
				
				//绑定回车事件
				var pwdInput = dom.byId("PasswdAgain");
				on(pwdInput, "keypress", function(e){
					if(e.keyCode == dojo.keys.ENTER){
						if(!$("#TermsOfService").attr("checked")){
							$("input:checkbox#TermsOfService").css("borderColor","#FF0000");
							dom.byId("errormsg_0_TermsOfService").innerHTML = "要使用我们的服务，您必须同意接受 Glue 的服务条款。";
							domStyle.set("errormsg_0_TermsOfService","color","red");
							dom.byId("TermsOfService").focus();
						}else{
							on.emit(
								dom.byId("signUp"),
								"click",
								{
									bubbles: true,
									cancelable: true
								}
							);
						}
					}
				});
				
				// 清空输入信息
				function clearInput(){
					dojo.attr("UserName","value","");
					dojo.attr("RealName","value","");
					dojo.attr("Passwd","value","");
					dojo.attr("PasswdAgain","value","");
					dojo.attr("TermsOfService","checked",false);
				}
				
				// 判读是否是gutil，进行不同的跳转
					function isGutil(url){
						// 判断参数
						if(!url){
							console.error("[isGutil ERROR]: url is undefined!");
							return;
						}
						var urlMap = Spolo.getUrlVars();
						var isGutil = urlMap["isGutil"];
						if(!isGutil){
							window.location.href = url;
						}else{
							Spolo.redirect(url);
						}	
					}
				
				//页面初始化后默认激活用户名输入框
				dom.byId("UserName").focus();
				domStyle.set("UserName-infomessage","display","block");
				
				// 使用Spolo.redirect() 进行登录跳转
				on(dom.byId("link-signin"),"click",function(){
					var url = "/modules/user/index.html";
					isGutil(url);
				});
				
				// 使用Spolo.redirect() 进行"直接登录"跳转
				on(dom.byId("direct_signin"),"click",function(){
					var url = "/modules/user/index.html";
					isGutil(url);
				});
			});
			
			// 验证用户名是否存在的方法
			var isExist = false;
			function validataUsername(username, onExist, onNotExist){
				// 参数数量的判断
				if(arguments.length < 1){
					throw("validataUsername() must be have one arguments!");
				}
				
				if(!username || typeof username != "string")
				{
					throw("validataUsername() " + username + " is null or type of " + username + " is not string !");
				}
				
				var url = "/system/userManager/user.1.json"
				xhr(url,{
					handleAs: "json",
					method: "GET"
				}).then(
					function(data){
						isExist = false;
						for(var key in data){
							if(key == Spolo.encodeUname(username)){
								isExist = true;
							}
						}
						if(isExist){
							// 用户名已经存在
							onExist();
							isExist = true;
						}else{
							// 用户名未存在
							onNotExist();
							isExist = false;
						}
					},
					function(msg){
						throw(msg);
					}
				);
			}
			
			//检查用户名是否为email邮箱  
			function isEmail(text){
				
				// 整个用户名的命名规则
				var pattern = /^([a-zA-Z0-9]|[.])+@([a-zA-Z0-9])+((\.[a-zA-Z0-9]{2,3}){1,2})$/;
				// 判断整个用户名是否符合上述规则
				var flag = pattern.test(text);
				
				var temp = text;
				if(typeof(text) == "object"){
					temp = text.toString();
				}
				
				// 1.判断用户名的首字符 --- 字母(a-z)或数字
				// 截取用户名的首字符
				var first_char = temp.substring(0,1);
				// 用户名首字符规则 --- 字母(a-z)或数字
				var reg_first = /^[a-zA-Z0-9]{1}$/;
				// 判断用户名首字符是否满足正则表达式 --- 字母(a-z)或数字
				var first_bool = reg_first.test(first_char);
				
				// 2.判断@以前的最后一个字符 --- 字母(a-z)或数字
				// 截取@以前部分字符串
				var email_uname = temp.split('@')[0];
				// 截取@以前的最后一个字符
				var last_uname = email_uname.substring(email_uname.length-1);
				// @以前最后一个字符的规则 --- 字母(a-z)或数字
				var reg_last = /^[a-zA-Z0-9]{1}$/;
				// 判断@以前最后一个字符是否符合要求 --- 字母(a-z)或数字
				var last_bool = reg_last.test(last_uname);
				
				// 判断用户名是否满足规则并返回值
				if(flag && last_bool && first_bool)
				{
					return true;
				}else{
					// 初始化错误提示信息
					var innerhtml = "";
					// 逐一对用户名各个部分进行判断
					if(flag){
						if(!first_bool && last_bool){
							innerhtml = "用户名请以字母(a-z)或数字开头。" 
						}else if(first_bool && !last_bool){
							innerhtml = "用户名@以前请使用字母(a-z)或数字结束。";
						}else{
							innerhtml = "用户名@以前部分请以字母(a-z)或数字开头和结束。";
						}
					}else{
						if(!first_bool && last_bool){
							innerhtml = "用户名请使用字母(a-z)、数字或英文句点;并且请以字母(a-z)或数字开头。" 
						}else if(first_bool && !last_bool){
							innerhtml = "用户名请使用字母(a-z)、数字或英文句点;并且@以前请使用字母(a-z)或数字结束。";
						}else if(first_bool && last_bool){
							innerhtml = "用户名请使用字母(a-z)、数字或英文句点。";
						}else{
							innerhtml = "用户名请使用字母(a-z)、数字或英文句点,且@以前部分请以字母(a-z)或数字开头和结束。";
						}
					}
					// 设置错误提示格式
					$("input:text#UserName").css("borderColor","#FF0000");
					dom.byId("errormsg_0_UserName").innerHTML = innerhtml;
					domStyle.set("errormsg_0_UserName","color","red");
					dom.byId("errormsg_0_UserName").focus();
					return false;
				}
			}
			
			/** 判断密码强度代码 begin */
			//checkStrong函数 
			//返回密码的强度级别
			function checkStrong(spw){
				if(spw.length < 6){
					updatePasswordBar(0); //太短
				}else{
					var modes = 0;
					for (i=0 ; i<spw.length ; i++){
						//测试每一个字符的类别并统计一共有多少种模式. 
						modes|=CharMode(spw.charCodeAt(i)); 
					}
					return bitTotal(modes);
				}
			}
			
			//bitTotal函数 
			//计算出当前密码当中一共有多少种模式 
			function bitTotal(num){
				var Modes=0; 
				for (i=0;i<4;i++){ 
					if (num & 1) Modes++;
					num>>>=1; 
				} 
				return Modes;
			}
			
			//CharMode函数 
			//测试某个字符是属于哪一类. 
			function CharMode(iN){
				if (iN>=48 && iN <=57) //数字 
				return 1; 
				if (iN>=65 && iN <=90) //大写字母 
				return 2; 
				if (iN>=97 && iN <=122) //小写 
				return 4; 
				else 
				return 8; //特殊字符 
			}
			
			//pwStrength函数 
			//当用户放开键盘或密码输入框失去焦点时,根据不同的级别显示不同的颜色
			function checkPass(pwd){
				if (pwd==null||pwd==''){ 
					updatePasswordBar(0); 
				}else{
					S_level=checkStrong(pwd);
					switch(S_level) { 
						case 1: 
							updatePasswordBar(1); //弱 一种
							break;
						case 2: 
							updatePasswordBar(2); //一般 两种
							break; 
						case 3: 
							updatePasswordBar(3); //强 三种
							break; 
						case 4: 
							updatePasswordBar(3); //强 四种
							break;
						default: 
							updatePasswordBar(0);
					} 
				}
				return; 
			}
			
			//设置进度条
			function updatePasswordBar(rating){
				var ratingClasses = new Array(5);
				ratingClasses[0] = 'short';
				ratingClasses[1] = 'weak';
				ratingClasses[2] = 'fair';
				ratingClasses[3] = 'strong';
				ratingClasses[4] = 'notRated';
				
				var ratingMessages = new Array(5);
				ratingMessages[0] = '太短';
				ratingMessages[1] = '弱';
				ratingMessages[2] = '一般';
				ratingMessages[3] = '强';
				ratingMessages[4] = '未评级';
				var bar = document.getElementById('strength-bar');
				if (bar) { 
					var message = document.getElementById('passwdRating');
					var barLength = document.getElementById('passwdBar').clientWidth;
					bar.className = ratingClasses[rating];
					if (rating >= 0 && rating <= 3){
						bar.style.width  = (barLength * (parseInt(rating) + 1.0) / 5.0) + 'px';
						message.innerHTML = ratingMessages[rating];
					}else {
						bar.style.width = 0;
						rating = 4; 
					}
					domStyle.set("Passwd-infomessage","display","block");
				}
			}
			/** 判断密码强度代码 end */
			
			$(function(){
				var emptyText = "此处不能为空,请重新输入！！！";
				//input:text
				$("input:text")
				.blur(function(){
					var text = document.getElementById(this.id).value;
					var id = "errormsg_0_" + this.id;
					var messageId = this.id + "-infomessage";
					var messageElement = document.getElementById(messageId);
					if(messageElement){
						domStyle.set(messageElement,"display","none");
					}
					if(text == ""){
						$(this).css("borderColor","#FF0000");
						dom.byId(id).innerHTML = emptyText;
						domStyle.set(id,"color","red");
						dom.byId(id).focus();
					}else{
						if(this.id == "UserName"){
							if(isEmail(text)){
								// 调用用户名是否存在的判断方法
								validataUsername(
									text,
									function(){
										$("input:text#UserName").css("borderColor","#FF0000");
										dom.byId(id).innerHTML = "该用户名已经存在，请重试！！";
										domStyle.set(id,"color","red");
										dom.byId(id).focus();
									},
									function(){
										$("input:text#UserName").css("borderColor","#FFF");
										dom.byId(id).innerHTML = "恭喜您，该用户名可用！";
										domStyle.set(id,"color","green");
									}
								);
							}
						}else{
							$(this).css("borderColor","#FFF");
							dom.byId(id).innerHTML = "";
						}
					}
				})
				.focus(function(){
					var id = "errormsg_0_" + this.id;
					var messageId = this.id + "-infomessage";
					$(this).css("borderColor","#4d90fe");
					dom.byId(id).innerHTML = "";
					var messageElement = document.getElementById(messageId);
					if(messageElement){
						domStyle.set(messageElement,"display","block");
					}
				})
				
				//input:password
				$("input:password")
				.blur(function(){
					var password = document.getElementById(this.id).value;
					var id = "errormsg_0_" + this.id;
					var messageId = this.id + "-infomessage";
					var messageElement = document.getElementById(messageId);
					if(messageElement){
						domStyle.set(messageElement,"display","none");
					}
					if(password == ""){
						$(this).css("borderColor","#FF0000");
						dom.byId(id).innerHTML = emptyText;
						domStyle.set(id,"color","red");
						dom.byId(id).focus();
					}else{
						if(this.id == "Passwd" && password.length < 6){
							$(this).css("borderColor","#FF0000");
							dom.byId(id).innerHTML = "密码太短，请至少使用6个字符！";
							domStyle.set(id,"color","red");
							dom.byId(id).focus();
							return;
						}
						if(this.id == "PasswdAgain" && (dom.byId('Passwd').value != "")){
							var PasswdAgain = dom.byId('PasswdAgain').value;
							var Passwd = dom.byId('Passwd').value;
							if(PasswdAgain != Passwd){
								$(this).css("borderColor","#FF0000");
								dom.byId(id).innerHTML = "两个密码不匹配。是否重试？";
								domStyle.set(id,"color","red");
								dom.byId(id).focus();
							}
							$(this).css("borderColor","#FFF");
							dom.byId(id).innerHTML = "";
						}
						$(this).css("borderColor","#FFF");
						dom.byId(id).innerHTML = "";
					}
				})
				.focus(function(){
					if(this.id == "Passwd"){
						var pwd = dom.byId("Passwd").value;
						checkPass(pwd);
					}
					var id = "errormsg_0_" + this.id;
					var messageId = this.id + "-infomessage";
					$(this).css("borderColor","#4d90fe");
					dom.byId(id).innerHTML = "";
				})
				.keyup(function(event){
					if(this.id == "Passwd"){
						var pwd = dom.byId("Passwd").value;
						checkPass(pwd);
					}
				})
				
				//input:checkbox
				$("input:checkbox").blur(function(){
					if(!$(this).attr("checked")) {
						$(this).css("borderColor","#FF0000");
						dom.byId("errormsg_0_TermsOfService").innerHTML = "要使用我们的服务，您必须同意接受 Glue 的服务条款。";
						domStyle.set("errormsg_0_TermsOfService","color","red");
						dom.byId("TermsOfService").focus();
					}else{
						dom.byId("errormsg_0_TermsOfService").innerHTML = "";
						$(this).css("borderColor","#FFF");
						$(this).attr("checked",true);
					}
				})
				.click(function(){
					$(this).blur();
				})
				.keyup(function(event){
					if(event.keyCode == dojo.keys.ENTER){
						//调用“注册”按钮点击事件
						on.emit(
							dom.byId("signUp"),
							"click",
							{
								bubbles: true,
								cancelable: true
							}
						);
					}
				})
			});
		});
	</script>
	
	<body>
		<div class="wrapper">
			<div class="google-header-bar">
				<div class="header content clearfix">
					<img class="logo" src="./images/logo.png" alt="Glue">
					<span class="signin-button">
						<!-- <a  id="link-signin" class="g-button" href="/modules/user/index.html" >登录</a> -->
						<a  id="link-signin" class="g-button" style="cursor:pointer;" >登录</a>
					</span>
				</div>
			</div>
			<div class="signuponepage main content clearfix">
				<div class="clearfix">
					<div class="sign-up">
						<div class="signup-box">
							<form class="createaccount-form" id="createaccount" name="createaccount" action="" method="post">
								<div class="form-element email-address" id="gmail-address-form-element">
									<label id="gmail-address-label">
										<strong>用户名</strong>
										<input type="text" name="username" id="UserName" value="" spellcheck="false">
									</label>
									<div class="infomsg" id="UserName-infomessage">用户名不能为空，且必须使用email邮箱，您可以使用字母、数字、英文句点等。</div>
									<span role="alert" class="errormsg" id="errormsg_0_UserName"></span>
								</div>
								<div class="form-element multi-field name" id="name-form-element">
									<fieldset>
										<strong>真实姓名</strong>
										<label id="lastname-label" class="lastname" style="width:310px;">
											<input type="text" maxlength="24" name="realname" id="RealName" value="" spellcheck="false">
										</label>
									</fieldset>
									<div class="infomsg" id="RealName-infomessage">请输入您的真实姓名。</div>
									<span role="alert" class="errormsg" id="errormsg_0_RealName"></span>
								</div>
								<div class="form-element" id="password-form-element">
									<label id="password-label">
										<strong>设置密码</strong>
										<input type="password" maxlength="20" name="Passwd" id="Passwd" >
									</label>
									<div class="infomsg" id="Passwd-infomessage">
										<div class="password-strength">
											<p>
												<strong>密码强度：</strong>
												<span id="passwdRating"></span>
											</p>
											<div class="meter" id="passwdBar">
												<span id="strength-bar"></span>
											</div>
										</div>
										<div>
											请至少使用 6 个字符。请勿使用您用于登录其他网站的密码或容易被猜到的密码（例如您宠物的名字）。
										</div>
									</div>
									<span role="alert" class="errormsg" id="errormsg_0_Passwd"></span>
								</div>
								<div class="form-element" id="confirm-password-form-element">
									<label id="confirm-password-label">
										<strong>确认密码</strong>
										<input  type="password" maxlength="20" name="PasswdAgain" id="PasswdAgain" >
									</label>
									<span role="alert" class="errormsg" id="errormsg_0_PasswdAgain"></span>
								</div>
								<div class="form-element terms-of-service" id="termsofservice-form-element">
									<label id="termsofservice-label">
										<input  type="checkbox" value="yes" name="TermsOfService" id="TermsOfService"  >
										<span id="terms-of-service-label">
											<strong>我同意接受 Glue 的服务条款和隐私权政策。</strong>
										</span>
									</label>
									<span role="alert" class="errormsg" id="errormsg_0_TermsOfService"></span>
								</div>
								<div class="form-element nextstep-button">
									<a name="submitbutton" id="signUp" class="g-button g-button-submit">注册</a>
								</div>
							</form>
						</div>
					</div>
					<style>
						.product-info { margin: 0 385px 0 0; }
						.product-info a:visited { color: #61c; }
						.features { overflow: hidden; margin: 2em 0 0;}
						.features li { margin: 3px 0 2em; padding:15px;}
						.features img { float: left; margin: -3px 0 0; }
						.features p { margin: 0 0 0 68px; }
						.features .title { font-size: 16px; margin-bottom: .3em; }
					</style>
					<div class="product-info ">
						<h1 class="redtext">创建新的 Glue 帐户</h1>
						<p>注册 Glue 帐户，享受 Glue 提供的更多服务。
						<p>在右侧注册，或 <a  id="direct_signin" style="cursor:pointer;">直接登录帐户</a>。</p>
						<ul class="features clearfix">
							<li>
								<img src="./images/blender.png" alt="">
								<p class="title">Glue</p>
								<p>针对家具和鸟瞰图等需求进行渲染。</p>
							</li>
							<li>
								<img src="./images/blender.png" alt="">
								<p class="title">个性化渲染</p>
								<p>定制模型的摆放位置，编辑材质。</p>
							</li>
							<li>
								<img src="./images/weibo.png" alt="">
								<p class="title">喜欢 Glue 吗？</p>
								<p><a href="http://weibo.com/u/2827536267">在微博上粉一下吧。</a></p>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<div class="google-footer-bar">
				<div class="footer content clearfix">
					<ul id="footer-list">
						<li>版权所有 © 北京飞鹿科技发展有限公司 保留所有权利</li>
					</ul>
				</div>
			</div>
		</div>
	</body>
</html>
