<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<title>我的场景</title>
		
		<script type="text/javascript">
			var dojoConfig = {
				parseOnLoad: true, 
				packages:[
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name:"spolo",
						location:"/script/spolo"
					}
					
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="css/main.css" media="screen">
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<link rel="stylesheet" href="/widgets/Pagination/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/List/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Toolbar/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
	</head>
	
	<body class="claro">
		<div data-dojo-type="dijit/layout/BorderContainer" style="width: 100%; height: 100%;margin:0px;" gutters="false">
			<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'" gutters="false">	
				<div class="search" id="search"></div>
				<button type="button" class="btnSearch" id="btnSearch"></button>
				<div class="btnGroup">
					<!-- <div class="selectBtn">全选</div>
					<div id="listType">列表</div>
					<div id="editBtn">编辑</div> -->
				</div>
			</div>
			<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'" gutters="false">		
				<div id="sceneList"></div>				
			</div>
			<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'bottom'" gutters="false" style="height:40px;">		
				<div id="pager"></div>
			</div>
		</div>	
		<script>
			require(
				[
					"widgets/List/List",
					"widgets/Toolbar/Toolbar",
					"dojo/on",
					"dojo/query",
					"dijit/Dialog",
					"dijit/form/FilteringSelect",
					"dojo/keys",
					"widgets/Pagination/Pagination",
					"dojo/dom-style",
					"dojo/dom",
					"spolo/data/folder",
					"dijit/form/Button",
					"spolo/data/scene",
					"spolo/data/folder/scenelib",
					"dojo/_base/array",
					"widgets/Mask/Mask"
				],
				function
				(
					List, Toolbar, on, query, Dialog, FilteringSelect, keys, Pagination,
					dom_style, dom, folder_cls, Button, scene_cls, scenelib, arrayUtil, Mask
				)
				{
					var varsMap = Spolo.getUrlVars();
					var isGutil = varsMap ['isGutil'];
					//创建List widget对象
					var list = new List();
					list.placeAt("sceneList");
					//创建Toolbar widget对象
					var toolbar = new Toolbar({
						sortable : true,
						selectAll : true,
						editable : true,
						gridList : true,
						rowList : true
					});
					toolbar.placeAt(query(".btnGroup")[0]);
					var currentPage = 1;
					var perPageNum = 10;
					var widget;
					var inputvalue;
					
					// 监听点击图片触发事件
					on(list,"onListItemClick",function(nodeData)
					{
						onListItemClick(nodeData);
					});
					
					// 监听点击弹出的编辑UI按钮
					on(list,"onEditItemClick",function(scenepath){
						onEditItemClick(scenepath);
					});
					
					// 监听点击删除场景的事件
					on(list,"onDelItemClick",function(data){
						onDelItemClick(data);
					});
					
					// toolbar 排序事件
					on(toolbar,"sortable",function(data){
						queryScene(function(json, num){ 
							refreshData(json["data"],json["totalNum"]); 
						}, data);
					});
					// toolbar 全选/取消按钮切换事件
					on(toolbar,"selectAll",function(data){
						if(data){
							list.selectAll();
						}else{
							list.unSelectAll();
						}
					});
					// toolbar 编辑事件
					on(toolbar,"editable",function(data){
						if(data){
							list.openEdit();
						}else{
							list.closeEdit();
						}
					});
					// toolbar 大图事件
					on(toolbar,"gridList",function(data){
						if(data == true){
							list.showThumbnail();
						}
					});
					// toolbar 列表事件
					on(toolbar,"rowList",function(data){
						if(data == true){
							list.showList();
						}
					});
					
					initUI();
					initSceneList();
					var dialog = initDelDialog();
					
					// 初始化UI(搜索框/查询按钮)显示
					function initUI()
					{
						//初始化搜索框
						var filteringSelect = new FilteringSelect({
							searchAttr: "resourcename",
							style:"margin:15px 0 20px 32%;height:22px;width:360px;font-size:15px;padding:2px 0 2px 0",
							hasDownArrow:false,
							forceWidth:true,
							required:false,
							invalidMessage:false,
							trim:true,
							autoComplete:false,
							onKeyUp:function(evt)
							{
								inputvalue = filteringSelect.get('displayedValue');
								switch(evt.keyCode)
								{
									case keys.ENTER:
										if(inputvalue.trim() != ""){
											queryScene.call(this,function(data,num){
												refreshData(data["data"],data["totalNum"]);
											});
											
										}
										break;
								}
							},
							validate:function() 
							{
							}
						}, "search");
						
						var btnSearch = new Button({
							label:"查询",
							style:"font-size:14px;margin:-4px 0 0 25px;",
							onClick:function(){
								if(inputvalue.trim() != ""){
									queryScene.call(this,function(data,num){
										refreshData(data["data"],data["totalNum"]);
									});
								}
							}
						},"btnSearch");
					}
					
					// 初始化场景列表显示
					function initSceneList()
					{
						var _this = this;
						queryScene(function(data,num)
						{
							//动态加载场景预览图
							setImage(data["data"]);
							setSceneName(data["data"]);
						    addSceneTime(data["data"]);//添加场景时间
							setFormat(data["data"]);
							setSceneStateDiv(data["data"]);
							var total = data["totalNum"];
							var totalPage = getTotalPage(total);
							var json = 
							{
								total:totalPage
							};
							widget = new Pagination(json).placeAt("pager");
							
							on(widget,"onClickPage",function(data)
							{
								currentPage = data.nowPage;
								queryScene(function(json,num){
									refreshData(json["data"],json["totalNum"]);
								});
							});
						});
					}
					
					// 初始化删除的确认Dialog
					function initDelDialog()
					{
						var temp = "<center><label>确定删除该场景吗？</label><br />"+
									"<button id='Sure'></button>"+
									"<button id='Cancel'></button></center>";
						var dialog = new Dialog({
							title: "删除场景",
							content: temp,
							style: "width: 200px;position:relavite;top:20px;font-size:12px"
						});
						var sureBtn = new Button({
							label:"确定"
						},"Sure");
						var cancelBtn = new Button({
							label:"取消"
						},"Cancel");
						
						return dialog;
					}
					
					function getTotalPage(total)
					{
						var totalPage;
						if(total % perPageNum == 0){
							totalPage = total / perPageNum;
						}
						else 
						{
							totalPage = Math.ceil(total / perPageNum);
						}
						return totalPage;
					}
					// 显示场景类型
					function setFormat(data){
						for(var key in data){
							list.addDomNode(key,"<div>场景类型：" + data[key]["format"] + "</div>");
						}
					}
					
					//显示场景预览图
					function setImage(data){
						var listData = data;						
						var array = new Array();
						for(var key in listData){
							array.push(key);
						}		
						list.addItems(array,true);	// 这里会刷新List组件	
						arrayUtil.forEach(array, function(item){
							scene_cls.getPreview(
								item,
								function(urls){
									for(var url in urls){
										if(url != "hasObject" && urls[url]){
											list.setItemImage(item, urls[0]);
										}
									}
								},
								function(error){								
									// 执行一个默认的效果图
									list.setItemImage(item, "images/nopreview.jpg");									
								});								
						});
						
						
					}
					
					//设置场景的名字
					function setSceneName(data)
					{
						for(var key in data){
							list.addDomNode(key,"<div>名称：" + data[key]["resourceName"] + "</div>");
						}
					}
					//添加场景时间
					function addSceneTime(data){
						for(var key in data){
							var datatime = data[key]["jcr:created"];
							datatime = datatime.substr(0,datatime.indexOf("."));
							datatime = datatime.split("T");							
							if(datatime[0]&&datatime[1]){
								list.addDomNode(key,"<div>时间：" +datatime[0]+"\t"+datatime[1] + "</div>");
							}else{
								list.addDomNode(key,"<div>时间：" +"无时间"+ "</div>");
							}
						}
					}
					// 设置场景的状态
					function setSceneStateDiv(data){
						for(var key in data)
						{
							list.addDomNode(key,"<div></div>");
						}
					}
					
					//设置场景列表初始化
					function setSceneItems(data)
					{
						var array = [];
						for(var key in data)
						{
							array.push(key);
						}
						list.addItems(array,true);	// 这里会刷新List组件
					}
					
					//查询我的场景列表
					function queryScene(callback,params){
						var offset = (currentPage - 1) * perPageNum;
						var queryData = {
							"fuzzyProperties" : { 
								"resourceName":inputvalue
							},// 查询条件 , 可以有也可以没有
							"offset" : offset.toString(),
							"limit" : perPageNum,
							success : function(data,num){
								callback(data,num);
							},
							failed : function(error){
								console.log(error);
							}
						};
						if(params != undefined){
							var sortName = params["sortName"];
							var order = params["order"];
							queryData[order] = sortName;
						}
						//scenelib.getScenesByQuery(queryData);
						scenelib.searchforScenes(queryData);
					}
						
					//刷新数据的方法
					function refreshData(data,num){
						setSceneItems(data);//刷新场景列表						
						setImage(data);//设置场景的缩略图
						setSceneName(data);//设置场景的名字
						addSceneTime(data);//刷新时添加场景时间
						setFormat(data);
						setSceneStateDiv(data);//设置场景的状态
						widget.refresh(getTotalPage(num));//刷新分页显示	
						if(inputvalue.trim() != ""){
							for(var key in data){
								var modelpath = key;
								var modelname = data[key]["resourceName"];
								var field = list.getField(modelpath,1);
								var modelnameToLower = modelname.toLowerCase();
								var filterValueToLower = inputvalue.toLowerCase();
								var array = [];
								for(var i = 0; i < modelnameToLower.length; i ++)
								{
									if(filterValueToLower.length > modelnameToLower.length)
									{
										return;
									}
									var string2 = "";
									for(var index = 0; index < filterValueToLower.length; index ++)
									{
										string2 += modelnameToLower[index+i];
										if(string2 == filterValueToLower)
										{
										array.push(i);
										console.log(array);
										}
									}
								}
								var lightStr = "";
								for(var index = 0;index < array.length;index ++){
									var start = array[index-1]+filterValueToLower.length;
									if(start == undefined){
										start = 0;
									}
									var perlightvalue = modelname.substring(start,array[index]);
									var lightvalue = modelname.substring(array[index],array[index]+filterValueToLower.length);
									var lastlightvalue = "";
									if(index == array.length-1){
										lastlightvalue = modelname.substring(array[index] + filterValueToLower.length, array[index+1]);
									}
									lightStr += perlightvalue + "<span style=\"background-color:#ff0;\">"+lightvalue+"</span>" + lastlightvalue;	
								}
								list.setField(field, "名称："+lightStr);
							}
						}
					}
					//得到某个场景的状态
					function getSceneState(nodeData,callback)
					{
						scenelib.getSceneStatus({
							"path" : nodeData,
							success : function(sucdata){
								callback(sucdata);
							},
							failed : function(error){
								console.log(error);
							}
						});
					}
					
					function onListItemClick(nodeData){
						var scenePath = nodeData;
						getSceneState.call(this,nodeData,function(scenestate){
							if(scenestate["isProcessing"] > 0)
							{
								if(isGutil == "true")
								{
									console.log("点击场景的地址为：");
									console.log(scenePath);
									Mask.show();
									var resource = scenePath + ".download"
									var url = "http://127.0.0.1:10828/download?method=POST";//?resource="+resource+"&";
									var content = {};
									content.resource = resource;
									require(["dojo/request/iframe"], function(iframe){
										iframe(url, {
											method : "GET",
											handleAs: "text",
											data: content
										}).then(
											function(data){  
												// 成功
												Mask.hide();
												console.log(data);
											}, 
											function(err){	
												// 失败
												console.log(err);
											}, 
											function(evt){	
											}
										);
									});
								}
								else
								{
									window.location.href="../scenedetail/index.html?path=" + scenePath;
								}
							}
							else{
								Spolo.notify({
									"text" : "正在加载中,请稍后....",
									"type" : "information",
									"timeout" : 1000
								});
							}
						});					
					}
					
					function onEditItemClick(scenepath){
						var url = "/modules/scenedetail/myscenelibEditSceneName.html";								
						var sceneNameField = list.getField(scenepath,1);
						var scenename = sceneNameField.innerHTML;
						var name = scenename.replace("<div>","").replace("名称：","").replace("</div>","");
						var dialogData = {
							widthradio: 0.3,
							heightradio:0.2,
							title:"修改场景",										
							url:url,
							data:{	
								"scenename":name,
								"scenepath":scenepath,
								"window": window
							},
							callback: function(spdialog){									
								spdialog.on("sceneRenameSuccess",function(data){
									list.setField(sceneNameField,"名称："+data);
								});
							}
						};
						Spolo.dialog(dialogData);							
					}
					
					function onDelItemClick(data){
						var uid = Spolo.getUserId();
						var userNodePath = "/content/users/" + uid;
						var scenelibPath = userNodePath + '/' + "scenelib";
						var previewlibPath = userNodePath + '/' + "previewlib";
						var scenelib_folder = new folder_cls(scenelibPath);
						var previewlib_folder = new folder_cls(previewlibPath);
						dialog.show();
						var data = data;
						on(dom.byId("Sure"),"click",function(){
							var list = [];
							scenePath = data.substring(data.lastIndexOf("/")+1);
							list.push(scenePath);
							scenelib_folder.batchRemove(list,
								function(){
									dialog.hide();
									//这里需要刷新数据
									queryScene(function(json,num){
										if(json["data"] == "{}"){
											if(currentPage > 1)
											{
												currentPage = currentPage - 1;
											}
											queryScene(function(data,num){
												refreshData(data["data"],data["totalNum"]);
											});
										}	
										refreshData(json["data"],num);
									});
								}
							);
							previewlib_folder.batchRemove(list);
						});
						on(dom.byId("Cancel"),"click",function(){
							dialog.hide();
						});	
					}
				});
		</script>
	</body>
</html>