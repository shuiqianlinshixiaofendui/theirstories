<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Glue test</title>
		<link rel="stylesheet" type="text/css" href="/libs/dijit/themes/claro/claro.css"  media="screen">
		<!-- <link rel="stylesheet" type="text/css"href="speich.net/fileUploader/resources/uploader.css"/> -->
		<link rel="stylesheet" type="text/css"href="css/Main.css"/>
		<script>
			dojoConfig = {
				parseOnLoad: true,
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					}/*,
					{ 
						name: 'snet',
						location: '/modules/uploadScene/speich.net'
					}*/
				],
			};
		</script> 
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script> 
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script> 
		<script type="text/javascript" src="/script/spolo.js"></script> 
	</head>
	<body  class="claro">	
			
		<div id="boxStep1" class="boxStep">
			首先，需要您输入场景名称：
			<br /><br />
			<input id="sceneName" promptMessage="新建场景的名称" class="inputBox" 
				data-dojo-type="dijit.form.ValidationTextBox" trim="true" value=""/>
		</div>
		
		<div id="boxStep2" class="boxStep">
			<form id='myform' action="/test/scene.create" method="POST" enctype="multipart/form-data" >
				然后，您可以把本地的场景模型打包上传；当然您也可以跳过此项。<br />
				<span style="line-height:30px;font-size:12px;">					
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<b>请保证上传的zip包中所有模型的单位都统一为mm(毫米)</b>。
				</span>
				<br />
				<input name="选择文件" id="selectFile" type="file" />
				<div class="isX3d" style="margin-top:15px;"><input checked="checked" name="x3d" type="checkbox" />同时生成Web3D资源。如果勾选此项，上传的过程可能会很长。</div>
				<div class="deleteNoMaterialModel" style="margin-top:15px;"><input name="x3d" type="checkbox" />删除材质不全的模型</div>
				<div class="checkDiffuse" style="margin-top:15px;"><input name="x3d" type="checkbox" checked="checked"/>强制检查帖图</div>
			</form>
		</div>
		
		<div id="boxStep3" class="boxStep">
			点击此按钮
			<input type="button" id="btnSubmit" style="width:90px; height:30px;" value="新建场景" />
		</div>
		<div id="uploadInfo">console:<br /></div>
<script>
	
	function initialize(){

		require([
			"dojo/request/xhr",
			"dojo/dom", 
			"dojo/on", "dijit/form/ValidationTextBox",
			"spolo/data/scene",
			"spolo/data/spsession",	
			"dojo/ready",
			"dojo/query",
			"dojo/json"
		],function(xhr, dom, on, ValidationTextBox, 
				scene_class, spsession_class, ready, query,jsonUtil){
			ready(function(){
			
				var uid = Spolo.getUserId();
				
				// 构造一个 session 对象
				var sessionPath = "/content/users/"+uid+"/scenelib";
				var spsession = new spsession_class(sessionPath);
				//输入框名字设置，有则不操作
				on(dom.byId("selectFile"),"change",function(){	
					var scenename = dom.byId("sceneName").value;					
					if(this.value!=null && scenename==""){					   
						var index = this.value.lastIndexOf("\\");
						var last = this.value.lastIndexOf(".");
						var file_name = this.value.substring(index+1,last);				
						dom.byId("sceneName").value = file_name;
					}					
				});
				// 提交表单
				on(dom.byId("btnSubmit"),"click",function(){
					// 记录用户是否选择了文件
					var isSelectFile = false;
					
					// 判断用户是否输入场景名
					var sceneName = dom.byId("sceneName").value;
					if(!sceneName){
						dom.byId("sceneName").focus();
						return;
					}
					
					// 判断用户是否选择文件
					var selectFile = dom.byId("selectFile").value;
					if(selectFile){
						isSelectFile = true;
					}

					dom.byId("btnSubmit").disabled = true;
					
					// 创建场景节点成功的回调函数
					function success(scenePath){
						var scene = new scene_class(scenePath);
						// 提交场景文件包方式创建场景成功
						if(isSelectFile){
							uploadSceneFile(scene);
						}else{   
							// 创建空场景成功
							scene.createEmptyScene(
								function(suc){
									window.location.href = "../scenedetail/index.html?path="+scenePath;
								},
								function(err){
									throw(err);
								}
							);
						}
					}
					// 创建场景节点
					createSceneNode(sceneName, isSelectFile, success);
				});
				
				
				// 调用 spsession 添加节点
				// 保存场景
				function createSceneNode(sceneName, isFileScene, success){
					// 新创建场景的节点名
					var sceneNodeName = Spolo.CreateNodeName("scene");	
					// 新创建场景在jcr中的路径
					var scenePath = sessionPath + '/' + sceneNodeName;	
					// Tue Apr 23 2013 16:59:09 GMT+0800 (CST)
					//var publishdate = new Date().toString().replace("中国标准时间","CST");
					var sceneJson = {
						nodePath : sceneNodeName,
						property : {
							resourceName : sceneName,
							"sling:resourceType":"scene",
							//"isProcessing": "2"
							"isProcessing": "2",
							//"publishdate": publishdate,
							"publishAuthor": uid
						}
					};
					if(isFileScene){	// 如果是上传文件方式的新建场景，添加一个正在处理的标识
										// 此标识由后端Python拆分完场景之后修改为 false
										// 我的场景模块中点击场景时，如果此属性为 true，则不能打开。
						sceneJson["property"]["isProcessing"] = "0";
					}
					spsession.addNode(sceneJson);
					// 如果创建空场景，
					// 则默认在场景下添加 model 节点，避免获取模型列表时出现404错误。
					//if(isFileScene==false){
						spsession.addNode({
							nodePath: scenePath + "/model",
							property : {
								"sling:resourceType":"folder"
							}
						});
						spsession.addNode({
							nodePath: scenePath + "/material",
							property : {
								"sling:resourceType":"folder"
							}
						});
					//}
					
					// 保存场景节点
					spsession.save({
						success : function(spnode){
							var url = scenePath;
							var content = {};
							
							content["_charset_"] = "UTF-8";
							content["publishdate"] = (new Date()).toISOString();
							content["publishdate@TypeHint"] = "Date";

							xhr(url, {
								handleAs: "text",
								method: "POST",
								data: content
							}).then(
								function(msg) {
									success(scenePath);
								}, 
								function(e) {
									console.error("[ERROR]: createPublishdate occurs wrong"+ e);
									return;
								}
							);
						},
						failed: function(err){
							throw(err);
						}
					});
				}
			
				// 上传场景文件包
				function uploadSceneFile(scene){
					// x3d属性
					var x3d = query(".isX3d input[type='checkbox']:checked")[0] ? true : false;
					var deleteNoMaterialModel = query(".deleteNoMaterialModel input[type='checkbox']:checked")[0] ? true : false;
					var checkDiffuse = query(".checkDiffuse input[type='checkbox']:checked")[0] ? true : false;					
					var dscene = scene;
					scene.upload("myform",{
						x3d : x3d,
						del_err_obj : deleteNoMaterialModel,
						checkDiffuse:checkDiffuse,
						//debug : false,
						resumable : true,	// 是否使用断点续传；如果断点续传就不支持实时消息了。
						notifier : function(msg){
							displayMessage("<font color='green'>"+msg+"</font>");
						},
						load : function(data){
							/*if(data && data.result && data.result.success){
								var success = data.result.success;
								if(success==true || success=="true"){
									displayMessage("<font color='green'>成功!</font>");
									displayMessage("<font color='yellow'></font>");
									showSceneDetailMessage(dscene);
									dom.byId("btnSubmit").disabled = false;
								}else{
									displayMessage("<font color='red'>失败!</font>");
								}
							}*/
							var dataStr = jsonUtil.stringify(data);
							if(dataStr.indexOf("suc : false")==-1){
								displayMessage("<font color='green'>成功!</font>");
								displayMessage(dataStr);
								showSceneDetailMessage(dscene);
								dom.byId("btnSubmit").disabled = false;
							}else{
								/*var reason = "ERROR:" + data.reason.replace(
															new RegExp("\\n",'g'),"\n<BR>").replace(
															new RegExp("\\r",'g'),"\r<BR>");*/
								displayMessage("<font color='red'>失败!</font>");
								displayMessage(dataStr);
							}
						},
						error : function(err){
							displayMessage("<font color=\"red\">ERROR:" + err +"</font>");
						}
					});
				}
				

				var uploadInfo;
				function displayMessage(msg){
					if(!uploadInfo){
						uploadInfo = dom.byId("uploadInfo");
					}
					uploadInfo.innerHTML += msg + "<br />"; 
				}
				
				function showSceneDetailMessage(scene){
					var scenePath = scene.getURI();
					var href = "../scenedetail/index.html?path="+scenePath;
					var msg = "<br /><br /><a href=\""+href+"\">点击这里查看场景详细...</a>";
					displayMessage(msg);
				}
				
				
				// 页面初始化的时候默认激活场景名称输入框
				dom.byId("sceneName").focus();
			});
			
		});
	}
	
	initialize();
	
</script>	
	</body>
</html>