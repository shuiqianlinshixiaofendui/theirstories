<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>模型基本信息</title>
		<script type="text/javascript" >
			dojoConfig = {
				//parseOnLoad: true, 
				packages: [
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name: "roomedit",
						location: "/modules/roomedit"
					}
				]
			};
		</script>
	
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script> 
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css"  media="screen"/>
		<link rel="stylesheet" href="css/main.css" media="screen"/>
		<link rel="stylesheet" href="/widgets/Category/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/CategorySelect/css/main.css" media="screen">
		<link rel="stylesheet" href="css/modelbasicinfo.css" />
	</head>	
	<body class="claro">
		<div>
			<div style="width:410px;height:410px;border:1px solid #ccc;position:absolute;top:20px;left:20px;">
				<div id="previewAnd3D" style="width:400px;height:400px;border:1px solid #ccc;position:absolute;top:4px;left:4px;">
					<iframe id="iframeX3d" name="web3d" frameborder="no" border="0" marginwidth="0" 
						marginheight="0" scrolling="no" allowtransparency="yes" style="width:100%;height:100%"
						src="">
					</iframe>
				</div>
				<!--预览图-->
				<div id="previewNodeDIV" style="width:400px;height:400px;position:absolute;top:4px;left:4px;">
					<img src="" id="previewNode" width="100%" height="100%" />
				</div>
				<div>
					<div id="viewPreview" class="viewPreview" style="cursor:pointer;position:absolute;top:442px;left:0px;">
						<!--当时理解反了，改过来，仅仅改了一下图片的显示-->
						<img src="image/rendering.png" id="x3dview" style="display:none;position:absolute;top:0px;left:0px;" title="查看3D场景"/>
						<img src="image/3dview.png" id="rendering" style="display:block;position:absolute;top:0px;left:0px;" title="查看效果图"/>
					</div>
					<div id="favpre" class="favpre" style="position:absolute;top:510px;left:0px;">
						<img src="image/favorite.png" id="addFavorM" style="display:none;position:absolute;top:0px;left:0px;" title="加入收藏夹"/>
						<img src="image/favorited.png" id="delFavorM" style="display:none;position:absolute;top:0px;left:0px;" title="取消收藏"/>
					</div>
					<div id="saveViewBtn" class="saveViewBtn" style="display:none;background:#3079ed;cursor:pointer;padding:8px;position:absolute;top:440px;left:190px;">
						<label style="color:#fff;cursor:pointer;font-size:15px;font-weight:bold;">保存视角</label>
					</div>
					<div id="uploadImg" class="uploadImg" style="display:none;background:#dddddd;cursor:pointer;padding:8px;position:absolute;top:440px;left:330px;">
						<label style="color:#000;cursor:pointer;">修改预览图</label>
					</div>
					<form id="previewForm" method="POST" enctype="multipart/form-data" >
						<input id="previewInput" name="previewPut" data-dojo-attach-point="fileInputNode" type="file" 
						style="height:0px; visibility:hidden;" />
					</form>
				</div>
			</div>
			<div style="position:absolute;top:20px;left:480px;">
				<div class="title" style="position:absolute;top:0px;left:0px;">
					<input type="text" value=""	id="modelresourcename" style="cursor:pointer;font-size:25px;width:350px;position:absolute;top:0px;left:20px;border:0;background:transparent;"/>
				</div>
				<div>
					<div class="publisher" style="position:absolute;top:60px;left:0px;">
						<span class="bukebian">发布者：</span>
						<label value="" id="modelpublisher" ></label>
					</div>	
					<div style="width:450px;height:1px;background:#dddddd;position:absolute;top:80px;left:10px;">
					</div>
					
					<div class="ptime" style="position:absolute;top:60px;left:220px;width:200px;">
						<span class="bukebian">发布时间：</span>
						<label value="" id="modelptime"></label>
					</div>
				
					<div class="morecount" style="position:absolute;top:90px;left:220px;"> 
                        <span class="bukebian">居室：</span> 
                        <label class="fenlei" id="mroom"></label>
                    </div> 
                    
                    <div class="morecount">
						<span class="bukebian" style="position:absolute;top:90px;left:0px;">面积：</span>
						<input type="text" value="0平方米" id="marea" style="cursor:pointer;width:100px;position:absolute;top:90px;left:40px;border:0;background:transparent;"></input>
					</div>
					<div style="width:450px;height:1px;background:#dddddd;position:absolute;top:210px;left:10px;">
					</div>
				</div>
				<div>
					<div>
						<span class="bukebian" style="position:absolute;top:223px;left:0px;">关键字：</span>
						<input type="text" value="" placeholder="请输入关键字" id="keyInfo"
								style="width:200px;cursor:pointer;border:0;background:transparent;position:absolute;top:220px;left:70px;"/>
					</div>
					<div class="morecount" style="position:absolute;top:260px;left:0px;width:400px;">
						<span class="bukebian">模型地址：</span>
						<label id="modelPath" class="fenlei"></label>
					</div>
					<div style="position:absolute;top:320px;left:0px;">
						<span style="background:#dddddd;text-align:center;padding:10px;position:absolute;top:0px;left:0px;width:50px;">模型介绍</span><br />
						<textarea data-dojo-type="dijit/form/SimpleTextarea" id="introduction" rows="8" style="width:400px;position:absolute;top:30px;left:0px;"></textarea>
					</div>
					
					<div id="saveBtn" class="save" style="display:none;position:absolute;top:520px;left:330px;cursor:pointer;">
						<img src="image/save.png" id="saveImg" style="position:absolute;top:0px;left:0px;" title="保存"/>
					</div>
					
				</div>
			</div>
		</div>
		
		<script type="text/javascript">
			require(
				[
					"dojo/parser",
					"dojo/ready",
					"dojo/on",
					"dojo/_base/array",
					"dijit/registry",
					"roomedit/js/ModelEditLogic",
					"dojo/query",
					"dojo/_base/lang",
					"dojo/dom",
					"dijit/form/ValidationTextBox",
					"dijit/layout/ContentPane",
					"dijit/layout/BorderContainer",
					"spolo/data/folder/favourite",
					"spolo/data/user",
					"dojo/domReady!"
				],
				function(
					parser, ready, on, arrayUtil, registry, ModelEditLogic,
					query, lang, dom, ValidationTextBox, ContentPane, BorderContainer,
					favourite, user
				){
					ready(function(){
						var path = getParameter("modelPath");
						var grant = false;
						var userName = Spolo.getUserId();
						user.isGranted(
							userName,
							path,
							function(result)
							{
								var varsMap = Spolo.getUrlVars();
								var isGrant = varsMap ['isGrant'];
								if(result == "True")
								{
									var saveViewBtn = dom.byId("saveViewBtn");
									saveViewBtn.style["display"] = "block";
									var uploadImg = dom.byId("uploadImg");
									uploadImg.style["display"] = "block";
									var saveBtn = dom.byId("saveBtn");
									saveBtn.style["display"] = "block";
									if(isGrant == "false")
									{
										hasNoGrant.call(this);
									}
									else
									{
										grant = true;
                                        
                                        var mroom = dom.byId("mroom"); 
                                        on(mroom, "click", function(){ 
                                                mroomClick.call(this, modelEditLogic, saveJson); 
                                        }); 
										
										on(saveBtn, "click", function(){
											saveBtnClick.call(this, modelEditLogic, saveJson);
										});
										
										on(saveViewBtn, "click", function(){
											saveViewBtnClick.call(this);
										});
										
										on(uploadImg, "click", function(){
											uploadImgClick.call(this, modelEditLogic);
										});
										
									}
								}
								else
								{
									hasNoGrant.call(this);
								}
							},
							function(error){
								throw error;
							}
						);
						var saveJson = {
							// saveJson里面的数据应该是这个样子的
							// resourceName: "未命名",
							// colorsystem:"请选择色系",
							// colorsystemPath:"",
							// style: "请选择风格",
							// stylePath: "",
							// madeOf: "请选择主材",
							// madeOfPath: "",
							// category: "请选择分类",
							// categoryPath: "",
							// brand:"请选择品牌",
							// brandPath:"",
							// room:"请选择居室类型",
							// roomPath:"",
							// sightfeeling:"请选择视觉感受",
							// sightfeelingPath:"",
							// price:"0.00",
							// keyInfo:"",
							// introduction:"请输入属性介绍",
						};
						
						// var path = "/content/modellib/model20134161538335951003017";
						var modelEditLogic = new ModelEditLogic(path);
						
						var iframeX3d = dom.byId("iframeX3d");
						iframeX3d.src = "/widgets/viewx3d/viewX3D.html?path=" + path;
						
						var previewNodeDIV = dom.byId("previewNodeDIV");
						previewNodeDIV.style["display"] = "none";
						
						//判断模型是否已经收藏
						favourite.isFavModel(
							path,
							function(isFav){//返回的是boolean值
								if(isFav)
								{
									var delFavorM = dom.byId("delFavorM");
									var addFavorM = dom.byId("addFavorM");
									delFavorM["style"]["display"] = "block";
									addFavorM["style"]["display"] = "none";
								}
								else
								{
									var delFavorM = dom.byId("delFavorM");
									var addFavorM = dom.byId("addFavorM");
									delFavorM["style"]["display"] = "none";
									addFavorM["style"]["display"] = "block";
								}
							},
							function(error){
								throw error;
							}
						);
						
						modelEditLogic.getModelProperties(function(propertiesJson){
							console.log(propertiesJson);
							saveJson = propertiesJson;
							dom.byId("modelresourcename").value = propertiesJson["resourceName"];
							dom.byId("modelpublisher").innerHTML = propertiesJson["publishAuthor"];
							dom.byId("modelptime").innerHTML = propertiesJson["publishdate"];
							dom.byId("marea").value = propertiesJson["area"];
							dom.byId("keyInfo").value = propertiesJson["keyInfo"];
							dom.byId("introduction").value = propertiesJson["introduction"];
                            
                            modelEditLogic.getModelRoom(propertiesJson["roomPath"],function(data){ 
                                    if(data==""){ 
                                            data = propertiesJson["room"]; 
                                    } 
                                    dom.byId("mroom").innerHTML = data; 
                                    saveJson["room"] = data; 
                                     
                            }); 
							
						});
						var rendering = dom.byId("rendering");
						on(rendering, "click", function(){
							renderingClick.call(this, modelEditLogic);
						});
						var x3dview = dom.byId("x3dview");
						on(x3dview, "click", function(){
							x3dviewClick.call(this, path);
						});
						
						var modelPath = dom.byId("modelPath");
						modelPath.innerHTML = path;
						on(modelPath, "click", function(){
							modelPathClick.call(this);
						});
						
						//收藏模型
						var addFavorM = dom.byId("addFavorM");
						on(addFavorM, "click", function(){
							addFavoriteModel.call(this, path);
						});
						
						// 取消收藏
						var delFavorM = dom.byId("delFavorM");
						on(delFavorM, "click", function(){
							delFavoritedModel.call(this, path);
						});
						
					});
					
					
					function hasNoGrant(){
						
						
						
						var favpre = dom.byId("favpre");
						favpre.style["top"] = "430px";
						favpre.style["left"] = "300px";
						var modelresourcename = dom.byId("modelresourcename");
						modelresourcename.disabled = "disabled";
						modelresourcename.style["cursor"] = "default";
						modelresourcename.style["color"] = "#aaaaaa";
						var marea = dom.byId("marea");
						marea.disabled = "disabled";
						marea.style["cursor"] = "default";
						marea.style["color"] = "#aaaaaa";
						var keyInfo = dom.byId("keyInfo");
						keyInfo.disabled = "disabled";
						keyInfo.style["cursor"] = "default";
						keyInfo.style["color"] = "#aaaaaa";
						var introduction = dom.byId("introduction");
						introduction.disabled = "disabled";
						introduction.style["cursor"] = "default";
                        dom.byId("mroom").style["color"] = "#aaaaaa"; 
                        dom.byId("mroom").style["cursor"] = "default"; 
					}
                    
                     function mroomClick(modelEditLogic, saveJson){ 
                            console.log(0); 
                            modelEditLogic.showDialogCategory({ 
                                    title1: "选择居室", 
                                    title: "请选择居室类型", 
                                    path : "/content/roomlibcategory/room", 
                                    propertyName : "room", 
                                    selectedName : saveJson["room"], 
                                    selectedPath : saveJson["roomPath"], 
                                    success : function(json){ 
                                            console.log(json); 
                                            // json 
                                            dom.byId("mroom").innerHTML = json["label"]; 
                                            saveJson["room"] = json["label"]; 
                                            saveJson["roomPath"] = json["path"]; 
                                    } 
                            }) 
                    } 
					
					function saveBtnClick(modelEditLogic, saveJson){
						saveJson["resourceName"] = dom.byId("modelresourcename").value;
						saveJson["keyInfo"] = dom.byId("keyInfo").value;
						saveJson["introduction"] = dom.byId("introduction").value;
						saveJson["area"] = dom.byId("marea").value;
						console.log(saveJson);
						modelEditLogic.save(
							saveJson, 
							function(data){
                                Spolo.notify({
									"text" : "保存成功！",
									"type" : "success",
									"timeout" : 1000
								});
								if(saveJson["resourceName"]){
									Spolo.dialogEmit("resetResoureName",saveJson["resourceName"]);
								}else{
									throw("saveJson['resourceName'] is not exit ");
								}
								Spolo.dialogEmit("modelPreview");//发出模型预览图的事件
								Spolo.dialogHide();
							}, 
							function(error){
								console.log(error);
							}
						);
					}
					
					function saveViewBtnClick(){
						document.getElementById("iframeX3d").contentWindow.setCameraJson(
							function(json){
								Spolo.notify({
									"text" : "保存视角成功！",
									"type" : "success",
									"timeout" : 1000
								});
							},
							function(error){
								Spolo.notify({
									"text" : "保存视角失败！",
									"type" : "error",
									"timeout" : 1000
								});
							}
						);
					}
					
					function uploadImgClick(modelEditLogic){
							var inputNode = query("#previewInput")[0];
							var previewForm = query("#previewForm")[0];
							if(inputNode!=undefined){
								inputNode.click();
							}
							var flag = true;
							on(inputNode,"change",function(){
								if(flag)
								{
									flag = false;
									var file = inputNode.value;
									var picMode = ["BMP","PCX","PNG","JPEG","GIF","TIFF","JPG","PCD","TGA","PSD","UFO",
													"bmp","pcx","png","jpeg","gif","tiff","jpg","pcd","tga","psd","ufo"];
									var fileArray = file.split(".");
									var lastName = fileArray[fileArray.length-1];
									var rs = 0;
									for(var i = 0; i < picMode.length; i ++)
									{
										if(lastName == picMode[i])
										{
											rs = 1;
											break;
										}
										continue;
									}
									if(rs > 0)
									{
										var formId = "previewForm";
										var options = {
											resumable : true,
											load : lang.hitch(this,function(data){
												if(data.suc)
												{
													modelEditLogic.getPreview(
														lang.hitch(this,
															function(data){
																if(dom.byId("x3dview").style["display"] == "block")
																{
																	var previewNode = dom.byId("previewNode");
																	var previewAnd3D = dom.byId("previewAnd3D");
																	var previewNodeDIV = dom.byId("previewNodeDIV");
																	previewNode.src = data;
																	previewNodeDIV.style["display"] = "block";
																	previewAnd3D.style["display"] = "none";
																}
																Spolo.notify({
																	text : "效果图修改成功",
																	type : "success",
																	timeout : 1000
																});
															}
														),
														function(error){
															console.log(error);
														}
													);
												}
											}),
											error : function(err){
												throw err;
											}
										};
										modelEditLogic.uploadImg(formId,options);
									}
									else
									{
										Spolo.notify({
											text : "请选择常用的图片格式:" + picMode,
											type : "error",
											timeout : 1000
										});
									}
								}
							});
						}
					
					function renderingClick(modelEditLogic){
						var iframeX3d = dom.byId("iframeX3d");
						var previewNode = dom.byId("previewNode");
						var previewAnd3D = dom.byId("previewAnd3D");
						var previewNodeDIV = dom.byId("previewNodeDIV");
						var saveViewBtn = dom.byId("saveViewBtn");
						saveViewBtn.style["display"] = "none";
						previewNodeDIV.style["display"] = "block";
						previewAnd3D.style["display"] = "none";
						this.style["display"] = "none";
						dom.byId("x3dview").style["display"] = "block";
						modelEditLogic.getPreview(
							lang.hitch(this,
								function(data){
									previewNode.src = data;
								}
							),
							lang.hitch(this,
								function(){
									previewNode.src = "/modules/modeledit/image/nopreview.jpg";
								}
							)
						);
					}
					
					function x3dviewClick(path){
						var iframeX3d = dom.byId("iframeX3d");
						var previewNode = dom.byId("previewNode");
						var previewAnd3D = dom.byId("previewAnd3D");
						var previewNodeDIV = dom.byId("previewNodeDIV");
						var saveViewBtn = dom.byId("saveViewBtn");
						saveViewBtn.style["display"] = "block";
						iframeX3d.src = "/widgets/viewx3d/viewX3D.html?path=" + path;
						previewAnd3D.style["display"] = "block";
						previewNodeDIV.style["display"] = "none";
						this.style["display"] = "none";
						dom.byId("rendering").style["display"] = "block";
					}
					
					function modelPathClick(){
						if ($.browser.msie) {
							var range = document.body.createTextRange();
							range.moveToElementText(modelPath);
							range.select();
						} else if ($.browser.mozilla || $.browser.opera) {
							var selection = window.getSelection();
							var range = document.createRange();
							range.selectNodeContents(modelPath);
							selection.removeAllRanges();
							selection.addRange(range);
						} else if ($.browser.safari) {
							var selection = window.getSelection();
							selection.setBaseAndExtent(modelPath, 0, modelPath, 1);
						}
					}
					
					function addFavoriteModel(path){
						//Spolo.getRoot().spshowmask();
						var dthis = this;
						favourite.addFavModel(
							path,
							function(){
								var delFavorM = dom.byId("delFavorM");
								var addFavorM = dom.byId("addFavorM");
								delFavorM["style"]["display"] = "block";
								addFavorM["style"]["display"] = "none";
								Spolo.notify({
									"text" : "模型加入收藏夹成功",
									"type" : "success",
									"timeout" : 1000
								});
							},
							function(error){
								throw error;
							}
						);
						
					}
					
					function delFavoritedModel(path){
						//Spolo.getRoot().spshowmask();
						var dthis = this;
						favourite.delFavModel(
							path,
							function(){
								var delFavorM = dom.byId("delFavorM");
								var addFavorM = dom.byId("addFavorM");
								delFavorM["style"]["display"] = "none";
								addFavorM["style"]["display"] = "block";
								Spolo.notify({
									"text" : "模型取消收藏成功",
									"type" : "success",
									"timeout" : 1000
								});
							},
							function(error){
								throw error;
							}
						);
						
					}
					
					function getParameter(param){
						var value = "";
						var paramSearch = param+"=";
						var paramStr = location.search;
						var decode_paramStr = decodeURIComponent(paramStr).substring(1);
						var paramsArr = new Array();
						if(decode_paramStr.search(/&/)!=-1){
							paramsArr = decode_paramStr.split("&");
						}
						if(paramsArr[0]){
							arrayUtil.forEach(paramsArr,function(item,i){
								if(item.indexOf(param+"=")!=-1){
									value = item.substr(item.indexOf(param+"=")+paramSearch.length);
								}
							});
						}else{
							value = decode_paramStr.substr(decode_paramStr.indexOf(param+"=")+paramSearch.length);
						}
						return value;
					}
				}
			);
		</script>
	</body>
</html>

