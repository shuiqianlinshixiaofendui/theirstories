<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<title>添加效果图</title>
		
		<script type="text/javascript">
			var dojoConfig = {
				parseOnLoad: true, 
				packages:[
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name:"spolo",
						location:"/script/spolo"
					}
					
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<link rel="stylesheet" href="css/addpreview.css" media="screen">
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen">
	</head>
	<body class="claro">
		<div id="addpreviewBorderContainer" dojoType="dijit.layout.BorderContainer" >
			<div id="addpreviewFirst" dojoType="dijit.layout.ContentPane" region="top" class="addpreviewContent">
				首先，选择将要上传的文件(常用图片格式)：
				<br /><br />
				<form id="addpreview_form" method="POST" enctype="multipart/form-data">
					<input name="选择文件" id="addpreviewFile" type="file"><br /><br /><br />
				</form>
			</div>
			<div id="addpreview" dojoType="dijit.layout.ContentPane" region="center" class="addpreviewContent">
				最后，点击此按钮进行上传：
				<input type="button" id="btnaddpreviewSure" value="确定">
			</div>
		</div>
		<script>
			require(
				[
					"dojo/on",
					"dojo/query",
					"dojo/parser",
					"dojo/ready",
					"dijit/Dialog",
					"dijit/form/Button",
					"dojo/_base/array",
					"dijit/layout/TabContainer",
					"dijit/layout/BorderContainer",
					"dijit/layout/ContentPane",
					"dojo/dom-construct",
					"spolo/data/folder/previewlib",
					"dojo/dom",
					"spolo/data/folder/previewset",
					"widgets/Mask/Mask"
				],
				function
				(
					on, query, parser, ready, Dialog,
					Button, arrayUtil, TabContainer, BorderContainer, ContentPane,
					domConstruct,previewlib,dom,previewset,Mask
				)
				{
					ready(function(){
						var data = Spolo.getDialogData();
						var scenepath = data["scenepath"];
						var prevset = new previewset(scenepath);
						//定义几种常见的图片格式
						var picMode = "BMP,PCX,PNG,JPEG,GIF,TIFF,JPG,PCD,TGA,PSD,UFO";
						on(dom.byId("btnaddpreviewSure"),"click",function(){
							var value = dom.byId("addpreviewFile").value;
							if(value != ""){
								var index = fileMode.call(this,value);
								if(index > 0){
									//这儿需要调用方法实现添加效果图功能
									Mask.show();
									prevset.createPreview("addpreview_form",{
										load:function(data){
											Spolo.dialogEmit("addpreviewsucc");
											Spolo.notify({
												text : "添加成功",
												type : "success",
												timeout : 1000
											});
											Spolo.dialogHide();
											Mask.hide();
										},
										error:function(error){
											console.log("[ERROR]:"+error);
										}
									});
								}
								else{
									alert("请选择常用的图片格式进行上传");
								}
								
							}
							else
							{
								alert("请先选择文件！");
							}
						});
						//判断上传的文件的格式
						function fileMode(filevalue){
							var re = /(\\+)/g; 
							var filename = filevalue.replace(re,"#");
							var one = filename.split("#");
							var two = one[one.length - 1];
							var three = two.split(".");
							var last = three[three.length - 1];
							var rep = new RegExp(last,"i");
							var value = rep.exec(picMode);
							var rs = picMode.indexOf(value);
							return rs;
						}
					});
				});
		</script>
	</body>
</html>