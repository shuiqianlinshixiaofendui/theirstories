<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<title>分类管理</title>
	
		<script type="text/javascript">
			var dojoConfig = {
				parseOnLoad: true, 
				packages:[
					{
						name: "widgets",
						location: "/widgets"
					},
					{
						name:"spolo",
						location:"/script/spolo"
					}
					
				]
			};
		</script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/sling/explorer/js/jquery-1.4.2.min.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<link rel="stylesheet" href="/widgets/CategoryManager/css/main.css" media="screen">
	</head>
	
	<body class="claro">
		<div id="resourcePath" style="position:absolute;left:05%;height:auto;width:auto;"></div>
		<div id="resDetails" style="position:absolute;left:30%;height:auto;width:auto;"></div>
		<script>
			require(
				[
					"dojo/on",
					"dijit/registry",
					"dojo/_base/array",
					"dojo/dom-construct",
					"spolo/data/folder",
					"widgets/CategoryManager/CategoryManager",
					"dijit/form/Select",
					"dojo/dom",
					"spolo/data/grant"
				],
				function(
					on, registry, arrayUtil, domConstruct, folder_cls, CategoryManager, Select, dom, grant_class
				){
					var userName = Spolo.getUserId();
					var user = Spolo.decodeUname(userName);
					var path = [];
					var grant_class = new grant_class();
					grant_class.getUserPermissions({
						"user" : user,
						"success" : function(data){
							for(var i in data){
								var array = i.split("/");
								if(array[2] != "users"){
									if(array[2] == "previewlib"){
										path.push("/content/previewcategory");
									}else{
										path.push(i+"category");
									}
								}
							}
							if(user == "admin"){
								path = [
									"/content/previewcategory",
									"/content/modellibcategory",
									"/content/materiallibcategory",
									"/content/roomlibcategory"
								]
							}
							var menuData = {
								"createFolder" : {
									"value" : "创建子文件夹",
									"textbox" : true
								},
								"renameFolder" : {
									"value" : "重命名该文件夹",
									"textbox" : true
								},
								"removeFolder" : {
									"value" : "删除该文件夹",
									"textbox" : false
								}
							};
							var arrayEvents = new Array();
							for(var event in menuData)
							{
								arrayEvents.push(event);
							}
							
							var category = new Select({
								name : "groupName",
								id : "groupName",
								style : "position:absolute;left:10%;height:5%;width:20%;",
								options : [{"label":"请选择分组名称", "value":"请选择分组名称"}],
								onChange : function(value){
									
									var form = document.getElementById("resDetails");
									for(var index = 0; index < form.children.length; index ++)
									{
										domConstruct.destroy(form.children[index]);
										index --;
									}
									
									var model = getModel(value);
									var json = {
										path : value,
										model : model,
										menu : menuData
									};
									var categoryManager = new CategoryManager(json);
									categoryManager.placeAt("resDetails");
									
									arrayUtil.forEach(arrayEvents, function(event)
									{
										on(categoryManager, event, function(data){
											doEvent(data, categoryManager, event);
										});
									});
								}
							});
							
							if(path.length == 0){
								var resourcePath = dom.byId("resourcePath");
								var style = "font-weight:bold;padding:3px;font-size:150%;" +
											"display:inline;";
								var label = domConstruct.create("label",
									{
										innerHTML :  "对不起，您不是管理员用户，无权操作云端分类管理!",
										style : style
									}, resourcePath
								);
							}else{
								category.placeAt("resourcePath");
							}
							
							arrayUtil.forEach(path, function(pathItem)
							{
								var folder = new folder_cls(pathItem);
								folder.getRoot(
									function(){
										var name = folder.getName();
										category.addOption({
											disabled:false,
											label : name,
											value : pathItem
										});
									},
									function(error){
										throw error;
									}
								);
							});
							
						},
						"failed" : function(error){
							throw error;
						}
					});
					
					
					
					function doEvent(data, dthis, event)
					{
						var pNode = registry.byNode(data[0].getParent().currentTarget);
						var parentFolder = pNode.item;
						var data2 = undefined;
						if(data[2])
							data2 = data[2];
						switch (event)
						{
							case "createFolder":
								var json = {
									"resourceName" : data[1],
									"jcr:primaryType" : "sling:Folder",
									"isradio" : data2
								}
								parentFolder.create(
									json,
									function(childFolder){
										dthis.model.newItem(childFolder, pNode);
									},
									function(){
									}
								);
								break;
							case "renameFolder":
								parentFolder.setRadio(data2);
								parentFolder.rename(
									data[1],
									function(){
										pNode.labelNode.innerText = data[1];
									},
									function(){
									}
								);
								break;
							case "removeFolder":
								parentFolder.remove(
									function(){
										domConstruct.destroy(pNode.domNode);
									},
									function(){}
								);
							default:
								break;
						}
					}
					
					function getModel(path)
					{
						var model = {
							getIdentity : function(folder){
								return folder.getURI();
							},
							mayHaveChildren : function(folder){
								return folder.mayHaveChildren();
							},
							getChildren : function(folder, onComplete, onError){
								folder.getChildren(onComplete, onError);
							},
							getRoot : function(onItem, onError){
								var folder = new folder_cls(path);
								this.rootItem = folder;
								folder.getRoot(onItem, onError);
							},
							getLabel : function(folder){
								return folder.getName();
							},
							isItem : function(something){
								return true;
							}
						}
						return model;
					}
				});
		</script>
	</body>
</html>
