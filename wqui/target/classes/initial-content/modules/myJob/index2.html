<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<title>MyJob</title>
		
		<script type="text/javascript">
			var dojoConfig = {
				parseOnLoad: true, 
				packages:[
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}		
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="/script/spolo/ui/noty/jquery.noty.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/jsjac-1.3.4/jsjac.js"></script>
		<link rel="stylesheet" href="/widgets/Mask/css/main.css" media="screen" />
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<link rel="stylesheet" href="/libs/dijit/themes/tundra/tundra.css" media="screen">
		<link rel="stylesheet" href="/libs/dojox/grid/resources/claroGrid.css" media="screen">
		
		<link rel="stylesheet" href="css/myjob2.css" media="screen">	
		<style type="text/css">
			html,body{
				height:100%;
			}
		</style>
	</head>
	
	<body class="claro">	
		<div id="userInfo" class="header"></div>
		<div id="center" class="panel">
			<hr/>
			<div id = 'menu' class="menu">
				<button id="refresh">刷新任务列表</button>
			</div>
			<div id="joblist_panel" class="joblist">
				<div id="joblist">
				</div>
			</div>
			<div class="info_panel">
				<div id="jobsInfo" class="jobsInfo">
					<div class="info" id="creatingingCount"></div>
					<div class="info" id="createdCount"></div>
				</div>
				<div id="jobInfo" class="jobInfo" style = "display : none; ">
					<div class="info" id="jobID"></div>
					<div class="info" id="resolution"></div>
					<div class="info" id="samples"></div>
					<div class="info" id="allCount"></div>
					<div class="info" id="renderingCount"></div>
					<div class="info" id="waitingCount"></div>
					<div class="info" id="finishedCount"></div>
					<div class="info" id="finishedFailedCount"></div>
				</div>
			</div>
				
		</div>	
		
	</body>	
	<script language='javascript'>
		
		 require([
			"dojo/on",
			'dojo/_base/lang', 
			'dojox/grid/DataGrid', 
			'dijit/layout/ContentPane',
			'dojo/data/ItemFileWriteStore', 
			'dojo/dom',
			"dijit/form/Button",
			"widgets/Mask/Mask"
		],function(
					on,
					lang,
					DataGrid, 
					ContentPane,
					ItemFileWriteStore, 
					dom,
					Button,
					mask
					)
		{
			//全局变量
			var grid,JobManager,storeData;
			var showDeleteEnsureDialog = true;
			//删除job
			function deletejob(id){
				mask.show();
				args = {
					jobName: id,
					success : function(){
						mask.appendLogItem("删除完成");
						mask.message("删除成功",true);
						for(var index=0;index<grid.rowCount;index++){
							if(grid.getItem(index).id == id){
								storeData.deleteItem(grid.getItem(index));
								break;
							}
						}
						mask.hide();
					},
					failed : function(e){
						mask.appendLogItem(e);
						mask.message("删除失败",false);
					},
					saving : function(){
						mask.appendLogItem("删除中...");
					}
				} 
				JobManager.deleteJob(args);
			}
			//显示值任务试图
			function showTasks(id){
				dojo.require("dijit.Dialog");
				// create the dialog:
				var taskPanel = new ContentPane({style:"width:auto;height:auto;"});
				var taskGrid = getTaskGrid();
				taskPanel.addChild(taskGrid);
				myDialog = new dijit.Dialog({
					title: "任务"+id+"详细信息",
					content: taskPanel
				});	
				// myDialog.own(on(dom.byId("s"),"click",function(){
					
				// }));
				myDialog.show();
				updateTaskGrid(taskGrid,JobManager,id);					
			}
			//获取用户名称
			var userEmail = Spolo.decodeUname( Spolo.getUserId() );
			if(!userEmail || userEmail=="nonymous"){
				alert("该功能需要登录后才能使用");
				window.location.href="/modules/user/index.html?redirect=/modules/myJob/upload2.html";
			}
			//设置显示用户名称
			dom.byId("userInfo").innerHTML = "当前登录用户:"+userEmail;
			/**初始化一个表格
			*/
			function initGrid(){
				/*set up layout*/
				function getButtons(item){
					var id = item;
					//设置button显示子任务和删除job
					var deleteButton = new Button({
						label: "删除",
						onClick: function(){
							if(showDeleteEnsureDialog){
								dojo.require("dijit.Dialog");
								// create the dialog:
								myDialog = new dijit.Dialog({
									title: "删除确认",
									content: "<div style='padding: 10px;'><div style='padding: 10px; font-size: 15px;font-weight:bold;'>确定删除渲染任务？</div><button id='yes' style='float:left;margin-bottom: 10px;'>是</button><button id='no' style='float:right;margin-bottom: 10px;'>否</button><div style='clear:both;'><input type='checkbox' id='hiddenThisDialog'><font size='2px'>不在显示此对话框</font></input></div></div>",
								});	
								myDialog.own(on(dom.byId("yes"),"click",function(){
									myDialog.destroy();
									deletejob(id);
								}));
								myDialog.own(on(dom.byId("no"),"click",function(){
									myDialog.destroy();
								}));
								myDialog.own(on(dom.byId("hiddenThisDialog"),"click",function(){
									if(dom.byId("hiddenThisDialog").checked){
										showDeleteEnsureDialog = false;
									}else{
										showDeleteEnsureDialog = true;
									}
								}));
								myDialog.show();	
							}else{
								deletejob(id);
							}
						}
					});
					var showTaskButton = new Button({
						label: "详细",
						onClick: function(){
							showTasks(id);
						}
					});
					var buttonGroup = new ContentPane({style:"width:auto;height:auto;"});
					buttonGroup.addChild(showTaskButton);
					buttonGroup.addChild(deleteButton);
					return buttonGroup;
				}
				function getCreateTime(longNumberTime_strig){
					var createTime = new Date(new Number(longNumberTime_strig));
					createTime = createTime.getFullYear()+"年"+(createTime.getMonth()+1)+"月"+createTime.getDate()+"日 "+createTime.getHours()+":"+createTime.getMinutes()+":"+createTime.getSeconds();
					return createTime;
				}
				function getJobStatus(status){
					switch(status){
						case "creating":{
							status = "创建中...";
							break;
						}
						case "created":{
							status = "创建完成";
							break;
						}
						case "finish":{
							status = "全部渲染完成";
							break;
						}
					}
					return status;
				}
				var layout = [[
					{'name': '任务ID', 'field': 'id', 'width': '50px'},
					{'name': '任务名称', 'field': 'userJobName', 'width': 'auto'},
					{'name': '客户名称', 'field': 'customerName', 'width': 'auto'},
					{'name': '任务状态', 'field': 'status', 'width': '100px','formatter': getJobStatus},
					{'name': '创建时间', 'field': 'createTime', 'width': '100px','formatter': getCreateTime},
					{'name': '操作', 'field': 'button', 'width': 'auto', 'formatter': getButtons}
				]];
				
				/*create a new grid*/
				var grid = new DataGrid({
											id: 'grid',
											structure:layout,
											rowSelector: '20px',
											style:"height:500px;",
											fastScroll:true
										});

				/*append the new grid to the div*/
				grid.placeAt("joblist");

				/*Call startup() to render the grid*/
				grid.startup();
				return grid;
			}
			/**获取用户对应的jobManager
			*/
			function initJobManager(){
				dojo.require("spolo.data.user");
				var path = "/content/users/"+Spolo.getUserId();
				var user = spolo.data.user.getInstance(path);	
				user.getJobManager('render',
					function(jobManager){
						onJobManagerCreated(jobManager);
					},
				true);
			}
			/**更新表格数据
			*/
			function updateGrid(grid,jobManager){
				mask.show();
				jobManager.getJobs(function(jobs){
					var data = {
								identifier: "id",
								items: []
							};
					var creatingingCount=0,createdCount=0;
					for(var id in jobs){
						var job = jobs[id];
						var status = job.getValue("status");
						var item = {
										id:id,
										userJobName:job.getValue("userJobName")?job.getValue("userJobName"):"",
										customerName:job.getValue("customerName")?job.getValue("customerName"):"",
										status:status,
										createTime:job.getValue("createTime"),
										button:id
									};
						data.items.push(item);
						if(status=="creating"){
							creatingingCount++;
						}else if(status=="created"){
							createdCount++;
						}	
					}	
					storeData = new ItemFileWriteStore({data: data});
					grid.setStore(storeData);
					//第四列按降序排列
					grid.setSortIndex(4,false);
					mask.hide();
					dom.byId("creatingingCount").innerHTML	=	"创建中的任务："+creatingingCount;
					dom.byId("createdCount").innerHTML	 =		"创建完成的任务："+createdCount;
				},true);
			}
			
			/**jobmanager准备好时调用
			*/
			function onJobManagerCreated(jobManager){
				JobManager = jobManager;
				grid = initGrid();
				updateGrid(grid,jobManager);
				//添加刷新按钮监听
				on(dom.byId("refresh"),"click",function(){
					updateGrid(grid,jobManager);
				});
				on(grid,"mouseOverRow",function(event)
					{
						var item = grid.getItem(event.rowIndex);
						jobManager.getJob(item.id,
							function(job){
								var renderingCount=0,waitingCount=0,finishedCount=0,finishedFailedCount=0,allCount=0;
								var tasks = job.getTasks();
								for(var index=0;index<tasks.length;index++){
									allCount++;
									var task = tasks[index];
									switch(task[task.name+"_status"]){
										case "waiting":{
											waitingCount++;
											break;
										}
										case "doing":{
											renderingCount++;
											break;
										}
										case "true":{
											finishedCount++;
											break;
										}
										case "false":{
											finishedFailedCount++;
											break;
										}
									}
								}
								dom.byId("jobInfo").style.display='block';
								dom.byId("jobID").innerHTML = "任务ID："+item.id;
								dom.byId("resolution").innerHTML = "分辨率："+job.getValue("resolution");
								dom.byId("samples").innerHTML = "采样率："+job.getValue("samples");
								dom.byId("renderingCount").innerHTML = "渲染中的子任务："+renderingCount;
								dom.byId("waitingCount").innerHTML = "等待渲染的子任务："+waitingCount;
								dom.byId("finishedCount").innerHTML = "渲染完成的子任务："+finishedCount;
								dom.byId("finishedFailedCount").innerHTML = "渲染失败的子任务："+finishedFailedCount;
								dom.byId("allCount").innerHTML = "子任务总数："+allCount;
							},
						false);
					}
				);
				// on(grid,"rowClick",function(event){
					
				// });
			}
			//init
			initJobManager();
			
			var taskGrid;
			function getTaskGrid(){
				function getTaskStatus(status){
					switch(status){
						case "waiting":{
							status = "正在排队...";
							break;
						}
						case "doing":{
							status = "渲染中...";
							break;
						}
						case "true":{
							status = "渲染完成";
							break;
						}
						case "false":{
							status = "渲染失败";
							break;
						}
					}
					return status;
				}
				function getButton(item){
					var id = item;
					//设置button删除子任务
					var deleteButton = new Button({
						label: "删除任务",
						onClick: function(){
							if(showDeleteEnsureDialog){
								dojo.require("dijit.Dialog");
								// create the dialog:
								myDialog = new dijit.Dialog({
									title: "删除确认",
									content: "<div style='padding: 10px;'><div style='padding: 10px; font-size: 15px;font-weight:bold;'>确定删除渲染子任务？</div><button id='yes' style='float:left;margin-bottom: 10px;'>是</button><button id='no' style='float:right;margin-bottom: 10px;'>否</button><div style='clear:both;'><input type='checkbox' id='hiddenThisDialog'><font size='2px'>不在显示此对话框</font></input></div></div>",
								});	
								myDialog.own(on(dom.byId("yes"),"click",function(){
									myDialog.destroy();
									alert("todo")
								}));
								myDialog.own(on(dom.byId("no"),"click",function(){
									myDialog.destroy();
								}));
								myDialog.own(on(dom.byId("hiddenThisDialog"),"click",function(){
									if(dom.byId("hiddenThisDialog").checked){
										showDeleteEnsureDialog = false;
									}else{
										showDeleteEnsureDialog = true;
									}
								}));
								myDialog.show();	
							}else{
								alert("todo");
							}
						}
					});
					return deleteButton;
				}
				if(!taskGrid){
					var layout = [[
						{'name': 'ID', 'field': 'id', 'width': '50px'},
						{'name': '摄像机名称', 'field': 'cameraName', 'width': 'auto'},
						{'name': '耗时', 'field': 'wasteTime', 'width': 'auto'},
						{'name': '状态', 'field': 'status', 'width': '100px','formatter': getTaskStatus},
						{'name': '操作', 'field': 'button', 'width': 'auto','formatter': getButton}
					]];
					
					/*create a new grid*/
					taskGrid = new DataGrid({
												structure:layout,
												rowSelector: '20px',
												style:"width:500px;height:500px;",
												fastScroll:true
											});
					/*Call startup() to render the grid*/
					taskGrid.startup();	
				}
				return taskGrid;
			}
			/**更新子任务表格数据
			*/
			function updateTaskGrid(taskgrid,jobManager,jobID){
				mask.show();
				jobManager.getJob(jobID,function(job){
					var data = {
								identifier: "id",
								items: []
							};
					var tasks =	job.getTasks();
					for(var index=0;index<tasks.length;index++){
						var task = tasks[index];
						var item = {
										id:task["name"],
										cameraName:task.currentcamera,
										wasteTime:"",
										status:task[task["name"]+"_status"],
										button:task["name"]
									};
						data.items.push(item);
					}	
					storeData = new ItemFileWriteStore({data: data});
					taskgrid.setStore(storeData);
					//第四列按降序排列
					taskgrid.setSortIndex(3,false);
					mask.hide();
				},false);
			}
		});
	</script>

</html>
