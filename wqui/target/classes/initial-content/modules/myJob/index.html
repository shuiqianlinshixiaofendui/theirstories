<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<title>MyJob</title>
		
		<script type="text/javascript">
			var dojoConfig = {
				parseOnLoad: true, 
				packages:[
					{
						name: "spolo",
						location: "/script/spolo"
					},
					{
						name: "widgets",
						location: "/widgets"
					}		
				]
			};
		</script>
		<script type="text/javascript" src="/libs/dojo/dojo.js"></script>
		<script type="text/javascript" src="/libs/dijit/dijit.js"></script>
		<script type="text/javascript" src="/system/sling.js"></script>
		<script type="text/javascript" src="/script/spolo.js"></script>
		<script type="text/javascript" src="/libs/jsjac-1.3.4/jsjac.js"></script>
		<link rel="stylesheet" href="/libs/dijit/themes/claro/claro.css" media="screen">
		<link rel="stylesheet" href="/widgets/gmeditor_list/css/main.css" media="screen">
		<link rel="stylesheet" href="/widgets/gmeditor_listItem/css/main.css" media="screen">
		<link rel="stylesheet" href="/libs/dijit/themes/tundra/tundra.css" media="screen">
		<link rel="stylesheet" href="/libs/dojox/image/resources/Lightbox.css" media="screen">
		<link rel="stylesheet" href="css/myJob.css" media="screen">	
		<style type="text/css">
			html,body{
				height:100%;
			}
		</style>
	</head>
	
	<body class="claro">	
		<button id="SelectAll">全选</button>
		<button id="SelectNone">取消</button>
		<button id="removeItem">删除</button>
		<!-- <button id="orderItem">暂停</button> -->
		<div id="list"></div>		
		
	</body>	
	<script language='javascript'>
	var childTaskDialog;
	var subTaskList;
	require(["widgets/gmeditor_list/gmeditor_list", 
					 "widgets/gmeditor_listItem/gmeditor_listItem",
					 "dojo/dom",
					 "dojo/on",
					 "spolo/data/user",
					 "dojo/ready"
					 ],
		function(JobList,JobListItem,dom,on,User,ready){
			
			function initViewChildTaskDialog(){
				require(["dijit/Dialog"],function(Dialog){
					if(!childTaskDialog){
						childTaskDialog = new Dialog({
							content:""
						});
						subTaskList = new JobList();
						childTaskDialog.setContent(subTaskList);
						childTaskDialog.setActiveJob = function(job){
							childTaskDialog.activeJob = job;
						}
						childTaskDialog.getActiveJob = function(){
							return childTaskDialog.activeJob;
						}
					}
				});
			}	
			initViewChildTaskDialog();
			//ready之后更新页面
			var JobManager = null;
			ready(function(){
				dojo.require("spolo.data.user");
				var path = "/content/users/"+Spolo.getUserId();
				var user = spolo.data.user.getInstance(path);	
				jobList = new JobList();	
				user.getJobManager('render',
					function(jobManager){
						JobManager = jobManager;	
						initJobList();
						setInterval(function(){
							refresh();
							JobManager.queryJobProcess(
								function(job){
									var msgData = formatMsg(job);
									JobList.updateJobMsg(job,msgData);
								});
							},10000);
					},
				true);
			});
			function formatMsg(job){
				
				var tesjson = {};
				var tesjson2 = {};
				if(job.getResultImageURL()){
					tesjson["下载图片"]  = job.getResultImageURL()+"&download=true";
				}
				tesjson["任务名称"]  = job.getValue("userJobName")?job.getValue("userJobName"):"";
				tesjson["客户名称"]  = job.getValue("customerName")?job.getValue("customerName"):"";
				var status = "创建完成";
				switch(job.getValue("status")){
					case "creating":{
						status = "创建中...";
						break;
					}
					case "created":{
						status = "创建完成";
						break;
					}
					case "finish":{
						status = "全部渲染完成";
						break;
					}
				}
				tesjson["任务状态"] = status;
				var createTime = new Date(new Number(job.getValue("createTime")));
				tesjson["创建时间"]  = createTime.getFullYear()+"年"+(createTime.getMonth()+1)+"月"+createTime.getDate()+"日 "+createTime.getHours()+":"+createTime.getMinutes()+":"+createTime.getSeconds();
				tesjson["创建人"]  = Spolo.decodeUname(job.getValue("userID"));
				
				//========================================================
				if(!job.getResultImageURL()){
					var task = job.getTasks();
					if(task.length>0){
						tesjson2 ["resultImgURL"] = task[0].url;	
					}
				}else{
					tesjson2 ["resultImgURL"] = job.getResultImageURL();	
				}
				var task = job.getTasks();
				var msgData = {
					msg1:tesjson,
					msg2:tesjson2,
					subTask:task
				}
				return msgData;
			}
			function initJobList(){
				jobList.placeAt("list");
				on(jobList,"viewChildTask",function(job){
					if(childTaskDialog && typeof childTaskDialog.setActiveJob == "function"){
						childTaskDialog.setActiveJob(job);
					}
					var tasks = job.getTasks();
					if(tasks.length == 0){
						alert("此任务正在排队中！请耐心等待");
					}else{
						console.log({"childTaskInfo":tasks});
						updateSubTask(job);
						childTaskDialog.show();
						childTaskDialog.resize();					
					}
				});
				JobManager.getJobs(function(jobs){
					for(var name in jobs){
						if(typeof jobs[name] == "object"){
							var job = jobs[name];
							var json = {};
							json['name'] = job.getName();
							//更新到页面上
							var item = new JobListItem(json);		
							jobList.addJobListItem(item);	
							var msgData = formatMsg(job);
							jobList.updateJobMsg(job,msgData);
						}
					}							
				},true);
			}
			function refresh(){
				/*var node = dom.byId('list');
				while (node.hasChildNodes()) {
					node.removeChild(node.lastChild);
				}*/
				//
				JobManager.getJobs(function(jobs){
					for(var name in jobs){
						var json = {};
						json['name'] = name;
						//更新到页面上
						var job = jobs[name];		
						var msgData = formatMsg(jobs[name]);						
						jobList.updateJobMsg(job,msgData);
						if(childTaskDialog && typeof childTaskDialog.getActiveJob == "function"){
							updateSubTask(childTaskDialog.getActiveJob());
						}
					}							
				},true);
			}
			on(dom.byId("SelectAll"),"click",function(){
				selectedAll();
			});
			on(dom.byId("SelectNone"),"click",function(){
				SelectNone();				
			});
			on(dom.byId("removeItem"),"click",function(){
				removeItem();
			});
			on(dom.byId("orderItem"),"click",function(){
										
			});
			function getSelected(){
				
			};
			function selectedAll(){
				this.jobList.orSelectAllItem(true);
			}
			function SelectNone(){
				this.jobList.orSelectAllItem(false);
			}
			function removeItem(){
				var that = this;
				var selectItem = this.jobList.getSelectedItem();
				if(selectItem.length==0){
					alert("您还没有选择!~");
					return;
				}
				var deleItems=[];
				for(var i=0;i<selectItem.length;i++){
					deleItems.push(selectItem[i].name);
				}
				args = {
					jobName: deleItems,//如果jobName为数组，批量删除
					success : function(name){						
						that.jobList.removeItemByName(name);						
					},
					failed : function(reason,name){
						alert(reason);
					},
					saving : function(){
					}
				} ;
				JobManager.deleteJob(args);
				//this.jobList.removeSelectedItem();
			}
			function updateSubTask(job){
				subTaskList.removeAllItems();
				var task = job.getTasks();
				for(var i=0;i<task.length;i++){
					var tinfo = task[i];
					var json = {};
					json["name"] = tinfo["name"];
					json["viewSubTask"] = false;
					//更新到页面上
					var item = new JobListItem(json);	
					
					subTaskList.addJobListItem(item);
					function formatSubTask(tinfo){
						var msg1Data = {};
						var msg2Data = {};
						if(tinfo.URL){
							msg1Data["下载图片"] = tinfo.URL+"&download=true";
						}
						if(tinfo.currentcamera){
							msg1Data["摄像机名称"] = tinfo.currentcamera;
						}
						if(tinfo[tinfo["name"]+"_status"]){
							var status = "创建完成";
							switch(tinfo[tinfo["name"]+"_status"]){
								case "waiting":{
									status = "正在排队...";
									break;
								}
								case "doing":{
									status = "渲染中...";
									break;
								}
								case "true":{
									status = "渲染完成";
									break;
								}
								case "false":{
									status = "渲染失败";
									break;
								}
							}
							msg1Data["任务状态"] = status;
							if(tinfo.reschedule){
								msg1Data["重新派遣"] = tinfo.reschedule + "次";
							}
						}
						msg2Data["resultImgURL"] = tinfo.url;
						var msgData = {
							msg1:msg1Data,
							msg2:msg2Data
						};
						return msgData;
					}
					var msgData = formatSubTask(tinfo);
					subTaskList.updateTaskMsg(task[i],msgData);
				}
			}
	});			
	</script>

</html>
